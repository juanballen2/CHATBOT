<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valentina v28.1 - Final CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #00a884; --outgoing: #005c4b; --incoming: #202c33; 
            --dark: #111b21; --panel: #202c33; --border: #37404a; 
            --text: #e9edef; --text-muted: #8696a0; --accent: #53bdeb; --danger: #ef4444;
            --hover-item: #2a3942; --active-item: #2a3942;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background-color: var(--dark); color: var(--text); height: 100vh; display: flex; overflow: hidden; }

        /* --- MODALES GENERALES --- */
        .modal-overlay { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background-color: var(--panel); padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); display: flex; flex-direction: column; gap: 15px; }
        .modal-title { font-size: 1.2rem; color: var(--text); font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .modal-form label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--primary); font-weight: 500; }
        .modal-form input, .modal-form textarea, .modal-form select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--dark); color: white; outline: none; font-size: 0.95rem; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* --- ANIMACIONES --- */
        button:active, .chat-item:active { transform: scale(0.98); }
        button, .chat-item { transition: all 0.1s ease-in-out; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #37404a; border-radius: 3px; }

        /* --- LAYOUT PRINCIPAL --- */
        .sidebar { width: 60px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 100; flex-shrink: 0; }
        .nav-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; margin-bottom: 15px; }
        .nav-btn:hover { background: #374248; color: var(--primary); }
        .nav-btn.active { background: #374248; color: var(--primary); box-shadow: 0 0 10px rgba(0, 168, 132, 0.4); }
        .nav-bottom { margin-top: auto; padding-bottom: 20px; }

        .main-area { flex: 1; display: flex; position: relative; overflow: hidden; background: var(--dark); }
        .view-panel { display: none; width: 100%; height: 100%; }
        #tab-chat.active { display: flex; flex-direction: row; }
        #tab-leads.active, #tab-config.active { display: flex; flex-direction: column; overflow-y: auto; }

        /* --- LISTA DE CHATS --- */
        .chat-list { width: 380px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--dark); flex-shrink: 0; position: relative; }
        .chat-header { padding: 10px 15px; border-bottom: 1px solid var(--border); background: var(--panel); }
        .search-container { display: flex; gap: 8px; margin-bottom: 10px; }
        .search-bar { flex: 1; padding: 8px 12px; background: var(--dark); border: 1px solid var(--border); color: var(--text); border-radius: 8px; outline: none; font-size: 0.9rem; }
        .action-btn { width: 36px; height: 36px; border-radius: 8px; border: none; background: var(--panel); color: var(--text-muted); cursor: pointer; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .action-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .new-chat-btn { background: var(--accent); color: #000; border: none; }
        
        .view-filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; align-items: center; }
        .filter-chip { font-size: 0.8rem; padding: 5px 12px; background: var(--panel); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; white-space: nowrap; color: var(--text-muted); transition: 0.2s; }
        .filter-chip.active { background: #2a3942; color: var(--primary); border-color: var(--primary); font-weight: 600; }
        .tag-filter-select { background: var(--dark); color: var(--text-muted); border: 1px solid var(--border); border-radius: 4px; padding: 4px; font-size: 0.8rem; max-width: 120px; }

        .chat-items { flex: 1; overflow-y: auto; }
        .chat-item { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 12px; align-items: center; position: relative; }
        .chat-item:hover { background: var(--hover-item); }
        .chat-item.active { background: var(--active-item); border-left: 4px solid var(--primary); padding-left: 11px; } 
        .chat-item.archived { opacity: 0.6; }
        
        /* Checkbox para Bulk Actions */
        .bulk-checkbox { display: none; width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }
        .chat-list.bulk-mode .bulk-checkbox { display: block; }
        
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-weight: 500; font-size: 1rem; color: #e9edef; display: flex; justify-content: space-between; }
        .chat-preview { display: flex; justify-content: space-between; align-items: center; margin-top: 3px; }
        .chat-last-msg { font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .badge { background: var(--primary); color: #000; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; font-weight: bold; min-width: 18px; text-align: center; }
        .mini-tags { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .mini-tag { font-size: 0.65rem; padding: 1px 6px; border-radius: 4px; color: #000; font-weight: 600; }

        /* Barra de Acciones Masivas */
        #bulk-toolbar { display: none; position: absolute; bottom: 0; left: 0; width: 100%; background: var(--panel); border-top: 2px solid var(--primary); padding: 15px; z-index: 50; flex-direction: column; gap: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        #bulk-toolbar.show { display: flex; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .bulk-actions-row { display: flex; justify-content: space-between; align-items: center; }

        /* --- CHAT AREA --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: #0b141a; position: relative; }
        .chat-top { padding: 10px 16px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .messages { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; gap: 4px; }
        
        .msg { max-width: 65%; padding: 6px 10px; border-radius: 8px; font-size: 0.9rem; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); display: flex; flex-direction: column; }
        .msg.user { background: var(--incoming); align-self: flex-start; border-top-left-radius: 0; color: #fff; }
        .msg.bot, .msg.manual { background: var(--outgoing); align-self: flex-end; border-top-right-radius: 0; color: #fff; }
        
        /* NUEVO: ESTILO PARA LA ALERTA DE ERROR DE IA */
        .msg.alert { background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; color: #ff8a8a; align-self: center; border-radius: 8px; width: 85%; max-width: 85%; text-align: center; font-weight: 500; font-size: 0.85rem; }
        
        .msg-time { font-size: 0.65rem; opacity: 0.6; align-self: flex-end; margin-top: 2px; }
        
        /* Bot√≥n de Reenv√≠o con Delay */
        .msg-forward-btn { 
            position: absolute; 
            top: 5px; 
            right: -30px; 
            background: rgba(0,0,0,0.3); 
            color: #fff; 
            border-radius: 50%; 
            width: 25px; 
            height: 25px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            font-size: 0.8rem; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease 2s, visibility 0.3s ease 2s;
        }

        .msg:hover .msg-forward-btn { 
            opacity: 1;
            visibility: visible;
            transition-delay: 0s;
        }

        .msg.bot:hover .msg-forward-btn { left: -30px; right: auto; }
        .msg-forward-btn:hover { background: var(--primary); }

        /* Audio Player & Input */
        .audio-wrapper { display: flex; align-items: center; gap: 8px; }
        .audio-player { display: flex; align-items: center; gap: 12px; width: 220px; padding: 5px; background: rgba(0,0,0,0.1); border-radius: 8px; }
        .play-btn { width: 34px; height: 34px; background: #53bdeb; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; flex-shrink: 0; }
        .audio-progress { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 4px; }
        .progress-bar-bg { width: 100%; height: 4px; background: rgba(255,255,255,0.2); border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: #53bdeb; transition: width 0.1s linear; }
        .audio-time { font-size: 0.7rem; color: #ccc; font-family: monospace; }
        .btn-download-audio { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-muted); text-decoration: none; background: rgba(0,0,0,0.2); }

        .input-area { padding: 10px 16px; background: var(--panel); display: flex; gap: 10px; align-items: center; }
        .input-box { flex: 1; padding: 12px; border-radius: 8px; border: none; background: #2a3942; color: white; outline: none; resize: none; height: 42px; font-size: 0.95rem; }
        .send-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--primary); color: #fff; cursor: pointer; font-size: 1.1rem; }
        .attach-btn { background: transparent; border: none; color: var(--text-muted); font-size: 1.3rem; cursor: pointer; }

        /* --- CRM & CONFIG --- */
        .crm-panel { width: 320px; border-left: 1px solid var(--border); background: var(--dark); padding: 20px; overflow-y: auto; display: none; flex-shrink: 0; }
        .crm-panel.open { display: block; position: absolute; right: 0; height: 100%; z-index: 30; border-left: 1px solid var(--primary); background: var(--dark); box-shadow: -5px 0 15px rgba(0,0,0,0.5); }
        .crm-section { margin-bottom: 30px; background: var(--panel); padding: 15px; border-radius: 8px; }
        .crm-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 12px; font-weight: 600; }
        .crm-input { width: 100%; padding: 8px 10px; margin-bottom: 10px; background: var(--dark); border: 1px solid var(--border); color: white; border-radius: 4px; font-size: 0.9rem; }
        select.crm-input { appearance: none; cursor: pointer; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%238696a0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px auto; }
        select.crm-input option { background: var(--panel); color: white; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { padding: 4px 10px; border-radius: 99px; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--border); color: var(--text-muted); transition: 0.2s; }
        .tag.selected { border-color: var(--primary); background: rgba(0, 168, 132, 0.2); color: #fff; }
        
        /* Switch */
        .switch-container { display: flex; align-items: center; justify-content: space-between; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #37404a; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        .leads-container, .config-container { padding: 30px; width: 100%; box-sizing: border-box; }
        .table-responsive { width: 100%; overflow-x: auto; margin-top: 20px; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 1000px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
        .data-table th { color: var(--text-muted); font-weight: 500; }
        .data-table tr:hover { background: rgba(255,255,255,0.02); }
        .lead-source-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .lead-source-web { background: rgba(30, 64, 175, 0.3); color: #93c5fd; border: 1px solid #1e40af; }
        .lead-source-store { background: rgba(134, 25, 143, 0.3); color: #f0abfc; border: 1px solid #a21caf; }

        .config-header-main { font-size: 1.2rem; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; color: var(--text-muted); }
        .config-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .config-card { background: var(--panel); padding: 20px; border-radius: 10px; border: 1px solid var(--border); flex: 1; min-width: 300px; margin-bottom: 20px; }
        .config-header { font-size: 1rem; font-weight: 600; margin-bottom: 15px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .code-editor { width: 100%; height: 120px; background: #111b21; color: #25d366; padding: 10px; border-radius: 5px; font-family: monospace; border: 1px solid var(--border); resize: vertical; }
        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: var(--dark); border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .config-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .cfg-input { flex: 1; padding: 8px; border-radius: 5px; border: 1px solid var(--border); background: var(--dark); color: white; }
        
        .btn-small { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 500; transition: all 0.2s; }
        .btn-green { background: var(--outgoing); color: #fff; }
        .btn-green:hover { background: #007a63; }
        .btn-red { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid #ef4444; }
        .btn-blue { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid #3b82f6; }

        #context-menu { position: absolute; display: none; background: var(--panel); border: 1px solid var(--border); box-shadow: 0 4px 20px rgba(0,0,0,0.6); border-radius: 6px; width: 180px; z-index: 1000; overflow: hidden; }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; color: var(--text); }
        .ctx-item:hover { background: var(--dark); color: var(--primary); }
        .ctx-divider { height: 1px; background: var(--border); margin: 0; }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: var(--panel); color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; font-size: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); border: 1px solid var(--primary); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        
        @media (max-width: 768px) {
            .sidebar { display: none; } 
            .chat-list { width: 100%; position: absolute; z-index: 10; height: 100%; }
            .chat-area { width: 100%; position: absolute; z-index: 20; transform: translateX(100%); transition: transform 0.3s ease; background-color: var(--dark); }
            body.mobile-chat-open .chat-area { transform: translateX(0); }
            #back-btn { display: block !important; margin-right: 15px; font-size: 1.2rem; cursor: pointer; color: var(--text-muted); }
        }
        #back-btn { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div style="width: 40px; height: 40px; background: url('/api/data/config') no-repeat center/cover; border-radius: 50%; margin-bottom: 30px; background-color: #333;" id="logo-preview"></div>
        <button class="nav-btn active" onclick="switchTab('chat')" title="Chats"><i class="fas fa-comments"></i></button>
        <button class="nav-btn" onclick="switchTab('leads')" title="Base de Leads"><i class="fas fa-database"></i></button>
        <button class="nav-btn" onclick="switchTab('config')" title="Configuraci√≥n"><i class="fas fa-sliders-h"></i></button>
        <div class="nav-bottom">
            <button class="nav-btn" onclick="location.href='/logout'" title="Salir"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div class="main-area">
        
        <div id="tab-chat" class="view-panel active">
            <div class="chat-list" id="chat-list-panel">
                <div class="chat-header">
                    <div class="search-container">
                        <input type="text" class="search-bar" id="main-search" placeholder="üîç Buscar..." onkeyup="debounceSearch(this.value)">
                        <button class="action-btn" id="bulk-toggle-btn" onclick="toggleBulkMode()" title="Selecci√≥n M√∫ltiple"><i class="fas fa-check-double"></i></button>
                        <button class="action-btn new-chat-btn" onclick="startNewChat()" title="Nuevo Chat"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="view-filters">
                        <span class="filter-chip active" onclick="setChatFilter('active', this)">Activos</span>
                        <span class="filter-chip" onclick="setChatFilter('unread', this)">No le√≠dos</span>
                        <span class="filter-chip" onclick="setChatFilter('archived', this)">Archivados</span>
                        <select id="tag-filter" class="tag-filter-select" onchange="syncChats()">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>
                <div class="chat-items" id="chat-list-container"></div>
                
                <div id="bulk-toolbar">
                    <div style="color:var(--text); font-size:0.9rem; font-weight:bold;">
                        <span id="bulk-count">0</span> seleccionados
                    </div>
                    <div class="bulk-actions-row">
                        <select id="bulk-tag-select" class="tag-filter-select" style="max-width:100%;">
                            <option value="">Seleccionar Etiqueta...</option>
                        </select>
                        <button class="btn-small btn-green" onclick="executeBulkAction('set_label')">Aplicar</button>
                        <button class="btn-small btn-blue" onclick="executeBulkAction('toggle_archive')" title="Archivar/Desarchivar"><i class="fas fa-archive"></i></button>
                    </div>
                </div>
            </div>

            <div class="chat-area" id="conversation-view" style="display:none;">
                <div class="chat-top">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div id="back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></div>
                        <img id="chat-header-img" class="avatar" src="">
                        <div>
                            <div id="chat-header-name" style="font-weight:bold; font-size:1rem;">Selecciona un chat</div>
                            <div id="chat-header-phone" style="font-size:0.8rem; color:var(--text-muted);"></div>
                        </div>
                    </div>
                    <button class="nav-btn" onclick="toggleCRM()"><i class="fas fa-columns"></i></button>
                </div>
                
                <div class="messages" id="messages-container"></div>
                
                <div class="input-area">
                    <button class="attach-btn" onclick="document.getElementById('file-upload').click()"><i class="fas fa-paperclip"></i></button>
                    <input type="file" id="file-upload" hidden onchange="uploadFile()" accept="image/*,video/*,audio/*,application/pdf">
                    <textarea class="input-box" id="msg-input" placeholder="Escribe un mensaje..." onkeypress="checkEnter(event)"></textarea>
                    <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <div class="crm-panel" id="crm-panel">
                <div style="text-align:right;"><button class="btn-small btn-red" onclick="toggleCRM()">X</button></div>
                <div class="crm-section">
                    <div class="crm-title">ü§ñ Control IA</div>
                    <div class="switch-container">
                        <span class="switch-label">Valentina Responde</span>
                        <label class="switch">
                            <input type="checkbox" id="bot-switch" onchange="toggleBotActive()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="crm-section">
                    <div class="crm-title">üìù Datos del Contacto</div>
                    <input id="crm-name" class="crm-input" placeholder="Nombre Completo">
                    <input id="crm-email" class="crm-input" type="email" placeholder="Correo Electr√≥nico">
                    <input id="crm-city" class="crm-input" placeholder="Ciudad">
                    <input id="crm-dept" class="crm-input" placeholder="Departamento" readonly title="Se asigna autom√°ticamente desde el sistema" style="opacity:0.7; cursor:not-allowed;">
                    
                    <div class="crm-title" style="margin-top:20px;">üéØ Perfilamiento</div>
                    <select id="crm-interest" class="crm-input">
                        <option value="">Selecciona Inter√©s...</option>
                        <option value="Maquinaria nueva">Maquinaria nueva</option>
                        <option value="Maquinaria usada">Maquinaria usada</option>
                        <option value="Volquetas">Volquetas</option>
                        <option value="Martillos Hidr√°ulicos">Martillos Hidr√°ulicos</option>
                        <option value="Brazos largos">Brazos largos</option>
                        <option value="Accesorios">Accesorios</option>
                        <option value="Repuestos">Repuestos</option>
                        <option value="Servicio">Servicio</option>
                        <option value="Otro">Otro</option>
                        <option value="Consultando">Consultando</option>
                    </select>

                    <div class="crm-title" style="margin-top:20px;">üíº Ejecutivo Asignado</div>
                    <select id="crm-executive" class="crm-input">
                        <option value="Pendiente">Pendiente (Sin Asignar)</option>
                        <option value="005Dn000007mWFhIAM">Luz</option>
                        <option value="005UO000000PdB3YAK">Felipe</option>
                        <option value="005Dn000005u1yTIAQ">Mario</option>
                        <option value="005Dn000005u27NIAQ">Marcos</option>
                        <option value="005Dn000005u22vIAA">Fabio</option>
                        <option value="005Dn000005u2BkIAI">Diana</option>
                        <option value="005Dn000007H1EUIA0">Marketing</option>
                        <option value="005Dn000003Z5vbIAC">Oscar</option>
                    </select>

                    <button class="btn-small btn-green" style="width:100%; margin-top:15px;" onclick="saveLeadManual()">Guardar Cambios</button>
                </div>

                <div class="crm-section"><div class="crm-title">üè∑Ô∏è Etiqueta Comercial</div><div class="tag-container" id="tag-list"></div></div>
                <div class="crm-section"><div class="crm-title">‚ö° Respuestas R√°pidas</div><div class="tag-container" id="shortcuts-list"></div></div>
            </div>
        </div>

        <div id="tab-leads" class="view-panel">
            <div class="leads-container">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>Base de Leads</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-small btn-green" onclick="downloadExcel()"><i class="fas fa-file-excel"></i> Descargar Excel</button>
                        <button class="btn-small btn-blue" onclick="refreshLeads()"><i class="fas fa-sync"></i> Actualizar</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead><tr><th>Fecha</th><th>Fuente</th><th>Nombre</th><th>Tel√©fono</th><th>Ciudad</th><th>Departamento</th><th>Correo</th><th>Inter√©s</th><th>Ejecutivo</th><th>Etiqueta Comercial</th><th>Acciones</th></tr></thead>
                        <tbody id="leads-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-config" class="view-panel">
            <div class="config-container">
                <div>
                    <div class="config-header-main">üß† Cerebro Artificial (IA)</div>
                    <div class="config-row">
                        <div class="config-card"><div class="config-header"><span>Personalidad (Prompt)</span><button class="btn-small btn-green" onclick="savePrompt()"><i class="fas fa-save"></i></button></div><textarea id="prompt-editor" class="code-editor"></textarea></div>
                        <div class="config-card"><div class="config-header">Conocimiento Web</div><div class="config-input-group"><input type="text" id="web-url-input" class="cfg-input" placeholder="URL..."><button class="btn-small btn-blue" onclick="scanWeb()">+</button></div><ul class="item-list" id="web-knowledge-list"></ul></div>
                    </div>
                    <div class="config-row" style="margin-top:20px;">
                        <div class="config-card">
                            <div class="config-header">
                                <span>Inventario (Excel/CSV)</span>
                                <span id="inventory-count" style="font-size:0.8rem; color:#8696a0;">0 items</span>
                            </div>
                            <div style="display:flex; gap:10px; margin-bottom:15px;">
                                <input type="file" id="csv-upload" accept=".csv, .xlsx, .xls" style="color:white; width:60%; font-size:0.8rem;">
                                <button class="btn-small btn-green" onclick="uploadCSV()">Cargar</button>
                                <button class="btn-small btn-red" onclick="clearInventory()">Borrar Todo</button>
                                <button class="btn-small btn-blue" onclick="loadInventoryPreview()" title="Refrescar"><i class="fas fa-sync"></i></button>
                            </div>
                            <ul class="item-list" id="inventory-list" style="max-height: 200px; overflow-y: auto; border-top: 1px solid var(--border); padding-top: 10px;">
                                <li style="text-align:center; color:#555; font-size:0.8rem;">Cargando inventario...</li>
                            </ul>
                        </div>
                        
                        <div class="config-card"><div class="config-header">Reglas de Negocio</div><div class="config-input-group"><input type="text" id="rule-input" class="cfg-input" placeholder="Regla..."><button class="btn-small btn-blue" onclick="addRule()">+</button></div><ul class="item-list" id="rules-list"></ul></div>
                    </div>
                </div>
                <div>
                    <div class="config-header-main">üõ†Ô∏è Herramientas Comerciales</div>
                    <div class="config-row">
                        <div class="config-card"><div class="config-header">Etiquetas</div><div class="config-input-group"><input type="text" id="tag-name" class="cfg-input" placeholder="Nombre"><input type="color" id="tag-color" value="#00a884" style="width:40px; border:none; background:transparent;"><button class="btn-small btn-green" onclick="addTag()">Crear</button></div><ul class="item-list" id="config-tags-list"></ul></div>
                        <div class="config-card"><div class="config-header">Atajos (Respuestas R√°pidas)</div><div class="config-input-group"><input type="text" id="short-key" class="cfg-input" placeholder="/hola" style="width:30%;"><input type="text" id="short-text" class="cfg-input" placeholder="Texto..."><button class="btn-small btn-green" onclick="addShortcut()">+</button></div><ul class="item-list" id="config-shortcuts-list"></ul></div>
                    </div>
                     <div class="config-card" style="margin-top:20px;"><div class="config-header">Perfil de Empresa</div><div style="display:flex; gap:10px;"><input id="biz-name" class="cfg-input" placeholder="Nombre Empresa"><input id="biz-hours" class="cfg-input" placeholder="Horario"><button class="btn-small btn-green" onclick="saveBizConfig()">Guardar</button></div><div style="margin-top:10px; font-size:0.8rem;">Logo: <input type="file" onchange="uploadLogo(this)"></div></div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-box-open"></i> Editar Producto</div>
            <div class="modal-form">
                <input type="hidden" id="edit-id">
                <label>Nombre del Producto</label>
                <input type="text" id="edit-nombre">
                <label>Precio</label>
                <input type="text" id="edit-precio">
                <label>Stock</label>
                <input type="text" id="edit-stock">
                <label>Descripci√≥n</label>
                <textarea id="edit-desc" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-small btn-red" onclick="closeModal('edit-modal')">Cancelar</button>
                <button class="btn-small btn-green" onclick="saveEditInventory()">Guardar</button>
            </div>
        </div>
    </div>

    <div id="tag-edit-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:350px;">
            <div class="modal-title"><i class="fas fa-tag"></i> Editar Etiqueta</div>
            <div class="modal-form">
                <input type="hidden" id="edit-tag-id">
                <label>Nombre</label>
                <input type="text" id="edit-tag-name">
                <label>Color</label>
                <input type="color" id="edit-tag-color" style="height:40px;">
            </div>
            <div class="modal-actions">
                <button class="btn-small btn-red" onclick="closeModal('tag-edit-modal')">Cancelar</button>
                <button class="btn-small btn-green" onclick="saveTagEdit()">Actualizar</button>
            </div>
        </div>
    </div>

    <div id="forward-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-share"></i> Reenviar Mensaje</div>
            <div class="modal-form">
                <p id="forward-preview" style="font-size:0.85rem; color:var(--text-muted); font-style:italic; margin-bottom:15px; border-left:2px solid var(--primary); padding-left:10px;"></p>
                <label>Buscar Chat Destino</label>
                <input type="text" id="forward-search" placeholder="Escribe nombre..." onkeyup="filterForwardList()">
                <div id="forward-list" style="max-height:200px; overflow-y:auto; border:1px solid var(--border); border-radius:6px;"></div>
            </div>
            <div class="modal-actions">
                <button class="btn-small btn-red" onclick="closeModal('forward-modal')">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" id="ctx-pin" onclick="togglePinContext()"><i class="fas fa-thumbtack"></i> <span>Fijar</span></div>
        <div class="ctx-item" onclick="quickLabel()"><i class="fas fa-tag"></i> Etiquetar</div>
        <div class="ctx-item" id="ctx-archive" onclick="contextAction('toggle_archive')"><i class="fas fa-archive"></i> <span>Archivar</span></div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="contextAction('delete')" style="color:#ff4444;"><i class="fas fa-trash"></i> Eliminar</div>
    </div>

    <div id="toast">Notificaci√≥n</div>

    <script>
        let currentChat = null, currentFilter = 'active', chatsData = [], contextPhone = null, searchTimeout = null;
        let currentlyPlaying = null;
        let currentInventory = []; 
        
        let bulkMode = false;
        let selectedChats = new Set();
        let msgToForward = null;

        // Diccionario de Ejecutivos para la Interfaz vs Excel
        const executivesMap = {
            "005Dn000007mWFhIAM": "Luz",
            "005UO000000PdB3YAK": "Felipe",
            "005Dn000005u1yTIAQ": "Mario",
            "005Dn000005u27NIAQ": "Marcos",
            "005Dn000005u22vIAA": "Fabio",
            "005Dn000005u2BkIAI": "Diana",
            "005Dn000007H1EUIA0": "Marketing",
            "005Dn000003Z5vbIAC": "Oscar",
            "Pendiente": "Pendiente (Sin Asignar)"
        };

        window.onload = function() { startSyncLoop(); refreshLeads(); loadAllConfig(); loadTagFilterOptions(); document.addEventListener('click', (e) => { if(!e.target.closest('.chat-item')) document.getElementById('context-menu').style.display = 'none'; }); };
        function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        function switchTab(tab) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(tab === 'leads') refreshLeads();
            if(tab === 'config') loadInventoryPreview();
        }
        function toggleCRM() { document.getElementById('crm-panel').classList.toggle('open'); }
        function closeChat() { 
            document.body.classList.remove('mobile-chat-open'); 
            currentChat = null; 
            if(currentlyPlaying) { currentlyPlaying.pause(); currentlyPlaying = null; }
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        }
        function debounceSearch(val) { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => syncChats(), 300); }
        function startNewChat() { const phone = prompt("Ingresa el n√∫mero:"); if (!phone) return; const name = prompt("Nombre:") || phone; openChat(phone.replace(/\D/g, ''), name, ''); }
        function startSyncLoop() { syncChats(); setInterval(syncChats, 3000); setInterval(() => { if(currentChat) loadMessages(currentChat, false); }, 3000); }
        
        async function loadTagFilterOptions() { try { const tags = await (await fetch('/api/data/tags')).json(); 
            const html = '<option value="">Todas</option>' + tags.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            document.getElementById('tag-filter').innerHTML = html;
            document.getElementById('bulk-tag-select').innerHTML = '<option value="">Etiquetar como...</option>' + tags.map(t => `<option value='${JSON.stringify({text:t.name, color:t.color})}'>${t.name}</option>`).join('');
        } catch(e) {} }
        
        async function syncChats() { 
            try { 
                const search = document.getElementById('main-search').value; 
                const res = await fetch(`/api/chats-full?view=${currentFilter}&search=${search}`); 
                chatsData = await res.json(); 
                const tagFilter = document.getElementById('tag-filter').value; 
                if(tagFilter) chatsData = chatsData.filter(c => c.labels && c.labels.some(l => (l.text || l) === tagFilter)); 
                chatsData.sort((a, b) => new Date(b.lastMessage.time) - new Date(a.lastMessage.time)); 
                chatsData.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0)); 
                renderChatList(); 
            } catch(e) {} 
        }

        function setChatFilter(filter, el) { currentFilter = filter; document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); syncChats(); }
        function normalizeTag(tag) { return typeof tag === 'string' ? { text: tag, color: '#555' } : tag; }
        
        function toggleBulkMode() {
            bulkMode = !bulkMode;
            const btn = document.getElementById('bulk-toggle-btn');
            const toolbar = document.getElementById('bulk-toolbar');
            const panel = document.getElementById('chat-list-panel');
            
            if (bulkMode) {
                btn.classList.add('active');
                panel.classList.add('bulk-mode');
                toolbar.classList.add('show');
            } else {
                btn.classList.remove('active');
                panel.classList.remove('bulk-mode');
                toolbar.classList.remove('show');
                selectedChats.clear();
                renderChatList();
            }
        }

        function toggleChatSelection(phone, event) {
            if (!bulkMode) return;
            event.stopPropagation();
            if (selectedChats.has(phone)) selectedChats.delete(phone);
            else selectedChats.add(phone);
            document.getElementById('bulk-count').innerText = selectedChats.size;
            renderChatList();
        }

        async function executeBulkAction(action) {
            if (selectedChats.size === 0) return alert("Selecciona al menos un chat");
            
            let value = null;
            if (action === 'set_label') {
                const valStr = document.getElementById('bulk-tag-select').value;
                if (!valStr) return alert("Selecciona una etiqueta");
                value = JSON.parse(valStr);
                action = 'add_label';
            }

            if (!confirm(`¬øAplicar acci√≥n a ${selectedChats.size} chats?`)) return;

            await fetch('/api/contacts/bulk-update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phones: Array.from(selectedChats),
                    action: action,
                    value: value
                })
            });

            showToast("Acci√≥n masiva completada");
            toggleBulkMode();
            syncChats();
        }
        
        function renderChatList() {
            const container = document.getElementById('chat-list-container'); 
            const scroll = container.children.length > 0 ? container.scrollTop : 0;
            
            container.innerHTML = chatsData.map(c => {
                let labelsHtml = ''; if(c.labels && Array.isArray(c.labels)) labelsHtml = c.labels.map(l => { const tag = normalizeTag(l); return `<span class="mini-tag" style="background:${tag.color}30; color:${tag.color}; border:1px solid ${tag.color}">${tag.text}</span>` }).join('');
                
                let sourceBadge = '';
                if(c.source && c.source.includes('Ads')) sourceBadge = `<span class="badge" style="background:#ff0000; color:#fff;">ADS</span>`;
                else if(c.source === 'Web') sourceBadge = `<span class="badge" style="background:#1e3a8a; color:#fff;">WEB</span>`;
                else if(c.source === 'Tienda Virtual') sourceBadge = `<span class="badge" style="background:#a21caf; color:#fff;">TIENDA</span>`;

                const isSelected = selectedChats.has(c.id);

                return `<div id="chat-${c.id}" class="chat-item ${currentChat === c.id ? 'active' : ''} ${c.archived ? 'archived' : ''}" onclick="openChat('${c.id}', '${c.name}', '${c.photoUrl || ''}')" oncontextmenu="showContextMenu(event, '${c.id}', ${c.pinned}, ${c.archived})">
                    <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''} onclick="toggleChatSelection('${c.id}', event)">
                    <div class="avatar">${c.photoUrl ? `<img src="${c.photoUrl}" style="width:100%;height:100%;object-fit:cover;">` : '<i class="fas fa-user"></i>'}</div>
                    <div class="chat-info">
                        <div class="chat-name">
                            <span>${c.name} ${c.pinned ? '<i class="fas fa-thumbtack pin-icon"></i>' : ''}</span>
                            <span class="chat-date">${new Date(c.lastMessage.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="chat-preview">
                            <span class="chat-last-msg">${c.lastMessage.text || 'Multimedia'}</span>
                            <div style="display:flex; gap:3px;">${c.unreadCount > 0 ? `<span class="badge">${c.unreadCount}</span>` : ''}${sourceBadge}</div>
                        </div>
                        <div class="mini-tags">${labelsHtml}</div>
                    </div>
                </div>`;
            }).join(''); 
            
            if(scroll > 0) container.scrollTop = scroll;
        }

        function showContextMenu(e, phone, isPinned, isArchived) { e.preventDefault(); contextPhone = phone; const menu = document.getElementById('context-menu'); const pinBtn = document.getElementById('ctx-pin'); pinBtn.innerHTML = isPinned ? '<i class="fas fa-thumbtack" style="opacity:0.5"></i> <span>Desfijar</span>' : '<i class="fas fa-thumbtack"></i> <span>Fijar</span>'; pinBtn.onclick = () => contextAction('toggle_pin'); const archBtn = document.getElementById('ctx-archive'); archBtn.innerHTML = isArchived ? '<i class="fas fa-box-open"></i> <span>Desarchivar</span>' : '<i class="fas fa-archive"></i> <span>Archivar</span>'; archBtn.onclick = () => contextAction('toggle_archive'); menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px'; }
        async function contextAction(action, valueOverride = true) { if(!contextPhone) return; if(action === 'delete' && !confirm("¬øELIMINAR CHAT?")) return; await fetch('/api/chat/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: contextPhone, action: action, value: valueOverride }) }); syncChats(); document.getElementById('context-menu').style.display = 'none'; }
        function quickLabel() { if(!contextPhone) return; const chat = chatsData.find(c => c.id === contextPhone); if(chat) openChat(chat.id, chat.name, chat.photoUrl); document.getElementById('crm-panel').classList.add('open'); document.getElementById('context-menu').style.display = 'none'; }
        
        async function openChat(phone, name, photo) { 
            if(bulkMode) return toggleChatSelection(phone, event); 

            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            const clickedItem = document.getElementById(`chat-${phone}`);
            if(clickedItem) clickedItem.classList.add('active');

            currentChat = phone; 
            document.body.classList.add('mobile-chat-open'); 
            document.getElementById('conversation-view').style.display = 'flex'; 
            document.getElementById('chat-header-name').innerText = name; 
            document.getElementById('chat-header-phone').innerText = phone; 
            document.getElementById('chat-header-img').src = photo || ''; 
            document.getElementById('messages-container').innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100%; color:#8696a0; flex-direction:column; gap:10px;"><i class="fas fa-spinner fa-spin fa-2x"></i><span style="font-size:0.9rem;">Cargando historial...</span></div>`; 
            
            const chatInfo = chatsData.find(c => c.id === phone); 
            document.getElementById('bot-switch').checked = chatInfo ? chatInfo.botActive : true; 
            loadLeadDataToCRM(phone); 
            loadTags(phone); 
            await loadMessages(phone, true); 
        }
        
        function formatSmartTime(iso) {
            if(!iso) return '';
            const d = new Date(iso);
            const now = new Date();
            const isToday = d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            const timeStr = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            if (isToday) return timeStr;
            const dateStr = d.toLocaleDateString([], {day: '2-digit', month: '2-digit', year:'2-digit'});
            return `${dateStr} ${timeStr}`;
        }

        async function loadMessages(phone, scrollDown) {
            try { const res = await fetch(`/api/chat-history/${phone}`); const msgs = await res.json(); if(currentChat !== phone) return; const container = document.getElementById('messages-container');
                container.innerHTML = msgs.map(m => { 
                    let text = m.text;
                    let isMedia = false;
                    let mediaId = null;

                    if(text.includes('[MEDIA:')) { 
                        isMedia = true;
                        const parts = text.split(':'); 
                        const type = parts[1]; 
                        const id = parts[2].split(']')[0]; 
                        const extraCaption = text.split(']').slice(1).join(']').trim(); 
                        mediaId = id;
                        const mediaUrl = `/api/media-proxy/${id}?v=final`; 
                        
                        let captionHtml = extraCaption ? `<div style="margin-top:8px; font-size:0.9rem;">${extraCaption}</div>` : '';

                        if(type === 'IMAGE') { text = `<div style="display:flex; flex-direction:column; gap:5px;"><img src="${mediaUrl}" style="max-width:250px; border-radius:8px; cursor:pointer; min-height:100px; background:#0b141a;" onclick="window.open(this.src)" onerror="this.style.display='none';this.nextElementSibling.style.display='block';"><div style="display:none; color:#ef4444; font-size:0.8rem; padding:10px; border:1px dashed #ef4444; border-radius:8px;">‚ö†Ô∏è Error de imagen.</div>${captionHtml}</div>`; }
                        else if(type === 'AUDIO') {
                            text = `<div class="audio-wrapper">
                                <div class="audio-player">
                                    <button class="play-btn" id="btn-${id}" onclick="togglePlay('${id}')"><i class="fas fa-play"></i></button>
                                    <div class="audio-progress"><div class="progress-bar-bg"><div id="prog-${id}" class="progress-fill"></div></div><div id="time-${id}" class="audio-time">0:00</div></div>
                                    <audio id="audio-${id}" src="${mediaUrl}" preload="auto" ontimeupdate="updateProgress('${id}')" onended="resetPlayer('${id}')" onplaying="onAudioStart('${id}')" style="display:none;"></audio>
                                </div>
                                <a href="${mediaUrl}" download="nota_voz.ogg" class="btn-download-audio" title="Descargar"><i class="fas fa-download"></i></a>
                            </div>`;
                        } else { text = `<a href="${mediaUrl}" target="_blank" style="color:white; text-decoration:none; display:flex; align-items:center; gap:10px; background:rgba(0,0,0,0.2); padding:10px; border-radius:6px;"><i class="fas fa-file-download" style="font-size:1.5rem;"></i><div style="display:flex; flex-direction:column;"><span>Archivo Adjunto (${type})</span><span style="font-size:0.75rem; color:var(--primary);">Clic para descargar</span></div></a>${captionHtml}`; }
                    } 
                    
                    const safeText = m.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    
                    // --- DETECTA SI ES UNA ALERTA DE SISTEMA ---
                    const isAlert = text.includes('[ALERTA:');
                    
                    return `<div class="msg ${isAlert ? 'alert' : m.role}">
                        ${text}
                        <div class="msg-time">${formatSmartTime(m.time)}</div>
                        ${!isAlert ? `<div class="msg-forward-btn" onclick="openForwardModal('${safeText}', ${isMedia}, '${mediaId}')" title="Reenviar">
                            <i class="fas fa-share"></i>
                        </div>` : ''}
                    </div>`;
                }).join(''); if(scrollDown) setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
            } catch(e) {}
        }

        function openForwardModal(content, isMedia, mediaId) {
            msgToForward = { content, isMedia, mediaId };
            let preview = "";
            if (isMedia) preview = "Multimedia (Imagen/Audio/Doc)";
            else preview = content.substring(0, 50) + "...";
            
            document.getElementById('forward-preview').innerText = "Reenviando: " + preview;
            document.getElementById('forward-modal').classList.add('show');
            renderForwardList(chatsData);
        }

        function filterForwardList() {
            const term = document.getElementById('forward-search').value.toLowerCase();
            const filtered = chatsData.filter(c => c.name.toLowerCase().includes(term) || c.id.includes(term));
            renderForwardList(filtered);
        }

        function renderForwardList(list) {
            const container = document.getElementById('forward-list');
            container.innerHTML = list.map(c => `
                <div style="padding:10px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; align-items:center; gap:10px; hover:background:var(--hover-item);" onclick="executeForward('${c.id}')">
                    <div class="avatar" style="width:30px; height:30px;">${c.photoUrl ? `<img src="${c.photoUrl}" style="width:100%;height:100%;">` : '<i class="fas fa-user"></i>'}</div>
                    <div style="font-size:0.9rem;">${c.name}</div>
                </div>
            `).join('');
        }

        async function executeForward(targetPhone) {
            if(!msgToForward) return;
            closeModal('forward-modal');
            
            await fetch('/api/chat/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: targetPhone, message: msgToForward.content })
            });
            
            showToast("Mensaje reenviado");
            if (currentChat === targetPhone) loadMessages(targetPhone, true);
        }

        function togglePlay(id) { const audio = document.getElementById(`audio-${id}`); const btn = document.getElementById(`btn-${id}`); if(audio.paused) { if(currentlyPlaying && currentlyPlaying !== audio) { currentlyPlaying.pause(); resetPlayer(currentlyPlaying.id.replace('audio-', '')); } btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; audio.play(); currentlyPlaying = audio; } else { audio.pause(); btn.innerHTML = '<i class="fas fa-play"></i>'; } }
        function onAudioStart(id) { document.getElementById(`btn-${id}`).innerHTML = '<i class="fas fa-pause"></i>'; }
        function updateProgress(id) { const audio = document.getElementById(`audio-${id}`); const bar = document.getElementById(`prog-${id}`); const time = document.getElementById(`time-${id}`); if(audio && audio.duration) { const percent = (audio.currentTime / audio.duration) * 100; bar.style.width = percent + '%'; const mins = Math.floor(audio.currentTime / 60); const secs = Math.floor(audio.currentTime % 60); time.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`; } }
        function resetPlayer(id) { document.getElementById(`btn-${id}`).innerHTML = '<i class="fas fa-play"></i>'; document.getElementById(`prog-${id}`).style.width = '0%'; }

        async function uploadFile() {
            const input = document.getElementById('file-upload');
            if(!input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            formData.append('phone', currentChat);
            const type = input.files[0].type.startsWith('image/') ? 'image' : 
                         (input.files[0].type.startsWith('audio/') ? 'audio' : 'document');
            formData.append('type', type);
            const container = document.getElementById('messages-container');
            container.innerHTML += `<div class="msg manual">üìÅ Enviando archivo...<div class="msg-time">...</div></div>`;
            container.scrollTop = container.scrollHeight;
            await fetch('/api/chat/upload-send', { method: 'POST', body: formData });
            input.value = ''; 
            loadMessages(currentChat, true);
        }

        async function sendMessage() { const txt = document.getElementById('msg-input').value; if(!txt) return; document.getElementById('msg-input').value = ''; const container = document.getElementById('messages-container'); container.innerHTML += `<div class="msg manual">${txt} <div class="msg-time">...</div></div>`; container.scrollTop = container.scrollHeight; await fetch('/api/chat/send', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: currentChat, message: txt }) }); loadMessages(currentChat, true); }
        function checkEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        async function toggleBotActive() { const active = document.getElementById('bot-switch').checked; await fetch('/api/chat/toggle-bot', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: currentChat, active }) }); showToast(active ? "ü§ñ Bot Activado" : "‚è∏Ô∏è Bot Pausado"); }
        
        async function loadLeadDataToCRM(phone) { 
            document.getElementById('crm-name').value=""; 
            document.getElementById('crm-city').value=""; 
            document.getElementById('crm-dept').value=""; 
            document.getElementById('crm-email').value=""; 
            document.getElementById('crm-interest').value=""; 
            document.getElementById('crm-executive').value="Pendiente"; 

            const res = await fetch('/api/data/leads'); 
            const leads = await res.json(); 
            const lead = leads.find(l => l.phone === phone); 
            
            if(lead) { 
                document.getElementById('crm-name').value = lead.nombre||""; 
                document.getElementById('crm-city').value = lead.ciudad||""; 
                document.getElementById('crm-dept').value = lead.departamento||""; 
                document.getElementById('crm-email').value = lead.correo||""; 
                
                // Set Inter√©s (Ahora funciona con las nuevas categor√≠as que pueden tener espacios)
                let interestSelect = document.getElementById('crm-interest');
                let foundInterest = false;
                if(lead.interes) {
                    for(let opt of interestSelect.options) {
                        if(opt.value.toUpperCase() === lead.interes.toUpperCase()) {
                            interestSelect.value = opt.value;
                            foundInterest = true; break;
                        }
                    }
                    if(!foundInterest) interestSelect.value = "Consultando";
                }

                // Set Ejecutivo (Guardado en 'etiqueta')
                let execSelect = document.getElementById('crm-executive');
                if (lead.etiqueta && executivesMap[lead.etiqueta]) {
                    execSelect.value = lead.etiqueta;
                } else {
                    execSelect.value = "Pendiente";
                }
            } 
        }

        async function saveLeadManual() { 
            if(!currentChat) return; 
            const res = await fetch('/api/data/leads'); 
            const leads = await res.json(); 
            const lead = leads.find(l => l.phone === currentChat); 
            const id = lead ? lead.id : null; 
            
            if(id) { 
                const updates = [
                    {field:'nombre', value:document.getElementById('crm-name').value},
                    {field:'ciudad', value:document.getElementById('crm-city').value},
                    {field:'correo', value:document.getElementById('crm-email').value},
                    {field:'interes', value:document.getElementById('crm-interest').value},
                    {field:'etiqueta', value:document.getElementById('crm-executive').value}
                ]; 
                for(let u of updates) {
                    await fetch('/api/leads/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, field: u.field, value: u.value }) }); 
                }
                showToast("‚úÖ Datos Guardados"); 
                refreshLeads(); 
            } else { 
                showToast("‚ö†Ô∏è Espera un mensaje del cliente."); 
            } 
        }
        
        function downloadExcel() { 
            const rows = [['Fecha', 'Fuente', 'Nombre', 'Telefono', 'Ciudad', 'Departamento', 'Correo', 'Interes', 'Ejecutivo ID', 'Etiqueta Comercial']]; 
            const table = document.getElementById('leads-body'); 
            
            for (let tr of table.rows) { 
                const cells = Array.from(tr.cells);
                const rowData = [
                    cells[0].innerText, // Fecha
                    cells[1].innerText, // Fuente
                    cells[2].innerText, // Nombre
                    cells[3].innerText, // Telefono
                    cells[4].innerText, // Ciudad
                    cells[5].innerText, // Departamento
                    cells[6].innerText, // Correo
                    cells[7].innerText, // Interes
                    tr.getAttribute('data-exec-id'), // Ejecutivo ID
                    cells[9].innerText  // Etiqueta Comercial
                ];
                rows.push(rowData); 
            } 
            
            // BOM UTF-8 para que las tildes se vean bien en Excel
            let csvContent = "\uFEFF";
            csvContent += rows.map(e => e.map(v => `"${v ? String(v).replace(/"/g, '""') : ''}"`).join(",")).join("\n"); 
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(blob);
            link.download = "leads_icc.csv"; 
            document.body.appendChild(link); 
            link.click(); 
        }

        function loadTags(phone) { fetch('/api/data/tags').then(r=>r.json()).then(t => renderCRMTags(t)); }
        function renderCRMTags(tags) { const chat = chatsData.find(c => c.id === currentChat); const activeTags = chat ? chat.labels : []; document.getElementById('tag-list').innerHTML = tags.map(t => { const isActive = activeTags && activeTags.some(at => normalizeTag(at).text === t.name); return `<span class="tag ${isActive ? 'selected' : ''}" style="border-color:${t.color}; color:${isActive?'#fff':t.color}; background:${isActive?t.color:'transparent'}" onclick="toggleChatTag('${t.name}', '${t.color}')">${t.name}</span>`; }).join(''); }
        async function toggleChatTag(name, color) { if(!currentChat) return; const chat = chatsData.find(c => c.id === currentChat); let labels = chat.labels || []; const exists = labels.some(l => normalizeTag(l).text === name); if(exists) labels = labels.filter(l => normalizeTag(l).text !== name); else labels.push({text: name, color}); await fetch('/api/chat/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: currentChat, action: 'set_labels', value: labels }) }); const res = await fetch('/api/data/leads'); const leads = await res.json(); const lead = leads.find(l => l.phone === currentChat); if(lead) { const newStatus = exists ? (labels.length > 0 ? labels[0].text : "Sin Etiqueta") : name; await fetch('/api/leads/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: lead.id, field: 'status_tag', value: newStatus }) }); } syncChats(); setTimeout(() => { loadTags(currentChat); refreshLeads(); }, 300); }
        async function loadAllConfig() { 
            const res = await fetch('/api/data/config'); 
            const cfg = await res.json(); 
            document.getElementById('prompt-editor').value = cfg.prompt || ''; 
            document.getElementById('biz-name').value = cfg.biz_profile?.name || ''; 
            document.getElementById('biz-hours').value = cfg.biz_profile?.hours || ''; 
            renderWebList(); 
            renderRulesList(cfg.tech_rules); 
            fetch('/api/data/tags').then(r=>r.json()).then(t => renderConfigTags(t)); 
            fetch('/api/data/shortcuts').then(r=>r.json()).then(s => renderConfigShortcuts(s)); 
            if(cfg.logo_url) document.getElementById('logo-preview').style.backgroundImage = `url('${cfg.logo_url}')`; 
            loadInventoryPreview();
        }
        async function saveBizConfig() { await fetch('/api/config/biz/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: document.getElementById('biz-name').value, hours: document.getElementById('biz-hours').value }) }); showToast("Perfil Actualizado"); }
        async function savePrompt() { await fetch('/api/config/prompt', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: document.getElementById('prompt-editor').value }) }); showToast("Personalidad Guardada"); }
        async function uploadLogo(input) { const fd = new FormData(); fd.append('file', input.files[0]); await fetch('/api/config/logo', { method: 'POST', body: fd }); showToast("Logo Actualizado"); loadAllConfig(); }
        async function uploadCSV() { 
            const input = document.getElementById('csv-upload'); 
            if(!input.files[0]) return alert("Selecciona CSV o Excel"); 
            const fd = new FormData(); 
            fd.append('file', input.files[0]); 
            await fetch('/api/knowledge/csv', { method: 'POST', body: fd }); 
            showToast("Inventario Cargado"); 
            loadInventoryPreview();
        }
        async function clearInventory() { if(!confirm("¬øBorrar TODO?")) return; await fetch('/api/knowledge/clear', { method: 'POST' }); showToast("Inventario Borrado"); loadInventoryPreview(); }
        async function renderWebList() { const res = await fetch('/api/data/web-knowledge'); const list = await res.json(); document.getElementById('web-knowledge-list').innerHTML = list.map(i => `<li class="config-item"><span style="max-width:200px; overflow:hidden; text-overflow:ellipsis;">${i.url}</span><div style="display:flex; gap:5px;"><button class="btn-small btn-blue" onclick="showWebInfo('${encodeURIComponent(i.summary)}')"><i class="fas fa-eye"></i></button><button class="btn-small btn-red" onclick="deleteWeb('${i.id}')"><i class="fas fa-trash"></i></button></div></li>`).join(''); }
        function showWebInfo(summary) { alert(decodeURIComponent(summary)); }
        async function scanWeb() { const url = document.getElementById('web-url-input').value; const summary = prompt("Resumen p√°gina:"); if(summary) { await fetch('/api/data/web-knowledge', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url, summary }) }); document.getElementById('web-url-input').value = ""; renderWebList(); } }
        async function deleteWeb(id) { await fetch('/api/data/web-knowledge/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) }); renderWebList(); }
        function renderRulesList(rules) { document.getElementById('rules-list').innerHTML = (rules || []).map((r, i) => `<li class="config-item"><span>${r}</span><button class="btn-small btn-red" onclick="deleteRule(${i})"><i class="fas fa-trash"></i></button></li>`).join(''); }
        async function addRule() { const r = document.getElementById('rule-input').value; if(!r) return; const res = await fetch('/api/config/rules/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ rule: r }) }); const data = await res.json(); renderRulesList(data.rules); document.getElementById('rule-input').value = ""; }
        async function deleteRule(i) { const res = await fetch('/api/config/rules/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ index: i }) }); const data = await res.json(); renderRulesList(data.rules); }
        
        // --- TAG CRUD ---
        function renderConfigTags(tags) { 
            document.getElementById('config-tags-list').innerHTML = tags.map(t => `<li class="config-item">
                <span style="color:${t.color};font-weight:bold;">${t.name}</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-small btn-blue" onclick="editTag(${t.id}, '${t.name}', '${t.color}')"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn-small btn-red" onclick="deleteTag(${t.id})"><i class="fas fa-trash"></i></button>
                </div>
            </li>`).join(''); 
            renderCRMTags(tags); 
        }
        async function addTag() { const name = document.getElementById('tag-name').value; const color = document.getElementById('tag-color').value; if(!name) return; await fetch('/api/tags/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, color }) }); loadAllConfig(); document.getElementById('tag-name').value = ""; }
        async function deleteTag(id) { await fetch('/api/tags/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) }); loadAllConfig(); }
        
        function editTag(id, name, color) {
            document.getElementById('edit-tag-id').value = id;
            document.getElementById('edit-tag-name').value = name;
            document.getElementById('edit-tag-color').value = color;
            document.getElementById('tag-edit-modal').classList.add('show');
        }
        async function saveTagEdit() {
            const id = document.getElementById('edit-tag-id').value;
            const name = document.getElementById('edit-tag-name').value;
            const color = document.getElementById('edit-tag-color').value;
            await fetch('/api/tags/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, name, color }) });
            closeModal('tag-edit-modal');
            loadAllConfig();
            showToast("Etiqueta actualizada");
        }

        function renderConfigShortcuts(shortcuts) { const list = shortcuts.map(s => `<li class="config-item"><span><b>${s.keyword}</b></span><button class="btn-small btn-red" onclick="deleteShortcut(${s.id})"><i class="fas fa-trash"></i></button></li>`).join(''); document.getElementById('config-shortcuts-list').innerHTML = list; document.getElementById('shortcuts-list').innerHTML = shortcuts.map(s => `<span class="tag" onclick="insertShortcut('${s.text}')">${s.keyword}</span>`).join(''); }
        async function addShortcut() { const k = document.getElementById('short-key').value; const t = document.getElementById('short-text').value; if(!k || !t) return; await fetch('/api/shortcuts/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ keyword: k, text: t }) }); loadAllConfig(); document.getElementById('short-key').value = ""; document.getElementById('short-text').value = ""; }
        async function deleteShortcut(id) { await fetch('/api/shortcuts/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) }); loadAllConfig(); }
        function insertShortcut(text) { document.getElementById('msg-input').value += text; }
        
        async function refreshLeads() { 
            const res = await fetch('/api/data/leads'); 
            const leads = await res.json(); 
            
            document.getElementById('leads-body').innerHTML = leads.map(l => {
                const execName = executivesMap[l.etiqueta] || l.etiqueta || 'Pendiente';
                return `<tr data-exec-id="${l.etiqueta || 'Pendiente'}">
                    <td>${new Date(l.fecha).toLocaleDateString()}</td>
                    <td><span class="lead-source-tag ${l.source==='Web'?'lead-source-web':(l.source==='Tienda Virtual'?'lead-source-store':'')}">${l.source||'Org√°nico'}</span></td>
                    <td>${l.nombre||'-'}</td>
                    <td>${l.phone}</td>
                    <td>${l.ciudad||'-'}</td>
                    <td>${l.departamento||'-'}</td>
                    <td>${l.correo||'-'}</td>
                    <td><strong>${l.interes||'-'}</strong></td>
                    <td>${execName}</td>
                    <td><span class="tag" style="background:var(--panel)">${l.status_tag||'-'}</span></td>
                    <td><button class="nav-btn" style="height:30px;" onclick="openChat('${l.phone}', '${l.nombre}', '')"><i class="fas fa-comment"></i></button></td>
                </tr>`;
            }).join(''); 
        }

        async function loadInventoryPreview() {
            const list = document.getElementById('inventory-list');
            const countLabel = document.getElementById('inventory-count');
            try {
                const res = await fetch('/api/data/knowledge');
                currentInventory = await res.json();
                countLabel.innerText = `${currentInventory.length} items`;
                if(currentInventory.length === 0) {
                    list.innerHTML = '<li style="text-align:center; color:#8696a0; padding:10px; font-size:0.8rem;">No hay inventario cargado.</li>';
                    return;
                }
                list.innerHTML = currentInventory.map(item => {
                    let display = "Producto desconocido";
                    try {
                        const obj = JSON.parse(item.raw_data);
                        const nombre = obj.nombre || obj.name || obj.producto || "Sin Nombre";
                        const precio = obj.precio || obj.price || "";
                        display = `<b>${nombre}</b> ${precio ? `($${precio})` : ''}`;
                    } catch(e) { display = item.searchable.substring(0, 30) + "..."; }
                    
                    return `<li class="config-item" style="font-size:0.85rem;">
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:65%;">${display}</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-small btn-blue" onclick="openEditModal(${item.id})"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-small btn-red" onclick="deleteInventoryItem(${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        function openEditModal(id) {
            const item = currentInventory.find(i => i.id === id);
            if(!item) return;
            try {
                const data = JSON.parse(item.raw_data);
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-nombre').value = data.nombre || data.name || data.producto || "";
                document.getElementById('edit-precio').value = data.precio || data.price || "";
                document.getElementById('edit-stock').value = data.stock || data.cantidad || "";
                document.getElementById('edit-desc').value = data.descripcion || data.desc || "";
                document.getElementById('edit-modal').classList.add('show');
            } catch(e) { alert("Error al leer datos del producto."); }
        }

        async function saveEditInventory() {
            const id = document.getElementById('edit-id').value;
            const newData = {
                nombre: document.getElementById('edit-nombre').value,
                precio: document.getElementById('edit-precio').value,
                stock: document.getElementById('edit-stock').value,
                descripcion: document.getElementById('edit-desc').value
            };
            await fetch('/api/knowledge/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, data: newData })
            });
            closeModal('edit-modal');
            showToast("Producto actualizado");
            loadInventoryPreview();
        }

        async function deleteInventoryItem(id) {
            if(!confirm("¬øBorrar este producto definitivamente?")) return;
            await fetch('/api/knowledge/delete', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ id }) 
            });
            loadInventoryPreview();
        }
    </script>
</body>
</html>
