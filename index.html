<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICC | Valentina Suite v23.1 (Instant Load)</title>
    <link rel="icon" href="https://github.com/juanballen2/CHATBOT/blob/main/images/favicon.jpg?raw=true">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* =========================================
           1. CORE STYLES
           ========================================= */
        :root {
            --primary: #E9511D;
            --primary-dark: #c03d12;
            --bg-body: #F3F4F6;
            --bg-sidebar: #0F172A;
            --bg-card: #FFFFFF;
            --text-main: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --chat-bg: #EFEAE2;
            --terminal-bg: #1e1e1e;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 4px; }

        /* SIDEBAR */
        .sidebar { width: 70px; background: var(--bg-sidebar); display: flex; flex-direction: column; align-items: center; padding: 20px 0; z-index: 50; box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
        .logo-area { width: 45px; height: 45px; margin-bottom: 40px; cursor: pointer; background: white; border-radius: 12px; padding: 4px; }
        .nav-item { width: 42px; height: 42px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #94A3B8; cursor: pointer; margin-bottom: 18px; transition: 0.2s; position: relative; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(233, 81, 29, 0.4); }
        .nav-item i { font-size: 19px; }

        /* MAIN CONTENT */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .view { display: none; height: 100%; flex-direction: column; overflow-y: auto; padding: 0; }
        .view.active { display: flex; }
        .page-container { padding: 30px; max-width: 1400px; margin: 0 auto; width: 100%; }

        h1 { font-size: 24px; font-weight: 700; margin-bottom: 25px; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 24px; border: 1px solid var(--border); height: 100%; display: flex; flex-direction: column; }

        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: var(--primary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-icon { background: none; border: none; font-size: 18px; color: #54656F; cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .btn-icon:hover { background: rgba(0,0,0,0.05); color: var(--primary); }
        .form-control { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 12px; background: #F9FAFB; }
        
        /* CHAT LAYOUT */
        .chat-layout { display: flex; height: 100%; width: 100%; background: white; }
        .cl-panel { width: 340px; border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; }
        .cl-header { padding: 16px; border-bottom: 1px solid var(--border); background: #F8FAFC; }
        .cl-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 14px 16px; border-bottom: 1px solid #F1F5F9; cursor: pointer; display: flex; gap: 12px; transition: 0.2s; }
        .chat-item:hover { background: #F8FAFC; }
        .chat-item.active { background: #FFF7ED; border-left: 4px solid var(--primary); }
        .avatar { width: 44px; height: 44px; border-radius: 50%; background: #E2E8F0; background-size: cover; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        .ca-panel { flex: 1; display: flex; flex-direction: column; position: relative; background: var(--chat-bg); min-width: 400px; }
        .chat-bg-pattern { position: absolute; width: 100%; height: 100%; opacity: 0.06; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); pointer-events: none; z-index: 0; }
        .ca-header { background: white; padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .messages-box { flex: 1; padding: 20px 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; z-index: 5; }
        .input-area { background: white; padding: 12px 20px; display: flex; align-items: center; gap: 12px; z-index: 10; border-top: 1px solid var(--border); }
        
        .bubble { padding: 8px 14px; font-size: 14.5px; max-width: 65%; line-height: 1.5; border-radius: 8px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .b-user { align-self: flex-start; background: white; border-radius: 0 8px 8px 8px; }
        .b-manual { align-self: flex-end; background: #D9FDD3; border-radius: 8px 0 8px 8px; }
        .b-bot { align-self: flex-end; background: #FFFFFF; border-radius: 8px 0 8px 8px; border-right: 4px solid var(--primary); }
        .msg-time { font-size: 10px; color: #888; text-align: right; margin-top: 2px; }

        /* CRM */
        .crm-panel { width: 300px; background: white; border-left: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; transition: 0.3s; }
        .crm-panel.closed { display: none; }
        .crm-header { padding: 30px 20px; text-align: center; background: #F8FAFC; border-bottom: 1px solid var(--border); }
        .crm-body { padding: 20px; }
        .crm-stat { background: #F3F4F6; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }

        /* SCROLLABLE LISTS */
        .scrollable-list { max-height: 250px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; }
        .tag-pill { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: white; margin-right: 4px; margin-bottom: 2px; }

        /* UTILS */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 15px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        th { text-align: left; padding: 16px; background: #F9FAFB; font-weight: 600; border-bottom: 1px solid var(--border); }
        td { padding: 14px 16px; border-bottom: 1px solid #F1F5F9; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal { background: white; width: 90%; max-width: 450px; padding: 30px; border-radius: 16px; }
        #context-menu { position: absolute; display: none; background: white; border: 1px solid var(--border); z-index: 1000; border-radius: 8px; width: 160px; }
        .cm-item { padding: 10px 16px; cursor: pointer; font-size: 13px; display: flex; gap: 10px; } .cm-item:hover { background: #F3F4F6; }
    </style>
</head>
<body onclick="hideContextMenu()">

    <div id="context-menu">
        <div class="cm-item" onclick="cmAction('pin')"><i class="fas fa-thumbtack"></i> Fijar</div>
        <div class="cm-item" onclick="cmAction('archive')"><i class="fas fa-archive"></i> Archivar</div>
        <div class="cm-item" onclick="cmAction('delete')" style="color:red;"><i class="fas fa-trash"></i> Eliminar</div>
    </div>

    <div class="sidebar">
        <div class="logo-area" onclick="nav('config')"><img id="sidebar-logo-img" src="" style="width:100%; height:100%; object-fit:contain;"></div>
        <div class="nav-item active" onclick="nav('dashboard')" id="nav-dashboard"><i class="fas fa-chart-pie"></i></div>
        <div class="nav-item" onclick="nav('chat')" id="nav-chat"><i class="fas fa-comment-dots"></i></div>
        <div class="nav-item" onclick="nav('leads')" id="nav-leads"><i class="fas fa-users"></i></div>
        <div class="nav-item" onclick="nav('inventory')" id="nav-inventory"><i class="fas fa-box-open"></i></div>
        <div class="nav-item" onclick="nav('config')" id="nav-config"><i class="fas fa-cog"></i></div>
        <div class="nav-item" onclick="nav('sandbox')" id="nav-sandbox"><i class="fas fa-terminal"></i></div>
        <div style="flex:1"></div>
        <div class="nav-item" onclick="location.href='/logout'" style="color:#EF4444;"><i class="fas fa-power-off"></i></div>
    </div>

    <div class="main-content">

        <div id="view-dashboard" class="view active page-container">
            <h1>Visi√≥n General</h1>
            <div class="kpi-grid">
                <div class="kpi-card"><i class="fas fa-users" style="font-size:20px; color:var(--primary);"></i><div><h2 id="kpi-leads">0</h2><p>Leads</p></div></div>
                <div class="kpi-card"><i class="fas fa-comments" style="font-size:20px; color:var(--primary);"></i><div><h2 id="kpi-chats">0</h2><p>Chats</p></div></div>
                <div class="kpi-card"><i class="fas fa-cube" style="font-size:20px; color:var(--primary);"></i><div><h2 id="kpi-stock">0</h2><p>Stock</p></div></div>
            </div>
            <div class="card">
                <h3>Leads Recientes</h3>
                <div style="overflow-x:auto;"><table id="dash-leads-table"><thead><tr><th>Cliente</th><th>Ciudad</th><th>Inter√©s</th></tr></thead><tbody id="dash-leads-body"></tbody></table></div>
            </div>
        </div>

        <div id="view-chat" class="view">
            <div class="chat-layout">
                <div class="cl-panel">
                    <div class="cl-header">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <h3>Mensajer√≠a</h3><button class="btn" style="padding:5px 10px;" onclick="addContactPrompt()">+ Nuevo</button>
                        </div>
                        <input id="search" class="form-control" placeholder="Buscar..." oninput="renderChatList()">
                        <div class="cl-tools">
                            <select id="view-selector" class="form-control" style="margin:0;" onchange="syncLoop(true)"><option value="active">Activos</option><option value="unread">No Le√≠dos</option></select>
                        </div>
                    </div>
                    <div class="cl-list" id="chat-list-box"><div style="padding:20px; text-align:center; color:#999;">Cargando...</div></div>
                </div>
                
                <div class="ca-panel">
                    <div class="chat-bg-pattern"></div>
                    <div id="chat-placeholder" style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#aaa; z-index:10;">
                        <i class="fas fa-comments" style="font-size:60px; margin-bottom:20px; color:#ddd;"></i><h3>Selecciona un chat</h3>
                    </div>
                    <div id="chat-interface" style="display:none; flex-direction:column; height:100%; z-index:10;">
                        <div class="ca-header">
                            <div style="display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="toggleCrmPanel()">
                                <div class="avatar" id="header-avatar"></div>
                                <div><div id="active-name" style="font-weight:600;">Chat</div><div id="active-phone" style="font-size:12px;">...</div></div>
                            </div>
                            <button class="btn-icon" onclick="toggleCrmPanel()"><i class="fas fa-columns"></i></button>
                        </div>
                        <div class="messages-box" id="msgs-box"></div>
                        <div class="input-area">
                            <button class="btn-icon" onclick="document.getElementById('file-input').click()"><i class="fas fa-paperclip"></i></button>
                            <input type="file" id="file-input" hidden onchange="handleFileUpload(this)">
                            <input id="msg-input" class="form-control" style="margin:0; border-radius:20px;" placeholder="Escribe..." onkeypress="if(event.key==='Enter') sendMsg()">
                            <button class="btn-icon" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>

                <div class="crm-panel" id="crm-panel">
                    <div class="crm-header">
                        <div class="avatar" id="prof-avatar" style="width:80px; height:80px; margin:0 auto 10px; font-size:30px;"></div>
                        <h3 id="prof-name">Nombre</h3>
                        <p id="prof-phone">...</p>
                        <button id="prof-bot-btn" class="btn" style="width:100%; margin-top:10px;" onclick="toggleBot()">BOT</button>
                    </div>
                    <div class="crm-body">
                        <div class="crm-stat"><strong>Ciudad:</strong> <span id="prof-city">-</span></div>
                        <div class="crm-stat"><strong>Inter√©s:</strong> <span id="prof-interest">-</span></div>
                        <h4>Etiquetas</h4>
                        <div id="prof-tags" style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;"></div>
                        <button class="btn-outline" style="width:100%; padding:5px;" onclick="openTagSelector()">Gestionar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-leads" class="view page-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h1>Leads</h1><button class="btn" onclick="downloadLeadsExcel()">Excel</button></div>
            <div class="card" style="padding:0; overflow:hidden;"><div style="overflow-x:auto;"><table><thead><tr><th>Nombre</th><th>Ciudad</th><th>Inter√©s</th><th>Acci√≥n</th></tr></thead><tbody id="leads-body"></tbody></table></div></div>
        </div>

        <div id="view-inventory" class="view page-container">
            <h1>Inventario</h1>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="card">
                    <h3>Productos</h3>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <input type="file" id="csv-file" class="form-control" style="margin:0;">
                        <button class="btn" onclick="uploadCSV()">Subir</button>
                        <button class="btn" style="background:#EF4444;" onclick="limpiarInventario()">Borrar Todo</button>
                    </div>
                    <div style="flex:1; overflow-y:auto; border:1px solid #eee;"><table style="font-size:12px;"><tbody id="inv-body"></tbody></table></div>
                </div>
                <div class="card">
                    <h3>Contexto Negocio</h3>
                    <textarea id="biz-web" class="form-control" style="flex:1; resize:none;"></textarea>
                    <button class="btn" onclick="saveBizConfig()">Guardar</button>
                </div>
            </div>
        </div>

        <div id="view-config" class="view page-container">
            <h1>Configuraci√≥n</h1>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap:20px;">
                <div class="card" style="border-left: 4px solid var(--primary);">
                    <h3>üß† Personalidad</h3>
                    <textarea id="bot-prompt" class="form-control" style="height:200px; font-family:'Fira Code'; font-size:12px;"></textarea>
                    <div style="text-align:right;"><button class="btn" onclick="savePrompt()">Guardar</button></div>
                </div>
                
                <div class="card">
                    <h3>üè¢ Identidad</h3>
                    <div style="display:flex; gap:10px; margin:10px 0;">
                        <img id="preview-logo" style="width:50px; display:none;">
                        <button class="btn-outline" onclick="document.getElementById('logo-upload').click()">Logo</button>
                        <input type="file" id="logo-upload" hidden onchange="uploadLogo()">
                    </div>
                    <input id="biz-name" class="form-control" placeholder="Nombre">
                    <input id="biz-hours" class="form-control" placeholder="Horario">
                    <button class="btn" onclick="saveBizConfig()">Actualizar</button>
                </div>

                <div class="card">
                    <h3>‚ûï Automatizaci√≥n</h3>
                    
                    <div style="margin-bottom:15px;">
                        <label style="font-size:12px; font-weight:bold;">Etiquetas</label>
                        <div style="display:flex; gap:5px;">
                            <input id="new-tag-name" class="form-control" placeholder="Nombre" style="margin:0;">
                            <input type="color" id="new-tag-color" style="height:38px; width:40px; border:none;">
                            <button class="btn" onclick="addGlobalTag()">+</button>
                        </div>
                        <div id="tags-viewer-list" class="scrollable-list"></div>
                    </div>

                    <div style="margin-bottom:15px;">
                        <label style="font-size:12px; font-weight:bold;">Reglas T√©cnicas</label>
                        <div style="display:flex; gap:5px;">
                            <input id="rule-input" class="form-control" placeholder="Ej: PC200 es Komatsu" style="margin:0;">
                            <button class="btn" onclick="addRule()">+</button>
                        </div>
                        <div id="rules-list" class="scrollable-list"></div>
                    </div>

                    <div>
                        <label style="font-size:12px; font-weight:bold;">Atajos</label>
                        <div style="display:flex; gap:5px;">
                            <input id="new-sc-key" class="form-control" placeholder="/clave" style="width:80px; margin:0;">
                            <input id="new-sc-text" class="form-control" placeholder="Mensaje..." style="margin:0;">
                            <button class="btn" onclick="addShortcut()">+</button>
                        </div>
                        <div id="shortcuts-list" class="scrollable-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-sandbox" class="view page-container">
            <h1>Laboratorio</h1>
            <div class="card" style="background:#1e1e1e; color:#0f0; font-family:monospace;">
                <div style="display:flex; gap:10px; border-bottom:1px solid #333; padding-bottom:10px; margin-bottom:10px;">
                    <input id="sand-in" style="background:#333; border:none; color:white; flex:1; padding:5px;" placeholder="Simular mensaje cliente..." onkeypress="if(event.key==='Enter') runTest()">
                    <button class="btn" onclick="runTest()">Enviar</button>
                </div>
                <div id="sand-log" style="height:400px; overflow-y:auto;">// Esperando comandos...</div>
            </div>
        </div>

    </div> 

    <div id="modal-tag-selector" class="modal-overlay" onclick="closeModal('modal-tag-selector')">
        <div class="modal" onclick="event.stopPropagation()"><h3>Etiquetas</h3><div id="tag-selector-list" class="scrollable-list"></div></div>
    </div>
    <div id="modal-edit-lead" class="modal-overlay"><div class="modal"><h3>Editar Lead</h3><input id="edit-lead-id" type="hidden"><label>Nombre</label><input id="edit-lead-name" class="form-control"><label>Ciudad</label><input id="edit-lead-city" class="form-control"><label>Inter√©s</label><input id="edit-lead-interest" class="form-control"><label>Correo</label><input id="edit-lead-email" class="form-control"><label>Estado</label><select id="edit-lead-tag" class="form-control"><option value="Pendiente">Pendiente</option><option value="Lead">Lead</option><option value="Cotizaci√≥n">Cotizaci√≥n</option><option value="Vendido">Vendido</option></select><div style="text-align:right;"><button class="btn-outline" onclick="closeModal('modal-edit-lead')">Cancelar</button><button class="btn" onclick="saveLeadChanges()">Guardar</button></div></div></div>

    <script>
        let chats=[], selectedId=null, globalTags=[], shortcuts=[], allLeads=[], contextMenuChatId=null;

        async function init() {
            await loadGlobalData();
            nav('dashboard');
            setInterval(() => syncLoop(), 2500); 
        }

        function nav(v) {
            document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            document.getElementById('nav-'+v).classList.add('active');
            if(v==='chat') syncLoop(true);
            if(v==='leads') loadLeads();
            if(v==='inventory') loadInventory();
            if(v==='dashboard') loadDash();
            if(v==='config') loadGlobalData();
        }

        async function loadGlobalData() {
            try {
                // CONFIGURACI√ìN (Evitar que se queden en blanco)
                const conf = await fetch('/api/data/config').then(r=>r.json());
                if(conf) {
                    if(conf.logo_url) document.getElementById('sidebar-logo-img').src = conf.logo_url;
                    document.getElementById('biz-name').value = conf.biz_profile?.name || '';
                    document.getElementById('biz-hours').value = conf.biz_profile?.hours || '';
                    document.getElementById('biz-web').value = conf.website_data || '';
                    
                    // REGLAS (Restauradas)
                    if(conf.tech_rules) renderRules(conf.tech_rules);
                }
                const p = await fetch('/api/config/prompt').then(r=>r.json());
                document.getElementById('bot-prompt').value = p.prompt || "";
                
                globalTags = await fetch('/api/data/tags').then(r=>r.json()) || [];
                renderGlobalTags();
                shortcuts = await fetch('/api/data/shortcuts').then(r=>r.json()) || [];
                renderShortcuts();
            } catch(e){}
        }

        /* --- CHAT SYSTEM (FIXED - NO PARPADEO - INSTANT LOAD) --- */
        async function syncLoop(force=false) {
            try {
                const res = await fetch(`/api/chats-full`);
                const data = await res.json();
                
                data.sort((a,b) => (b.pinned - a.pinned) || (new Date(b.timestamp) - new Date(a.timestamp)));

                if(force || JSON.stringify(data) !== JSON.stringify(chats)) {
                    chats = data;
                    renderChatList();
                }

                if(selectedId) {
                    const current = chats.find(c => c.id === selectedId);
                    if(current) {
                        if(current.unreadCount > 0) await fetch(`/api/chat-history/${selectedId}`);
                        renderBotStatus(current.botActive);
                    }
                    const msgs = await fetch(`/api/chat-history/${selectedId}`).then(r=>r.json());
                    renderMsgs(msgs);
                }
            } catch(e){}
        }

        function renderChatList() {
            const list = document.getElementById('chat-list-box');
            const q = document.getElementById('search').value.toLowerCase();
            list.innerHTML = chats.filter(c => (c.name||c.id).toLowerCase().includes(q)).map(c => `
                <div class="chat-item ${c.id===selectedId?'active':''}" onclick="selChat('${c.id}')" oncontextmenu="showContextMenu(event,'${c.id}')">
                    <div class="avatar" style="${c.photoUrl?`background-image:url('${c.photoUrl}')`:''}">${!c.photoUrl?'<i class="fas fa-user"></i>':''}</div>
                    <div style="flex:1; overflow:hidden;">
                        <div style="display:flex; justify-content:space-between;"><span style="font-weight:600; font-size:14px;">${c.name}</span><span style="font-size:11px; color:#999;">${new Date(c.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span></div>
                        <div style="font-size:12px; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; ${c.unreadCount>0?'font-weight:700;':''}">${c.lastMessage.text}</div>
                        <div style="margin-top:4px;">${(c.labels||[]).map(l=>`<span class="tag-pill" style="background:${getTagColor(l)}; margin-right:4px;">${l}</span>`).join('')}</div>
                    </div>
                    ${c.unreadCount>0?`<div style="background:var(--primary); color:white; font-size:10px; padding:2px 6px; border-radius:10px; height:fit-content;">${c.unreadCount}</div>`:''}
                </div>
            `).join('');
        }

        // --- SOLUCI√ìN CR√çTICA: LIMPIEZA INMEDIATA AL CAMBIAR DE CHAT ---
        function selChat(id) {
            if(selectedId === id) return; // Evita recarga si ya est√°s ah√≠
            
            selectedId = id;
            
            // 1. Ocultar contenido viejo INMEDIATAMENTE
            document.getElementById('msgs-box').innerHTML = '<div style="text-align:center; padding:30px; color:#999;"><i class="fas fa-spinner fa-spin"></i> Cargando conversaci√≥n...</div>';
            
            // 2. Llenar datos de cabecera
            const c = chats.find(x=>x.id===id);
            if(!c) return;

            document.getElementById('chat-placeholder').style.display='none';
            document.getElementById('chat-interface').style.display='flex';
            document.getElementById('active-name').innerText=c.name;
            document.getElementById('active-phone').innerText=id;
            document.getElementById('header-avatar').style.backgroundImage=c.photoUrl?`url('${c.photoUrl}')`:'';
            document.getElementById('prof-avatar').style.backgroundImage=c.photoUrl?`url('${c.photoUrl}')`:'';
            document.getElementById('prof-name').innerText=c.name;
            document.getElementById('prof-phone').innerText=id;
            
            fetchLeadInfo(id); renderBotStatus(c.botActive); renderChatTags(c.labels||[]);
            
            // 3. Forzar sync
            syncLoop(true);
        }

        // --- SOLUCI√ìN CR√çTICA: RENDERIZADO POR INYECCI√ìN (NO PARPADEO) ---
        function renderMsgs(msgs) {
            const box = document.getElementById('msgs-box');
            
            // Si el cuadro tiene el mensaje de "Cargando", lo limpiamos
            if(box.innerText.includes('Cargando')) box.innerHTML = '';
            if(!msgs || msgs.length === 0) { box.innerHTML='<div style="text-align:center; padding:20px; color:#999;">Nuevo chat</div>'; return; }

            msgs.forEach(m => {
                const divId = `msg-${m.id}`;
                // SI YA EXISTE, NO HACER NADA (ESTO EVITA EL PARPADEO)
                if(document.getElementById(divId)) return;

                const div = document.createElement('div');
                div.id = divId;
                div.className = `bubble ${m.role==='user'?'b-user':(m.role==='bot'?'b-bot':'b-manual')} msg-anim`; // Clase de animaci√≥n
                
                let txt = m.text;
                if(txt.includes('MEDIA:IMAGE')) txt = `<img src="/api/media-proxy/${txt.match(/IMAGE:(.*?)\]/)[1]}" style="max-width:200px; border-radius:8px;">`;
                
                div.innerHTML = `${txt}<div class="msg-time">${new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>`;
                box.appendChild(div);
                
                // Scroll autom√°tico al final
                box.scrollTop = box.scrollHeight;
            });
        }

        async function fetchLeadInfo(phone) { try { const ls=await fetch('/api/data/leads').then(r=>r.json()); const l=ls.find(x=>x.phone===phone); document.getElementById('prof-city').innerText=l?l.ciudad:'-'; document.getElementById('prof-interest').innerText=l?l.interes:'-'; } catch(e){} }

        /* --- CONFIGURACI√ìN & REGLAS (CORREGIDO) --- */
        function renderRules(rules) { document.getElementById('rules-list').innerHTML = rules.map((r, i) => `<div style="padding:5px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;"><span>${r}</span><i class="fas fa-trash" style="color:red; cursor:pointer;" onclick="deleteRule(${i})"></i></div>`).join(''); }
        async function addRule() { const r=document.getElementById('rule-input').value; if(!r) return; await fetch('/api/config/rules/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({rule:r})}); document.getElementById('rule-input').value=''; loadGlobalData(); }
        async function deleteRule(i) { if(confirm("¬øBorrar?")) { await fetch('/api/config/rules/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:i})}); loadGlobalData(); } }
        
        function renderGlobalTags() { document.getElementById('tags-viewer-list').innerHTML = globalTags.map(t=>`<span class="tag-pill" style="background:${t.color}; cursor:pointer;" onclick="deleteTag(${t.id})">${t.name}</span>`).join(''); }
        async function addGlobalTag() { const n=document.getElementById('new-tag-name').value; const c=document.getElementById('new-tag-color').value; if(!n) return; await fetch('/api/tags/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,color:c})}); loadGlobalData(); }
        async function deleteTag(id) { if(confirm("¬øBorrar?")) { await fetch('/api/tags/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); loadGlobalData(); } }

        function renderShortcuts() { document.getElementById('shortcuts-list').innerHTML = shortcuts.map(s => `<div style="padding:5px; border-bottom:1px solid #eee;"><b>/${s.keyword}</b>: ${s.text.substring(0,30)}... <i class="fas fa-trash" style="color:red; float:right; cursor:pointer;" onclick="deleteShortcut(${s.id})"></i></div>`).join(''); }
        async function addShortcut() { const k=document.getElementById('new-sc-key').value; const t=document.getElementById('new-sc-text').value; await fetch('/api/shortcuts/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({keyword:k,text:t})}); loadGlobalData(); }
        async function deleteShortcut(id) { if(confirm("¬øBorrar?")) { await fetch('/api/shortcuts/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id})}); loadGlobalData(); } }

        /* --- ACCIONES --- */
        async function sendMsg() { const m=document.getElementById('msg-input').value; if(!m) return; document.getElementById('msg-input').value=''; await fetch('/api/chat/send',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:selectedId,message:m})}); syncLoop(true); }
        async function handleFileUpload(inp) { if(!inp.files[0]||!selectedId) return; const fd=new FormData(); fd.append('file',inp.files[0]); fd.append('phone',selectedId); fd.append('type',inp.files[0].type.includes('image')?'image':'document'); await fetch('/api/chat/upload-send',{method:'POST',body:fd}); inp.value=''; syncLoop(true); }
        async function savePrompt() { await fetch('/api/config/prompt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:document.getElementById('bot-prompt').value})}); alert("Guardado"); }
        async function saveBizConfig() { const n=document.getElementById('biz-name').value; const h=document.getElementById('biz-hours').value; const w=document.getElementById('biz-web').value; await fetch('/api/config/biz/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,hours:h,website_data:w})}); alert("Guardado"); }
        async function uploadLogo() { const f=document.getElementById('logo-upload').files[0]; if(!f) return; const fd=new FormData(); fd.append('file',f); await fetch('/api/config/logo',{method:'POST',body:fd}); loadGlobalData(); }
        async function loadInventory() { try { const d = await fetch('/api/data/knowledge').then(r=>r.json()); document.getElementById('inv-body').innerHTML = d.map((p,i)=>`<tr><td>${p.searchable}</td><td style="color:red; cursor:pointer;" onclick="deleteProduct(${i})"><i class="fas fa-trash"></i></td></tr>`).join(''); } catch(e){} }
        async function deleteProduct(i) { if(confirm("¬øEliminar?")) await fetch('/api/knowledge/delete',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({index:i})}); loadInventory(); }
        async function limpiarInventario() { if(confirm("¬øBORRAR TODO EL INVENTARIO?")) { await fetch('/api/knowledge/clear',{method:'POST'}); loadInventory(); } }
        async function uploadCSV() { const f = document.getElementById('csv-file').files[0]; if(!f) return; const fd = new FormData(); fd.append('file',f); await fetch('/api/knowledge/csv',{method:'POST',body:fd}); loadInventory(); alert("Cargado"); }
        function toggleCrmPanel() { document.getElementById('crm-panel').classList.toggle('closed'); }
        async function toggleBot() { const c=chats.find(x=>x.id===selectedId); await fetch('/api/chat/toggle-bot',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:selectedId,active:!c.botActive})}); syncLoop(true); }
        function renderBotStatus(a) { const b=document.getElementById('prof-bot-btn'); b.innerText=a?"BOT ACTIVO":"BOT PAUSADO"; b.style.background=a?'#DCFCE7':'#FEE2E2'; b.style.color=a?'#166534':'#991B1B'; }
        function addContactPrompt() { const p=prompt("N√∫mero:"); if(p) fetch('/api/contacts/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:p,name:p})}).then(()=>syncLoop(true)); }
        function getTagColor(n) { const t=globalTags.find(x=>x.name===n); return t?t.color:'#ccc'; }
        function openTagSelector() { document.getElementById('tag-selector-list').innerHTML = globalTags.map(t=>`<div style="padding:5px; cursor:pointer;" onclick="toggleChatTag('${t.name}')"><span class="tag-pill" style="background:${t.color}">${t.name}</span></div>`).join(''); document.getElementById('modal-tag-selector').style.display='flex'; }
        async function toggleChatTag(n) { const c=chats.find(x=>x.id===selectedId); let tags=c.labels||[]; if(tags.includes(n)) tags=tags.filter(x=>x!==n); else tags.push(n); await fetch('/api/chat/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:selectedId,action:'set_labels',value:tags})}); document.getElementById('modal-tag-selector').style.display='none'; syncLoop(true); renderChatTags(tags); }
        function renderChatTags(tags) { document.getElementById('prof-tags').innerHTML = tags.map(t=>`<span class="tag-pill" style="background:${getTagColor(t)}">${t}</span>`).join(''); }
        function copyToClip(t) { navigator.clipboard.writeText(t); alert("Copiado"); }
        function showContextMenu(e, id) { e.preventDefault(); contextMenuChatId=id; const m=document.getElementById('context-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; }
        function hideContextMenu() { document.getElementById('context-menu').style.display='none'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function callUser() { if(selectedId) window.open(`tel:${selectedId}`); }
        async function cmAction(a) { await fetch('/api/chat/action',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:contextMenuChatId,action:a,value:true})}); syncLoop(true); }
        async function runTest() { const m=document.getElementById('sand-in').value; if(!m)return; document.getElementById('sand-chat').innerHTML+=`<div><b>Tu:</b> ${m}</div>`; document.getElementById('sand-in').value=''; const r=await fetch('/api/test-ai',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:m})}).then(x=>x.json()); document.getElementById('sand-chat').innerHTML+=`<div><b>Bot:</b> ${r.response}</div>`; document.getElementById('sand-log').innerText=JSON.stringify(r,null,2); }
        async function loadDash() { try { const [l,c,s] = await Promise.all([ fetch('/api/data/leads').then(r=>r.json()), fetch('/api/chats-full').then(r=>r.json()), fetch('/api/data/knowledge').then(r=>r.json()) ]); document.getElementById('kpi-leads').innerText = l.length; document.getElementById('kpi-chats').innerText = c.length; document.getElementById('kpi-stock').innerText = s.length; document.getElementById('dash-leads-body').innerHTML = l.slice(0,5).map(x => `<tr><td>${x.nombre}</td><td>${x.ciudad}</td><td>${x.interes}</td></tr>`).join(''); } catch(e){} }
        async function downloadLeadsExcel() { try { const r=await fetch('/api/data/leads').then(x=>x.json()); const ws=XLSX.utils.json_to_sheet(r); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Leads"); XLSX.writeFile(wb,"Leads.xlsx"); }catch(e){alert("Error");} }

        window.onload = init;
    </script>
</body>
</html>
