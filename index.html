<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICC | Lorena IA - Panel de Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --naranja: #FF8C00;
            --dark-bg: #2c3e50;
            --light-bg: #ecf0f1;
            --whatsapp: #25D366;
            --success: #27ae60;
            --danger: #e74c3c;
        }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--light-bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: white; display: flex; flex-direction: column; border-right: 1px solid #ddd; z-index: 10; }
        .logo-box { padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: #999; padding: 20px 20px 10px; letter-spacing: 1px; }
        .nav-item { padding: 12px 20px; cursor: pointer; color: #555; transition: 0.3s; display: flex; align-items: center; gap: 10px; font-size: 14px; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: #f8f9fa; color: var(--naranja); border-right: 4px solid var(--naranja); }
        .nav-item i { width: 20px; text-align: center; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .view { display: none; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #ddd; }
        h2 { margin-top: 0; color: var(--dark-bg); font-weight: 700; margin-bottom: 25px; }
        h3 { margin: 0 0 15px 0; font-size: 16px; color: #7f8c8d; text-transform: uppercase; }

        /* BUTTONS & INPUTS */
        .btn { background: var(--naranja); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; font-family: inherit; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-manual { background: var(--whatsapp); }
        .btn-danger { background: var(--danger); }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; margin-bottom: 10px; }

        /* CHAT CENTER PROFESIONAL */
        .chat-container { display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 180px); background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .chat-list { border-right: 1px solid #eee; overflow-y: auto; background: #fff; }
        .chat-user { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; display: flex; gap: 12px; align-items: center; transition: 0.2s; }
        .chat-user:hover, .chat-user.active { background: #f0f2f5; }
        
        .chat-main { display: flex; flex-direction: column; background-color: #e5ddd5; position: relative; }
        .chat-header { padding: 10px 20px; background: #eee; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
        
        /* BUBBLES */
        .bubble { max-width: 75%; padding: 8px 12px; border-radius: 8px; font-size: 13.5px; margin-bottom: 5px; line-height: 1.4; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .user-row { align-self: flex-start; background: white; color: #333; }
        .bot-row { align-self: flex-end; background: #dcf8c6; color: #333; }
        .manual-row { align-self: flex-end; background: #cfe9ff; color: #333; border: 1px solid #a6d5ff; }

        .chat-footer { padding: 15px; background: #f0f0f0; display: flex; gap: 10px; align-items: center; }

        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 15px; background: #f8f9fa; color: #7f8c8d; font-weight: 600; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; color: #555; }
        
        .terminal { background: #1e1e1e; color: #0f0; padding: 15px; border-radius: 6px; font-family: monospace; height: 120px; overflow-y: auto; font-size: 12px; }
    </style>
</head>
<body>

    <div id="toast" style="position: fixed; top: 20px; right: 20px; background: var(--dark-bg); color: white; padding: 15px 25px; border-radius: 8px; border-left: 5px solid var(--naranja); transform: translateX(200%); transition: 0.5s; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <i class="fas fa-check-circle"></i> <span id="toast-msg">Acci贸n realizada</span>
    </div>

    <div class="sidebar">
        <div class="logo-box">
            <h2 style="margin:0; color:var(--naranja);">ICC <span style="color:#333;">ADMIN</span></h2>
        </div>
        <div class="nav-label">Gesti贸n Comercial</div>
        <div class="nav-item active" onclick="navTo('dashboard', this)"><i class="fas fa-chart-pie"></i> Resumen</div>
        <div class="nav-item" onclick="navTo('whatsapp', this)"><i class="fab fa-whatsapp"></i> Chat Center</div>
        <div class="nav-item" onclick="navTo('leads', this)"><i class="fas fa-users"></i> Base de Leads</div>
        <div class="nav-label">Configuraci贸n</div>
        <div class="nav-item" onclick="navTo('integraciones', this)"><i class="fas fa-plug"></i> Integraciones</div>
        <div class="nav-item" onclick="navTo('cerebro', this)"><i class="fas fa-brain"></i> Entrenamiento</div>
        <div class="nav-item" onclick="navTo('tester', this)"><i class="fas fa-robot"></i> Laboratorio</div>
        <div style="margin-top: auto; padding-bottom: 20px;">
            <a href="/logout" class="nav-item" style="color: #e74c3c;"><i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n</a>
        </div>
    </div>

    <div class="main-content">
        <div id="dashboard" class="view active">
            <h2><i class="fas fa-tachometer-alt" style="color:var(--naranja)"></i> Panel Ejecutivo</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div class="card" style="border-top-color: var(--success);">
                    <h3>Leads Capturados</h3>
                    <h1 id="kpi-leads">0</h1>
                </div>
                <div class="card" style="border-top-color: var(--naranja);">
                    <h3>Stock Sincronizado</h3>
                    <h1 id="kpi-stock">0</h1>
                </div>
                <div class="card" style="border-top-color: #3498db;">
                    <h3>Estado IA</h3>
                    <h1 style="font-size: 20px; color: #27ae60;"> ONLINE (v2.0)</h1>
                </div>
            </div>
        </div>

        <div id="whatsapp" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2><i class="fab fa-whatsapp" style="color:var(--whatsapp)"></i> Chat Center</h2>
                <div id="bot-status-indicator"></div>
            </div>
            
            <div class="chat-container">
                <div class="chat-list" id="chat-list-sidebar"></div>
                <div class="chat-main">
                    <div class="chat-header" id="chat-header-info">
                        <span id="target-phone">Seleccione un cliente</span>
                        <div id="chat-controls" style="display:none;">
                            <button id="btn-toggle-bot" class="btn" onclick="toggleBot()">
                                <i class="fas fa-robot"></i> Pausar IA
                            </button>
                        </div>
                    </div>
                    <div id="active-chat-box" style="flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column;">
                        <div style="text-align:center; margin-top:100px; color:#666;">Seleccione un chat para intervenir.</div>
                    </div>
                    <div class="chat-footer" id="footer-chat" style="display:none;">
                        <input type="text" id="input-manual" placeholder="Escribe un mensaje manual a WhatsApp..." onkeypress="if(event.key==='Enter') enviarManual()">
                        <button class="btn btn-manual" onclick="enviarManual()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="leads" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2><i class="fas fa-database"></i> Base de Leads</h2>
                <button class="btn" style="background: #217346;" onclick="exportarExcel()"><i class="fas fa-file-excel"></i> Excel</button>
            </div>
            <div class="card" style="padding:0; margin-top:20px;">
                <table>
                    <thead><tr><th>Fecha</th><th>Nombre</th><th>Tel茅fono</th><th>Inter茅s</th></tr></thead>
                    <tbody id="leads-body"></tbody>
                </table>
            </div>
        </div>

        <div id="cerebro" class="view">
            <h2><i class="fas fa-brain"></i> Entrenamiento</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="card">
                    <h3>Reglas de Negocio</h3>
                    <textarea id="context-area" rows="10"></textarea>
                    <button class="btn" style="width:100%;" onclick="guardarContexto()">Guardar</button>
                </div>
                <div class="card">
                    <h3>Importar CSV</h3>
                    <input type="file" id="csv-upload" accept=".csv">
                    <button class="btn" style="width:100%; margin-top:10px;" onclick="subirCSV()">Procesar</button>
                    <h3 style="margin-top:20px;">Logs</h3>
                    <div class="terminal" id="sys-logs">> Listo...</div>
                </div>
            </div>
        </div>

        <div id="tester" class="view">
            <h2>Laboratorio</h2>
            <div class="chat-container" style="grid-template-columns: 1fr;">
                <div class="chat-main">
                    <div id="test-msgs" style="flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column;"></div>
                    <div class="chat-footer">
                        <input type="text" id="test-input" placeholder="Mensaje de prueba..." onkeypress="if(event.key==='Enter') testBot()">
                        <button class="btn" onclick="testBot()"><i class="fas fa-flask"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let activeChatPhone = null;
        let isBotActive = true;
        let refreshInterval = null;

        function navTo(viewId, element) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(element) element.classList.add('active');
            if(refreshInterval) clearInterval(refreshInterval);

            if(viewId === 'dashboard') loadStats();
            if(viewId === 'leads') loadLeads();
            if(viewId === 'cerebro') loadConfig();
            if(viewId === 'whatsapp') {
                loadWhatsApp();
                refreshInterval = setInterval(loadWhatsApp, 4000);
            }
        }

        async function loadWhatsApp() {
            try {
                const res = await fetch('/api/data/history');
                const history = await res.json();
                const list = document.getElementById('chat-list-sidebar');
                const numbers = Object.keys(history).reverse(); // Mas recientes arriba

                list.innerHTML = numbers.map(num => `
                    <div class="chat-user ${activeChatPhone === num ? 'active' : ''}" onclick="selectChat('${num}')">
                        <div style="width:40px;height:40px;background:var(--naranja);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;"><i class="fas fa-user"></i></div>
                        <div><div style="font-weight:700">${num}</div><div style="font-size:11px;color:#888;">${history[num][history[num].length-1].text.substring(0,20)}...</div></div>
                    </div>
                `).join('');

                if(activeChatPhone) renderMessages(history[activeChatPhone]);
            } catch(e) {}
        }

        async function selectChat(phone) {
            activeChatPhone = phone;
            document.getElementById('target-phone').innerText = "Chateando con: " + phone;
            document.getElementById('chat-controls').style.display = 'block';
            document.getElementById('footer-chat').style.display = 'flex';
            
            // Verificar estado del bot para este cliente
            const res = await fetch(`/api/chat/status/${phone}`);
            const data = await res.json();
            updateBotUI(data.active);
            loadWhatsApp();
        }

        function updateBotUI(active) {
            isBotActive = active;
            const btn = document.getElementById('btn-toggle-bot');
            if(active) {
                btn.innerHTML = '<i class="fas fa-robot"></i> Pausar Lorena';
                btn.className = "btn";
            } else {
                btn.innerHTML = '<i class="fas fa-user"></i> Retomar IA';
                btn.className = "btn btn-danger";
            }
        }

        async function toggleBot() {
            if(!activeChatPhone) return;
            const nuevoEstado = !isBotActive;
            await fetch('/api/chat/toggle-bot', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ phone: activeChatPhone, active: nuevoEstado })
            });
            updateBotUI(nuevoEstado);
            showToast(nuevoEstado ? "Lorena retom贸 el control" : "Lorena en pausa. Modo manual activo");
        }

        async function enviarManual() {
            const input = document.getElementById('input-manual');
            const msg = input.value.trim();
            if(!msg || !activeChatPhone) return;

            const res = await fetch('/api/chat/send', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ phone: activeChatPhone, message: msg })
            });

            if(res.ok) {
                input.value = '';
                loadWhatsApp();
            }
        }

        function renderMessages(msgs) {
            const box = document.getElementById('active-chat-box');
            box.innerHTML = msgs.map(m => {
                let cls = 'user-row';
                if(m.role === 'bot') cls = 'bot-row';
                if(m.role === 'manual') cls = 'manual-row';
                return `<div class="bubble ${cls}">${m.text}</div>`;
            }).join('');
            box.scrollTop = box.scrollHeight;
        }

        // Resto de funciones (Leads, CSV, Stats) permanecen igual que tu versi贸n
        async function loadStats() {
            const leads = await fetch('/api/data/leads').then(r => r.json());
            const knowledge = await fetch('/api/data/knowledge').then(r => r.json());
            document.getElementById('kpi-leads').innerText = leads.length;
            document.getElementById('kpi-stock').innerText = knowledge.length;
        }

        async function loadLeads() {
            const data = await fetch('/api/data/leads').then(r => r.json());
            document.getElementById('leads-body').innerHTML = data.map(l => `
                <tr><td>${l.fecha}</td><td>${l.nombre||'N/A'}</td><td>${l.telefono}</td><td>${l.interes||'Inter茅s'}</td></tr>
            `).join('');
        }

        async function loadConfig() {
            const config = await fetch('/api/data/config').then(r => r.json());
            document.getElementById('context-area').value = config.tech_rules || '';
        }

        async function guardarContexto() {
            await fetch('/save-context', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({context: document.getElementById('context-area').value})
            });
            showToast("Guardado con 茅xito");
        }

        async function subirCSV() {
            const fd = new FormData(); fd.append('file', document.getElementById('csv-upload').files[0]);
            const res = await fetch('/api/knowledge/csv', { method:'POST', body: fd });
            const d = await res.json();
            showToast("Inventario cargado: " + d.count);
        }

        async function testBot() {
            const inp = document.getElementById('test-input');
            const box = document.getElementById('test-msgs');
            const txt = inp.value;
            box.innerHTML += `<div class="bubble user-row">${txt}</div>`;
            const res = await fetch('/webhook', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ message: txt })
            });
            const d = await res.json();
            box.innerHTML += `<div class="bubble bot-row">${d.reply}</div>`;
            inp.value = '';
            box.scrollTop = box.scrollHeight;
        }

        function showToast(m) {
            document.getElementById('toast-msg').innerText = m;
            const t = document.getElementById('toast');
            t.style.transform = "translateX(0)";
            setTimeout(() => t.style.transform = "translateX(200%)", 3000);
        }

        window.onload = loadStats;
    </script>
</body>
</html>
