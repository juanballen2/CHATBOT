<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICC | Lorena IA - Panel de Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="toast" style="position: fixed; top: 20px; right: 20px; background: var(--dark-bg); color: white; padding: 15px 25px; border-radius: 8px; border-left: 5px solid var(--naranja); transform: translateX(200%); transition: 0.5s; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <i class="fas fa-check-circle"></i> <span id="toast-msg">Acci√≥n realizada</span>
    </div>

    <div class="sidebar">
        <div class="logo-box">
            <img src="images/ICC.png" alt="ICC Logo" onerror="this.src='https://placehold.co/200x80?text=ICC+ADMIN'">
        </div>

        <div class="nav-label">Gesti√≥n Comercial</div>
        <div class="nav-item active" onclick="navTo('dashboard', this)">
            <i class="fas fa-chart-pie"></i> Resumen
        </div>
        <div class="nav-item" onclick="navTo('whatsapp', this)">
            <i class="fab fa-whatsapp"></i> Chat Center
        </div>
        <div class="nav-item" onclick="navTo('leads', this)">
            <i class="fas fa-users"></i> Base de Leads
        </div>

        <div class="nav-label">Inteligencia Artificial</div>
        <div class="nav-item" onclick="navTo('cerebro', this)">
            <i class="fas fa-brain"></i> Entrenamiento
        </div>
        <div class="nav-item" onclick="navTo('tester', this)">
            <i class="fas fa-robot"></i> Laboratorio
        </div>

        <div style="margin-top: auto; padding-bottom: 20px;">
            <a href="/logout" class="nav-item" style="color: #e74c3c;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n
            </a>
        </div>
    </div>

    <div class="main-content">

        <div id="dashboard" class="view active">
            <h2><i class="fas fa-tachometer-alt" style="color:var(--naranja)"></i> Panel Ejecutivo</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="card" style="border-top-color: var(--success);">
                    <h3><i class="fas fa-user-check"></i> Leads Capturados</h3>
                    <h1 id="kpi-leads" style="font-size: 40px; margin: 10px 0;">0</h1>
                    <small>Clientes potenciales este mes</small>
                </div>
                <div class="card" style="border-top-color: var(--naranja);">
                    <h3><i class="fas fa-boxes"></i> Stock Sincronizado</h3>
                    <h1 id="kpi-stock" style="font-size: 40px; margin: 10px 0;">0</h1>
                    <small>Referencias aprendidas por Lorena</small>
                </div>
                <div class="card" style="border-top-color: #3498db;">
                    <h3><i class="fas fa-server"></i> Estado del Sistema</h3>
                    <h1 style="font-size: 20px; margin: 20px 0; color: #27ae60;">üü¢ OPERATIVO</h1>
                    <small>Motor Gemini 2.0: Activo</small>
                </div>
            </div>

            <div class="card">
                <h3><i class="fas fa-info-circle"></i> Acciones R√°pidas</h3>
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button class="btn" onclick="navTo('cerebro')"><i class="fas fa-upload"></i> Subir Nuevo Stock</button>
                    <button class="btn" onclick="navTo('whatsapp')"><i class="fas fa-comments"></i> Ver Conversaciones</button>
                </div>
            </div>
        </div>

        <div id="whatsapp" class="view">
            <h2><i class="fab fa-whatsapp" style="color:var(--whatsapp)"></i> Chat Center en Vivo</h2>
            <div class="chat-container">
                <div class="chat-list" id="chat-list-sidebar">
                    <div style="padding:20px; text-align:center; color:#999;">Cargando chats...</div>
                </div>
                <div class="chat-main">
                    <div id="active-chat-box" style="flex:1; padding:25px; overflow-y:auto; display:flex; flex-direction:column; gap:10px;">
                        <div style="text-align:center; margin-top:50px; color:#aaa;">
                            <i class="fas fa-comments fa-3x"></i><br><br>
                            Seleccione un chat de la izquierda
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="leads" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2><i class="fas fa-database"></i> Base de Datos de Clientes</h2>
                <button class="btn" style="background: #217346;" onclick="exportarExcel()">
                    <i class="fas fa-file-excel"></i> Descargar Excel
                </button>
            </div>
            
            <div class="card" style="padding:0; overflow:hidden; margin-top:20px;">
                <table id="knowledge-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Nombre</th>
                            <th>Tel√©fono</th>
                            <th>Ciudad</th>
                            <th>Inter√©s</th>
                        </tr>
                    </thead>
                    <tbody id="leads-body">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="cerebro" class="view">
            <h2><i class="fas fa-brain"></i> Configuraci√≥n de Lorena IA</h2>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <div>
                    <div class="card">
                        <h3><i class="fas fa-robot"></i> Personalidad y Rol</h3>
                        <p style="font-size:12px; margin-bottom:10px; color:#666;">Define c√≥mo se comporta Lorena ante el cliente.</p>
                        <textarea id="prompt-area" rows="6" placeholder="Ej: Eres un experto en maquinaria pesada..."></textarea>
                        <button class="btn" style="margin-top:15px; width:100%;" onclick="guardarPersonalidad()">
                            <i class="fas fa-save"></i> Actualizar Personalidad
                        </button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-book"></i> Reglas de Negocio</h3>
                        <textarea id="context-area" rows="6" placeholder="Ej: Horario de atenci√≥n 8am a 5pm. Env√≠os gratis en Bogot√°..."></textarea>
                        <button class="btn" style="margin-top:15px; width:100%; background:var(--dark-bg);" onclick="guardarContexto()">
                            <i class="fas fa-save"></i> Guardar Reglas
                        </button>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h3><i class="fas fa-upload"></i> Importar Inventario (CSV)</h3>
                        <div style="padding:30px; border: 2px dashed #ccc; border-radius:10px; text-align:center; margin:20px 0;">
                            <i class="fas fa-file-csv fa-3x" style="color:#ccc;"></i>
                            <p style="margin-top:10px; font-size:13px;">Arrastre su CSV aqu√≠ o seleccione</p>
                            <input type="file" id="csv-upload" accept=".csv" style="margin-top:10px;">
                        </div>
                        <button class="btn" style="width:100%;" onclick="subirCSV()">
                            <i class="fas fa-cloud-upload-alt"></i> Procesar Inventario
                        </button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-code"></i> Logs del Servidor</h3>
                        <div class="terminal" id="sys-logs">
                            > Sistema iniciado...<br>
                            > Esperando comandos...
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tester" class="view">
            <h2><i class="fas fa-vial"></i> Laboratorio de Pruebas</h2>
            <div class="chat-container" style="grid-template-columns: 1fr;">
                <div class="chat-main" style="background:#f4f7f6;">
                    <div id="test-msgs" style="flex:1; padding:30px; overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
                        <div class="bubble bot-row">Hola, soy Lorena. ¬øEn qu√© puedo ayudarte hoy?</div>
                    </div>
                    <div style="padding:20px; background:white; display:flex; gap:15px; border-top:1px solid #ddd;">
                        <input type="text" id="test-input" placeholder="Escribe un mensaje de prueba..." onkeypress="if(event.key==='Enter') testBot()">
                        <button class="btn" style="border-radius:50%; width:50px; height:50px; padding:0;" onclick="testBot()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ========================
        // 1. NAVEGACI√ìN
        // ========================
        function navTo(viewId, element) {
            // Cambiar vista activa
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // Cambiar men√∫ activo (si se hizo clic en men√∫)
            if(element) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                element.classList.add('active');
            } else {
                // Si se llama desde bot√≥n interno, buscar el men√∫ correspondiente
                // (L√≥gica simplificada para este caso)
            }

            // Cargar datos seg√∫n la vista
            if(viewId === 'dashboard') loadStats();
            if(viewId === 'whatsapp') loadWhatsApp();
            if(viewId === 'leads') loadLeads();
            if(viewId === 'cerebro') loadConfig();
        }

        function showToast(msg, type='success') {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.transform = "translateX(0)";
            setTimeout(() => t.style.transform = "translateX(200%)", 3000);
        }

        function logTerm(msg) {
            const t = document.getElementById('sys-logs');
            const time = new Date().toLocaleTimeString();
            t.innerHTML += `> [${time}] ${msg}<br>`;
            t.scrollTop = t.scrollHeight;
        }

        // ========================
        // 2. DASHBOARD & STATS
        // ========================
        async function loadStats() {
            try {
                const leads = await fetch('/api/data/leads').then(r => r.json());
                const items = await fetch('/api/data/knowledge').then(r => r.json());
                
                document.getElementById('kpi-leads').innerText = leads.length;
                document.getElementById('kpi-stock').innerText = items.length;
            } catch(e) { console.error("Error stats", e); }
        }

        // ========================
        // 3. WHATSAPP LOGIC
        // ========================
        let chatHistoryCache = {};

        async function loadWhatsApp() {
            const list = document.getElementById('chat-list-sidebar');
            list.innerHTML = '<div style="padding:20px; text-align:center;"><i class="fas fa-sync fa-spin"></i> Cargando...</div>';
            
            try {
                const res = await fetch('/api/data/history');
                chatHistoryCache = await res.json();
                
                const numbers = Object.keys(chatHistoryCache);
                if(numbers.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center;">No hay conversaciones a√∫n.</div>';
                    return;
                }

                let html = '';
                numbers.forEach(num => {
                    const lastMsg = chatHistoryCache[num][chatHistoryCache[num].length - 1];
                    const txt = lastMsg ? lastMsg.text.substring(0, 30) + '...' : 'Nueva conversaci√≥n';
                    
                    html += `
                    <div class="chat-user" onclick="verChat('${num}')">
                        <div style="width:40px; height:40px; background:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:bold;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div style="font-weight:600; font-size:14px;">+${num}</div>
                            <div style="font-size:12px; color:#888;">${txt}</div>
                        </div>
                    </div>`;
                });
                list.innerHTML = html;
            } catch(e) {
                list.innerHTML = '<div style="color:red; padding:20px;">Error de conexi√≥n</div>';
            }
        }

        // ¬°AQU√ç EST√Å LA FUNCI√ìN QUE FALTABA! 
        function verChat(phone) {
            const box = document.getElementById('active-chat-box');
            const msgs = chatHistoryCache[phone] || [];
            
            let html = `<div style="text-align:center; padding:10px; font-size:12px; color:#888; margin-bottom:20px;">
                            Chat con +${phone}
                        </div>`;

            msgs.forEach(m => {
                // Usamos las clases de SU CSS: bot-row y user-row
                const typeClass = m.role === 'bot' ? 'bot-row' : 'user-row';
                html += `<div class="bubble ${typeClass}">${m.text}</div>`;
            });

            box.innerHTML = html;
            box.scrollTop = box.scrollHeight;
        }

        // ========================
        // 4. LEADS
        // ========================
        async function loadLeads() {
            const tbody = document.getElementById('leads-body');
            try {
                const data = await fetch('/api/data/leads').then(r => r.json());
                if(data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Sin leads todav√≠a</td></tr>';
                    return;
                }
                tbody.innerHTML = data.reverse().map(l => `
                    <tr>
                        <td>${l.fecha}</td>
                        <td style="font-weight:600;">${l.nombre || 'Desconocido'}</td>
                        <td>${l.telefono}</td>
                        <td>${l.ciudad || '-'}</td>
                        <td><span class="badge-active">${l.interes || 'General'}</span></td>
                    </tr>
                `).join('');
            } catch(e) {}
        }

        function exportarExcel() {
            const wb = XLSX.utils.table_to_book(document.getElementById("knowledge-table"), {sheet:"Leads ICC"});
            XLSX.writeFile(wb, "Leads_ICC.xlsx");
            showToast("Excel descargado correctamente");
        }

        // ========================
        // 5. CONFIGURACI√ìN
        // ========================
        async function loadConfig() {
            const config = await fetch('/api/data/config').then(r => r.json());
            document.getElementById('prompt-area').value = config.prompt || '';
            document.getElementById('context-area').value = config.tech_rules || '';
        }

        async function guardarPersonalidad() {
            const val = document.getElementById('prompt-area').value;
            await fetch('/api/save-personality', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({prompt: val})
            });
            showToast("Personalidad actualizada");
            logTerm("Personalidad IA modificada por usuario");
        }

        async function guardarContexto() {
            const val = document.getElementById('context-area').value;
            await fetch('/save-context', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({context: val})
            });
            showToast("Reglas guardadas");
            logTerm("Reglas de negocio actualizadas");
        }

        async function subirCSV() {
            const file = document.getElementById('csv-upload').files[0];
            if(!file) return alert("Selecciona un archivo primero");

            const fd = new FormData();
            fd.append('file', file);
            
            showToast("Procesando archivo...", "info");
            logTerm("Iniciando carga de inventario...");

            try {
                const res = await fetch('/api/knowledge/csv', { method:'POST', body: fd });
                const d = await res.json();
                if(d.success) {
                    showToast(`¬°Listo! ${d.total} productos aprendidos`);
                    logTerm(`Carga completada: ${d.total} registros indexados.`);
                    document.getElementById('kpi-stock').innerText = d.total; // Actualizar KPI en vivo
                }
            } catch(e) {
                alert("Error al subir");
                logTerm("Error cr√≠tico en carga CSV");
            }
        }

        // ========================
        // 6. TESTER
        // ========================
        async function testBot() {
            const inp = document.getElementById('test-input');
            const box = document.getElementById('test-msgs');
            const txt = inp.value.trim();
            if(!txt) return;

            // User Bubble
            box.innerHTML += `<div class="bubble user-row">${txt}</div>`;
            inp.value = '';
            box.scrollTop = box.scrollHeight;

            // Call Bot
            try {
                const res = await fetch('/webhook', {
                    method:'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ message: txt })
                });
                const d = await res.json();
                // Bot Bubble
                box.innerHTML += `<div class="bubble bot-row">${d.reply}</div>`;
                box.scrollTop = box.scrollHeight;
            } catch(e) {
                box.innerHTML += `<div style="color:red; font-size:12px;">Error conectando con Lorena</div>`;
            }
        }

        // INIT
        window.onload = () => {
            loadStats();
        };
    </script>
</body>
</html>
