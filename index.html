<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICC | Panel 5.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --naranja: #FF8C00; --dark: #202c33; --bg: #f0f2f5; --white: #fff; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* NAV LATERAL */
        .nav-bar { width: 60px; background: var(--dark); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 200; }
        .nav-btn { color: #aebac1; font-size: 20px; margin-bottom: 30px; cursor: pointer; width: 100%; text-align: center; padding: 10px 0; transition: 0.2s; }
        .nav-btn:hover, .nav-btn.active { color: var(--naranja); border-left: 3px solid var(--naranja); background: rgba(255,255,255,0.05); }
        
        /* LAYOUT */
        .app-container { flex: 1; display: flex; }
        .view { display: none; width: 100%; height: 100%; }
        .view.active { display: flex; }
        .page-content { padding: 30px; overflow-y: auto; width: 100%; box-sizing: border-box; }

        /* ESTILOS CHAT */
        .chat-sidebar { width: 350px; background: var(--white); border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-header-side { height: 60px; background: #f0f2f5; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #ddd; }
        
        /* BARRA DE BSQUEDA Y BOTN AGREGAR (+) */
        .search-row { padding: 10px; display: flex; gap: 5px; border-bottom: 1px solid #eee; background: #fff; }
        .search-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; padding: 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: 0.2s; }
        .chat-item:hover { background: #f5f5f5; }
        .chat-item.active { background: #e9edef; }
        
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #dfe5e7; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: #fff; font-size: 20px; }
        .chat-info { flex: 1; overflow: hidden; }
        
        .chat-main { flex: 1; display: flex; flex-direction: column; background: #efe7dd; position: relative; }
        .chat-pattern { position: absolute; inset: 0; opacity: 0.4; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); pointer-events: none; }
        
        .chat-header-main { height: 60px; background: #f0f2f5; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; z-index: 10; border-bottom: 1px solid #ddd; }
        .msgs-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; z-index: 5; }
        
        .bubble { max-width: 70%; padding: 8px 12px; border-radius: 7px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .bubble-in { align-self: flex-start; background: #fff; border-top-left-radius: 0; }
        .bubble-out { align-self: flex-end; background: #d9fdd3; border-top-right-radius: 0; }
        .bubble-manual { align-self: flex-end; background: #e3f2fd; border-top-right-radius: 0; border: 1px dashed #2196f3; }

        .input-bar { min-height: 60px; background: #f0f2f5; padding: 10px; display: flex; gap: 10px; z-index: 10; align-items: center; }
        .input-field { flex: 1; padding: 12px; border-radius: 8px; border: none; outline: none; font-size: 14px; }

        /* UI ELEMENTS */
        .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; background: var(--dark); font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .btn-orange { background: var(--naranja); }
        .btn-orange:hover { background: #e67e00; }
        
        /* MENU CONTEXTUAL */
        #ctx-menu { display: none; position: absolute; background: #fff; width: 160px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; border-radius: 5px; overflow: hidden; }
        .ctx-item { padding: 12px; cursor: pointer; font-size: 13px; color: #333; transition: 0.2s; }
        .ctx-item:hover { background: #f0f2f5; }
        
        /* TABLAS */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 10px; background: #f9f9f9; border-bottom: 2px solid #eee; color: #555; }
        td { padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
    </style>
</head>
<body>
    <div class="nav-bar">
        <div class="nav-btn active" onclick="nav('chat')"><i class="fas fa-comments"></i></div>
        <div class="nav-btn" onclick="nav('dashboard')"><i class="fas fa-chart-pie"></i></div>
        <div class="nav-btn" onclick="nav('leads')"><i class="fas fa-address-book"></i></div>
        <div class="nav-btn" onclick="nav('config')"><i class="fas fa-cogs"></i></div>
        <div class="nav-btn" onclick="nav('sandbox')"><i class="fas fa-vial"></i></div>
        <div style="flex:1"></div>
        <div class="nav-btn" onclick="location.href='/logout'" style="color:#ef5350;"><i class="fas fa-sign-out-alt"></i></div>
    </div>

    <div class="app-container">
        
        <div id="view-chat" class="view active">
            <div class="chat-sidebar">
                <div class="chat-header-side">
                    <b>ICC Chat</b>
                    <div style="font-size:12px; color:green; display:flex; align-items:center; gap:5px;">
                        <i class="fas fa-circle" style="font-size:8px;"></i> Online
                    </div>
                </div>
                <div class="search-row">
                    <input type="text" id="search" class="search-input" placeholder=" Buscar o escribir n煤mero..." oninput="renderChats()">
                    <button class="btn btn-orange" onclick="addContactPrompt()" title="Agregar Nuevo Contacto"><i class="fas fa-plus"></i></button>
                </div>
                <div class="chat-list" id="chat-list-box">
                    </div>
            </div>

            <div class="chat-main">
                <div class="chat-pattern"></div>
                
                <div class="chat-header-main" id="chat-top" style="visibility:hidden;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="avatar" style="background:var(--naranja);"><i class="fas fa-user"></i></div>
                        <div>
                            <div id="active-name" style="font-weight:bold; font-size:15px;">Nombre</div>
                            <div id="active-phone" style="font-size:12px; color:#666;">...</div>
                        </div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button id="btn-bot" class="btn" onclick="toggleBot()" style="font-size:12px;">IA: ...</button>
                    </div>
                </div>

                <div class="msgs-box" id="msgs-box">
                    <div style="text-align:center; margin-top:100px; opacity:0.5;">
                        <i class="fab fa-whatsapp" style="font-size:50px; color:#ccc; margin-bottom:10px;"></i>
                        <p>Selecciona un chat para comenzar</p>
                    </div>
                </div>

                <div class="input-bar" id="input-bar" style="display:none;">
                    <button class="btn" style="background:transparent; color:#555;" onclick="sendMediaPrompt()" title="Adjuntar"><i class="fas fa-paperclip" style="font-size:20px;"></i></button>
                    <input type="text" id="msg-input" class="input-field" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter') sendMsg()">
                    <button class="btn btn-orange" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view page-content">
            <h1>Dashboard Comercial</h1>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                <div class="card">
                    <h3>Leads Capturados</h3>
                    <h1 id="kpi-leads" style="color:var(--naranja); font-size:40px;">0</h1>
                </div>
                <div class="card">
                    <h3>Total Chats</h3>
                    <h1 id="kpi-chats" style="color:#202c33; font-size:40px;">0</h1>
                </div>
            </div>
        </div>

        <div id="view-leads" class="view page-content">
            <h1>Base de Leads</h1>
            <div class="card">
                <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                    <button class="btn btn-orange" onclick="exportLeads()"><i class="fas fa-file-excel"></i> Descargar Excel</button>
                </div>
                <table style="width:100%;">
                    <thead><tr><th>Fecha</th><th>Nombre</th><th>Tel茅fono</th><th>Inter茅s</th><th>Etiqueta</th></tr></thead>
                    <tbody id="leads-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-config" class="view page-content">
            <h1>Configuraci贸n IA (Lorena)</h1>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="card">
                    <h3>Personalidad (Prompt)</h3>
                    <textarea id="cfg-prompt" style="width:100%; height:150px; padding:10px; border:1px solid #ddd;"></textarea>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <button class="btn btn-orange" onclick="saveConfig()">Guardar Cambios</button>
                        <button class="btn" style="background:#d32f2f;" onclick="document.getElementById('cfg-prompt').value=''">Borrar Todo</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Reglas de Negocio</h3>
                    <textarea id="cfg-rules" style="width:100%; height:150px; padding:10px; border:1px solid #ddd;"></textarea>
                    <div style="margin-top:10px;">
                         <button class="btn btn-orange" onclick="saveConfig()">Guardar Reglas</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-sandbox" class="view page-content">
            <h1>Laboratorio de Pruebas</h1>
            <div class="card">
                <div style="display:flex; gap:10px;">
                    <input id="sand-in" style="flex:1; padding:10px; border:1px solid #ddd;" placeholder="Prueba qu茅 responde Lorena...">
                    <button class="btn btn-orange" onclick="runTest()">Enviar</button>
                </div>
                <div style="margin-top:20px; display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div class="card" style="background:#f9f9f9;"><b>Respuesta Lorena:</b><p id="sand-res" style="color:#333;">...</p></div>
                    <div class="card" style="background:#222; color:#0f0; font-family:monospace; font-size:11px; height:100px; overflow:auto;" id="sand-log">LOG LGICO</div>
                </div>
            </div>
        </div>

    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="ctxAction('pin')"><i class="fas fa-thumbtack"></i> Fijar Chat</div>
        <div class="ctx-item" onclick="ctxAction('delete')" style="color:red;"><i class="fas fa-trash"></i> Eliminar</div>
    </div>

    <script>
        let chats = [], selectedId = null, ctxId = null, timer = null;

        // NAVEGACIN
        function nav(v) {
            document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            
            // Botones activos
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(b => b.classList.remove('active'));
            // L贸gica simple para iluminar el bot贸n correcto
            if(v==='chat') btns[0].classList.add('active');
            if(v==='dashboard') btns[1].classList.add('active');
            if(v==='leads') btns[2].classList.add('active');
            if(v==='config') btns[3].classList.add('active');
            if(v==='sandbox') btns[4].classList.add('active');

            if(timer) clearInterval(timer);
            
            if(v==='chat') { sync(); timer = setInterval(sync, 3000); }
            if(v==='config') loadCfg();
            if(v==='dashboard') loadDash();
            if(v==='leads') loadLeads();
        }

        // CHAT SYNC
        async function sync() {
            try {
                const res = await fetch('/api/chats-full');
                const data = await res.json();
                // Actualizar solo si hay cambios para no parpadear
                if(JSON.stringify(data) !== JSON.stringify(chats)) {
                    chats = data;
                    renderChats();
                    if(selectedId) renderMsgs(selectedId);
                }
            } catch(e) {}
        }

        function renderChats() {
            const q = document.getElementById('search').value.toLowerCase();
            const list = document.getElementById('chat-list-box');
            
            list.innerHTML = chats
                .filter(c => (c.name || c.id).toLowerCase().includes(q))
                .map(c => `
                <div class="chat-item ${c.id===selectedId?'active':''}" onclick="selChat('${c.id}')" oncontextmenu="openCtx(event, '${c.id}')">
                    <div class="avatar"><i class="fas fa-user"></i></div>
                    <div class="chat-info">
                        <div style="font-weight:600; display:flex; justify-content:space-between; align-items:center;">
                            ${c.name || c.id}
                            <span style="font-size:12px; color:#888;">${c.pinned ? '' : ''}</span>
                        </div>
                        <div style="font-size:12px; color:#666;">
                             ${c.botActive ? '' : '革'} ${(c.lastMessage.text||'').substring(0,25)}...
                        </div>
                    </div>
                </div>`).join('');
        }

        function selChat(id) {
            selectedId = id;
            const c = chats.find(x => x.id === id);
            document.getElementById('chat-top').style.visibility = 'visible';
            document.getElementById('input-bar').style.display = 'flex';
            document.getElementById('active-name').innerText = c.name || id;
            document.getElementById('active-phone').innerText = id;
            
            updateBotBtn(c.botActive);
            renderMsgs(id);
            renderChats(); // Para refrescar clase active
        }

        async function renderMsgs(id) {
            const h = await fetch('/api/data/history').then(r=>r.json());
            const msgs = h[id] || [];
            const box = document.getElementById('msgs-box');
            
            const html = msgs.map(m => `
                <div class="bubble ${m.role==='bot'?'bubble-out':(m.role==='manual'?'bubble-manual':'bubble-in')}">
                    ${m.text}
                    <div style="text-align:right; font-size:9px; opacity:0.5; margin-top:2px;">${new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                </div>`).join('');
                
            if(box.innerHTML !== html) { 
                box.innerHTML = html; 
                box.scrollTop = box.scrollHeight; 
            }
        }

        async function sendMsg() {
            const txt = document.getElementById('msg-input').value;
            if(!txt || !selectedId) return;
            await fetch('/api/chat/send', { 
                method:'POST', headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({phone:selectedId, message:txt})
            });
            document.getElementById('msg-input').value = '';
            sync();
        }

        // --- FUNCIN NUEVA: AGREGAR CONTACTO ---
        async function addContactPrompt() {
            const phone = prompt("Ingresa el n煤mero completo (Ej: 573001234567):");
            if(!phone) return;
            const name = prompt("Nombre del Cliente/Empresa:");
            
            await fetch('/api/contacts/add', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ phone: phone, name: name || "Nuevo Contacto" })
            });
            
            // Limpiamos busqueda y recargamos
            document.getElementById('search').value = '';
            sync();
        }

        // --- EXTRAS ---
        function openCtx(e, id) {
            e.preventDefault(); ctxId = id;
            const m = document.getElementById('ctx-menu');
            m.style.display = 'block'; m.style.left = e.pageX+'px'; m.style.top = e.pageY+'px';
        }
        document.onclick = (e) => { if(!e.target.closest('#ctx-menu')) document.getElementById('ctx-menu').style.display = 'none'; };

        async function ctxAction(act) {
            const c = chats.find(x=>x.id===ctxId);
            await fetch('/api/chat/action', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ phone:ctxId, action:act, value: act==='pin' ? !c.pinned : null })
            });
            sync();
        }

        async function loadCfg() {
            const d = await fetch('/api/config').then(r=>r.json());
            document.getElementById('cfg-prompt').value = d.prompt || '';
            document.getElementById('cfg-rules').value = d.tech_rules || '';
        }

        async function saveConfig() {
            await fetch('/api/save-config', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ prompt:document.getElementById('cfg-prompt').value, tech_rules:document.getElementById('cfg-rules').value })
            });
            alert("Guardado");
        }
        
        async function runTest() {
            document.getElementById('sand-res').innerText = "Pensando...";
            const r = await fetch('/api/test-ai', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ message:document.getElementById('sand-in').value, context:document.getElementById('cfg-rules').value })
            }).then(x=>x.json());
            document.getElementById('sand-res').innerText = r.response;
            document.getElementById('sand-log').innerText = r.logic_log;
        }

        async function loadDash() {
            const l = await fetch('/api/data/leads').then(r=>r.json());
            const c = await fetch('/api/chats-full').then(r=>r.json());
            document.getElementById('kpi-leads').innerText = l.length;
            document.getElementById('kpi-chats').innerText = c.length;
        }

        async function loadLeads() {
            const l = await fetch('/api/data/leads').then(r=>r.json());
            document.getElementById('leads-body').innerHTML = l.reverse().map(x=>`<tr><td>${x.fecha}</td><td>${x.nombre||'-'}</td><td>${x.telefono}</td><td>${x.interes||'-'}</td><td><span style="background:#d4edda; padding:2px 5px; border-radius:4px; font-size:10px;">${x.etiqueta||'LEAD'}</span></td></tr>`).join('');
        }
        
        function exportLeads() {
            const wb = XLSX.utils.table_to_book(document.getElementById('leads-body').parentElement, {sheet:"Leads"});
            XLSX.writeFile(wb, "Leads_ICC.xlsx");
        }

        async function toggleBot() {
            const c = chats.find(x=>x.id===selectedId);
            await fetch('/api/chat/toggle-bot', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ phone:selectedId, active: !c.botActive })
            });
            sync();
        }

        function updateBotBtn(act) {
            const btn = document.getElementById('btn-bot');
            btn.innerText = act ? "IA: ACTIVA" : "IA: PAUSADA";
            btn.style.background = act ? "#202c33" : "#d32f2f";
            btn.style.color = "#fff";
        }
        
        async function sendMediaPrompt() {
            if(!selectedId) return;
            const url = prompt("Link Imagen/PDF:");
            if(url) await fetch('/api/chat/send-media', {method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:selectedId, url:url, type: url.includes('.pdf')?'document':'image'})});
        }

        window.onload = () => nav('dashboard');
    </script>
</body>
</html>
