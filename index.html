<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICC | Panel de Control Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --naranja: #FF8C00;
            --naranja-light: #fff3e6;
            --dark-bg: #1a2a3a;
            --light-bg: #f4f7f6;
            --whatsapp: #25D366;
            --danger: #e74c3c;
            --text-main: #333;
            --text-muted: #777;
        }

        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--light-bg); display: flex; height: 100vh; color: var(--text-main); overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 260px; background: var(--dark-bg); color: white; display: flex; flex-direction: column; z-index: 100; box-shadow: 4px 0 10px rgba(0,0,0,0.1); }
        .logo-box { padding: 30px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .nav-label { font-size: 10px; text-transform: uppercase; color: rgba(255,255,255,0.4); padding: 25px 25px 10px; letter-spacing: 1.5px; font-weight: 700; }
        .nav-item { padding: 14px 25px; cursor: pointer; color: rgba(255,255,255,0.7); display: flex; align-items: center; gap: 12px; font-size: 14px; transition: all 0.3s; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: rgba(255,255,255,0.05); color: var(--naranja); border-right: 4px solid var(--naranja); }
        .nav-item i { width: 20px; text-align: center; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .view { display: none; animation: fadeIn 0.4s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & UI */
        .card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 25px; border: 1px solid #eee; }
        .card h3 { margin: 0 0 15px; font-size: 14px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* CHAT SYSTEM */
        .chat-container { display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 100px); background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .chat-list { border-right: 1px solid #eee; display: flex; flex-direction: column; background: #fff; }
        .search-area { padding: 15px; border-bottom: 1px solid #eee; }
        .search-area input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        
        .chat-user { padding: 15px; border-bottom: 1px solid #f8f8f8; cursor: pointer; transition: 0.2s; }
        .chat-user:hover { background: #f9f9f9; }
        .chat-user.active { background: var(--naranja-light); border-left: 4px solid var(--naranja); }
        .tag-badge { font-size: 9px; padding: 3px 8px; border-radius: 4px; font-weight: 700; text-transform: uppercase; margin-top: 5px; display: inline-block; }

        .chat-window { display: flex; flex-direction: column; background: #e5ddd5; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .chat-header { padding: 10px 20px; background: #fff; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .chat-messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        
        .bubble { max-width: 75%; padding: 10px 15px; border-radius: 12px; font-size: 13px; line-height: 1.4; box-shadow: 0 1px 2px rgba(0,0,0,0.1); position: relative; }
        .user-row { align-self: flex-start; background: #fff; border-top-left-radius: 0; }
        .bot-row { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; }
        .manual-row { align-self: flex-end; background: #dbeafe; border: 1px dashed #3b82f6; border-top-right-radius: 0; }

        .chat-input-area { padding: 15px; background: #fff; display: flex; gap: 10px; align-items: center; }
        .chat-input-area input { flex: 1; padding: 12px; border-radius: 20px; border: 1px solid #ddd; outline: none; }

        /* TABLES & FORMS */
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f8f9fa; font-size: 11px; color: var(--text-muted); font-weight: 700; }
        td { padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; font-family: inherit; font-size: 13px; resize: vertical; box-sizing: border-box; }
        
        .btn { padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn-naranja { background: var(--naranja); color: white; }
        .btn-naranja:hover { background: #e67e00; }
        .btn-danger { background: #ffebee; color: var(--danger); }
        .btn-icon { padding: 10px; border-radius: 50%; aspect-ratio: 1; }

        #toast { position: fixed; bottom: 30px; right: 30px; background: var(--dark-bg); color: white; padding: 15px 25px; border-radius: 8px; transform: translateY(200%); transition: 0.4s; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="toast"><i class="fas fa-check-circle"></i> Acci√≥n realizada</div>

    <div class="sidebar">
        <div class="logo-box">
            <h2 style="margin:0; font-size: 24px; color: var(--naranja);">ICC <span style="color:white; font-weight:300;">PRO</span></h2>
            <small style="color:#666; font-size:10px;">Versi√≥n 3.2</small>
        </div>
        
        <div class="nav-label">GESTI√ìN COMERCIAL</div>
        <div class="nav-item active" onclick="navTo('dashboard', this)"><i class="fas fa-chart-pie"></i> Resumen</div>
        <div class="nav-item" onclick="navTo('whatsapp', this)"><i class="fab fa-whatsapp"></i> Chat Center</div>
        <div class="nav-item" onclick="navTo('leads', this)"><i class="fas fa-address-book"></i> Base de Leads</div>

        <div class="nav-label">INTELIGENCIA ARTIFICIAL</div>
        <div class="nav-item" onclick="navTo('cerebro', this)"><i class="fas fa-brain"></i> Configurar Lorena</div>
        <div class="nav-item" onclick="navTo('inventario', this)"><i class="fas fa-boxes"></i> Inventario</div>
        
        <div style="margin-top: auto; padding: 20px;">
            <a href="/logout" class="nav-item" style="color:#ff6b6b; font-weight:600;"><i class="fas fa-sign-out-alt"></i> SALIR</a>
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="view active">
            <h2>Panel de Control</h2>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top:20px;">
                <div class="card"><h3>Total Leads Capturados</h3><h1 id="kpi-leads" style="color:var(--naranja); font-size:40px;">0</h1></div>
                <div class="card"><h3>Referencias en Stock</h3><h1 id="kpi-stock" style="color:#2980b9; font-size:40px;">0</h1></div>
                <div class="card"><h3>Estado del Sistema</h3><h1 style="color:var(--whatsapp); font-size:24px; display:flex; align-items:center; gap:10px;"><i class="fas fa-circle" style="font-size:15px;"></i> ONLINE</h1></div>
            </div>
        </div>

        <div id="whatsapp" class="view">
            <div class="chat-container">
                <div class="chat-list">
                    <div class="search-area">
                        <input type="text" id="search-chat" placeholder="üîç Buscar cliente..." oninput="renderChatList()">
                    </div>
                    <div id="chat-list-items" style="flex:1; overflow-y:auto;"></div>
                </div>
                <div class="chat-window">
                    <div class="chat-header">
                        <div id="chat-target-info">
                            <strong>Seleccione un chat</strong>
                            <div style="font-size:11px; color:#666;">Esperando conexi√≥n...</div>
                        </div>
                        <div id="chat-actions" style="display:none; gap:10px; align-items:center;">
                            <select id="tag-selector" onchange="updateTag()" style="padding:8px; border-radius:6px; border:1px solid #ddd; font-size:12px;">
                                <option value="lead">Lead Nuevo</option>
                                <option value="lead_caliente">üî• Lead Caliente</option>
                                <option value="cotizacion">üìù Cotizaci√≥n</option>
                                <option value="duda_tecnica">üîß T√©cnico</option>
                                <option value="curioso">üëÄ Curioso</option>
                            </select>
                            <button id="btn-toggle-ia" class="btn" style="font-size:11px; padding:8px 12px;" onclick="toggleBot()">IA ACTIVA</button>
                        </div>
                    </div>
                    <div class="chat-messages" id="chat-messages-box">
                        <div style="text-align:center; color:#999; margin-top:50px;">
                            <i class="fab fa-whatsapp" style="font-size:50px; opacity:0.3;"></i><br>
                            Selecciona una conversaci√≥n para comenzar
                        </div>
                    </div>
                    <div class="chat-input-area" id="chat-input-box" style="display:none;">
                        <button class="btn btn-icon" style="background:#f0f0f0; color:#555;" title="Enviar Archivo/Foto" onclick="sendMediaPrompt()"><i class="fas fa-paperclip"></i></button>
                        <input type="text" id="manual-msg-input" placeholder="Escribe un mensaje manual..." onkeypress="if(event.key==='Enter') sendManual()">
                        <button class="btn btn-naranja btn-icon" onclick="sendManual()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="leads" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Base de Datos de Leads</h2>
                <button class="btn" style="background:#1D6F42; color:white;" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
            </div>
            <div class="card" style="margin-top:20px; padding:0; overflow:hidden;">
                <table>
                    <thead><tr><th>Fecha</th><th>Nombre</th><th>Tel√©fono</th><th>Inter√©s Detectado</th><th>Estado</th></tr></thead>
                    <tbody id="leads-table-body"></tbody>
                </table>
            </div>
        </div>

        <div id="cerebro" class="view">
            <h2>Configuraci√≥n de Lorena</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-top:20px;">
                <div class="card">
                    <h3><i class="fas fa-robot"></i> Personalidad (Prompt Principal)</h3>
                    <textarea id="prompt-area" rows="12" placeholder="Define qui√©n es Lorena y c√≥mo debe vender..."></textarea>
                    <button class="btn btn-naranja" style="width:100%" onclick="savePersonality()">ACTUALIZAR PERSONALIDAD</button>
                </div>
                <div class="card">
                    <h3><i class="fas fa-book"></i> Reglas T√©cnicas & Contexto</h3>
                    <textarea id="rules-area" rows="12" placeholder="Reglas de negocio, precios base, condiciones de env√≠o..."></textarea>
                    <button class="btn" style="background:#34495e; color:white; width:100%" onclick="saveContext()">GUARDAR REGLAS</button>
                </div>
                <div class="card" style="grid-column: span 2;">
                    <h3><i class="fas fa-globe"></i> Informaci√≥n Web Extra</h3>
                    <textarea id="web-data-area" rows="4" placeholder="Pega aqu√≠ textos de tu sitio web para que Lorena sepa m√°s..."></textarea>
                    <button class="btn" style="background:#34495e; color:white; width:100%" onclick="saveWebData()">ACTUALIZAR INFO WEB</button>
                </div>
            </div>
        </div>

        <div id="inventario" class="view">
            <h2>Gesti√≥n de Inventario</h2>
            <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px; margin-top:20px;">
                <div class="card">
                    <h3>Cargar Productos (CSV)</h3>
                    <p style="font-size:12px; color:#666;">Sube un archivo .csv con columnas: referencia, nombre, precio.</p>
                    <input type="file" id="csv-file" accept=".csv" style="margin:15px 0; width:100%;">
                    <button class="btn btn-naranja" style="width:100%" onclick="uploadCSV()">SUBIR Y PROCESAR</button>
                </div>
                <div class="card">
                    <h3>Stock Actual</h3>
                    <div style="max-height: 500px; overflow-y:auto;">
                        <table id="inventory-table">
                            <thead><tr><th>Datos del Producto</th><th>Acci√≥n</th></tr></thead>
                            <tbody id="inventory-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        let selectedPhone = null;
        let botIsActive = true;
        let globalHistory = {};
        let globalTags = {};
        let liveTimer = null;

        // NAVEGACI√ìN
        function navTo(view, el) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            
            if(liveTimer) clearInterval(liveTimer);
            
            if(view === 'whatsapp') {
                syncChat();
                liveTimer = setInterval(syncChat, 3000); // Polling cada 3s
            } else if(view === 'dashboard') {
                loadStats();
            } else if(view === 'leads') {
                loadLeads();
            } else if(view === 'cerebro') {
                loadConfig();
            } else if(view === 'inventario') {
                loadInventory();
            }
        }

        // --- L√ìGICA CHAT ---
        async function syncChat() {
            try {
                const [hRes, tRes] = await Promise.all([
                    fetch('/api/data/history').then(r => r.json()),
                    fetch('/api/data/tags').then(r => r.json())
                ]);
                globalHistory = hRes;
                globalTags = tRes;
                renderChatList();
                if(selectedPhone) renderMessages(); // Refrescar si hay chat abierto
            } catch(e) { console.error("Sync error:", e); }
        }

        function renderChatList() {
            const list = document.getElementById('chat-list-items');
            const query = document.getElementById('search-chat').value.toLowerCase();
            const nums = Object.keys(globalHistory).filter(n => n.includes(query)).reverse(); // M√°s recientes primero
            
            list.innerHTML = nums.map(n => {
                const tag = globalTags[n] || 'lead';
                const tagClass = tag === 'lead_caliente' ? '#c0392b' : (tag === 'cotizacion' ? '#f39c12' : '#2980b9');
                const lastMsg = globalHistory[n][globalHistory[n].length -1]?.text.substring(0,30) || '...';
                
                return `<div class="chat-user ${selectedPhone === n ? 'active' : ''}" onclick="selectChat('${n}')">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${n}</strong>
                        <span style="font-size:10px; color:${tagClass}; font-weight:bold;">${tag.toUpperCase().replace('_',' ')}</span>
                    </div>
                    <div style="font-size:11px; color:#666; margin-top:5px;">${lastMsg}...</div>
                </div>`;
            }).join('');
        }

        async function selectChat(phone) {
            selectedPhone = phone;
            document.getElementById('chat-target-info').innerHTML = `<strong>${phone}</strong><br><small style="color:green">‚óè Conectado</small>`;
            document.getElementById('chat-actions').style.display = 'flex';
            document.getElementById('chat-input-box').style.display = 'flex';
            document.getElementById('tag-selector').value = globalTags[phone] || 'lead';
            
            // Check Bot Status
            const status = await fetch('/api/data/bot_status').then(r => r.json());
            botIsActive = status[phone] !== false;
            updateBotBtn();
            
            renderMessages();
        }

        function renderMessages() {
            const box = document.getElementById('chat-messages-box');
            const msgs = globalHistory[selectedPhone] || [];
            
            const html = msgs.map(m => {
                const time = new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return `<div class="bubble ${m.role === 'bot' ? 'bot-row' : m.role === 'manual' ? 'manual-row' : 'user-row'}">
                    ${m.text}
                    <div style="text-align:right; font-size:9px; opacity:0.5; margin-top:4px;">${time}</div>
                </div>`;
            }).join('');
            
            if(box.innerHTML !== html) {
                box.innerHTML = html;
                box.scrollTop = box.scrollHeight;
            }
        }

        async function sendManual() {
            const inp = document.getElementById('manual-msg-input');
            const txt = inp.value;
            if(!txt || !selectedPhone) return;
            const res = await fetch('/api/chat/send', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({phone:selectedPhone, message:txt})
            });
            if(res.ok) { inp.value = ''; syncChat(); }
        }

        async function sendMediaPrompt() {
            const url = prompt("Ingresa la URL de la imagen o PDF:");
            if(!url) return;
            const type = url.endsWith('.pdf') ? 'document' : 'image';
            
            await fetch('/api/chat/send-media', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({phone:selectedPhone, url:url, type:type})
            });
            toast("Archivo enviado");
            syncChat();
        }

        async function toggleBot() {
            botIsActive = !botIsActive;
            await fetch('/api/chat/toggle-bot', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({phone:selectedPhone, active:botIsActive})
            });
            updateBotBtn();
            toast(botIsActive ? "IA Activada" : "IA Pausada");
        }

        function updateBotBtn() {
            const btn = document.getElementById('btn-toggle-ia');
            btn.innerHTML = botIsActive ? '<i class="fas fa-robot"></i> IA ACTIVA' : '<i class="fas fa-pause-circle"></i> IA PAUSADA';
            btn.style.background = botIsActive ? "var(--naranja)" : "#95a5a6";
        }

        async function updateTag() {
            // El backend no tiene endpoint explicito de tag, pero podemos guardarlo en el objeto tags manualmente o crear endpoint.
            // Nota: En v3.2 el tag se guarda automatico, para manual requerir√≠a un endpoint extra.
            // Simularemos guardado local visual por ahora.
            toast("Etiqueta actualizada (Visual)");
        }

        // --- CONFIGURACI√ìN ---
        async function loadConfig() {
            const data = await fetch('/api/data/config').then(r => r.json());
            document.getElementById('prompt-area').value = data.prompt || '';
            document.getElementById('rules-area').value = data.tech_rules || '';
            document.getElementById('web-data-area').value = data.website_data || '';
        }

        async function savePersonality() {
            await fetch('/api/save-personality', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({prompt: document.getElementById('prompt-area').value})
            });
            toast("Personalidad Guardada");
        }

        async function saveContext() {
            await fetch('/save-context', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({context: document.getElementById('rules-area').value})
            });
            toast("Reglas Guardadas");
        }

        async function saveWebData() {
            await fetch('/save-website', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({urlData: document.getElementById('web-data-area').value})
            });
            toast("Info Web Guardada");
        }

        // --- INVENTARIO & LEADS ---
        async function loadInventory() {
            const data = await fetch('/api/data/knowledge').then(r => r.json());
            document.getElementById('inventory-body').innerHTML = data.map((it, idx) => `<tr>
                <td><div style="font-weight:bold; color:#2c3e50;">${it.searchable.substring(0,80)}...</div></td>
                <td><button class="btn btn-danger" style="padding:5px 10px; font-size:11px;" onclick="deleteItem(${idx})"><i class="fas fa-trash"></i></button></td>
            </tr>`).join('');
            document.getElementById('kpi-stock').innerText = data.length;
        }

        async function deleteItem(idx) {
            if(!confirm("¬øBorrar este producto?")) return;
            await fetch('/api/knowledge/delete', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body:JSON.stringify({index: idx})
            });
            loadInventory();
            toast("Producto eliminado");
        }

        async function loadLeads() {
            const [leads, tags] = await Promise.all([
                fetch('/api/data/leads').then(r => r.json()),
                fetch('/api/data/tags').then(r => r.json())
            ]);
            document.getElementById('leads-table-body').innerHTML = leads.reverse().map(l => `<tr>
                <td>${l.fecha}</td>
                <td><strong>${l.nombre||'---'}</strong></td>
                <td>${l.telefono}</td>
                <td>${l.interes || '-'}</td>
                <td><span style="background:#e3f2fd; color:#2980b9; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:bold;">${tags[l.telefono] || 'lead'}</span></td>
            </tr>`).join('');
            document.getElementById('kpi-leads').innerText = leads.length;
        }

        async function uploadCSV() {
            const file = document.getElementById('csv-file').files[0];
            if(!file) return alert("Selecciona un archivo");
            const fd = new FormData(); fd.append('file', file);
            
            const btn = document.querySelector('button[onclick="uploadCSV()"]');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
            
            const res = await fetch('/api/knowledge/csv', { method:'POST', body: fd });
            const data = await res.json();
            
            btn.innerHTML = 'SUBIR Y PROCESAR';
            toast(`Cargados ${data.count} productos`);
            loadInventory();
        }

        async function loadStats() {
            const [leads, inv] = await Promise.all([
                fetch('/api/data/leads').then(r => r.json()),
                fetch('/api/data/knowledge').then(r => r.json())
            ]);
            document.getElementById('kpi-leads').innerText = leads.length;
            document.getElementById('kpi-stock').innerText = inv.length;
        }

        function toast(msg) {
            const t = document.getElementById('toast');
            t.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
            t.style.transform = "translateY(0)";
            setTimeout(() => t.style.transform = "translateY(200%)", 3000);
        }

        function exportExcel() {
            const wb = XLSX.utils.table_to_book(document.querySelector("#leads table"), {sheet:"Leads ICC"});
            XLSX.writeFile(wb, "Leads_ICC.xlsx");
        }

        window.onload = () => { loadStats(); };
    </script>
</body>
</html>
