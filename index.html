<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICC | Lorena IA - Panel de Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --naranja: #FF8C00;
            --dark-bg: #2c3e50;
            --light-bg: #ecf0f1;
            --whatsapp: #25D366;
            --success: #27ae60;
        }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--light-bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: white; display: flex; flex-direction: column; border-right: 1px solid #ddd; z-index: 10; }
        .logo-box { padding: 20px; text-align: center; border-bottom: 1px solid #eee; }
        .logo-box img { max-width: 80%; }
        .nav-label { font-size: 11px; text-transform: uppercase; color: #999; padding: 20px 20px 10px; letter-spacing: 1px; }
        .nav-item { padding: 12px 20px; cursor: pointer; color: #555; transition: 0.3s; display: flex; align-items: center; gap: 10px; font-size: 14px; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: #f8f9fa; color: var(--naranja); border-right: 4px solid var(--naranja); }
        .nav-item i { width: 20px; text-align: center; }

        /* MAIN CONTENT */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .view { display: none; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS & GRID */
        .card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; border-top: 4px solid #ddd; }
        h2 { margin-top: 0; color: var(--dark-bg); font-weight: 700; margin-bottom: 25px; }
        h3 { margin: 0 0 15px 0; font-size: 16px; color: #7f8c8d; text-transform: uppercase; }

        /* BUTTONS & INPUTS */
        .btn { background: var(--naranja); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; transition: 0.2s; font-family: inherit; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; margin-bottom: 10px; }
        input:focus, textarea:focus { border-color: var(--naranja); outline: none; }

        /* CHAT CENTER */
        .chat-container { display: grid; grid-template-columns: 300px 1fr; height: calc(100vh - 100px); background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .chat-list { border-right: 1px solid #eee; overflow-y: auto; background: #fff; }
        .chat-user { padding: 15px; border-bottom: 1px solid #f9f9f9; cursor: pointer; display: flex; gap: 15px; align-items: center; transition: 0.2s; }
        .chat-user:hover, .chat-user.active { background: #f0f2f5; }
        .chat-main { display: flex; flex-direction: column; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-color: #e5ddd5; }
        
        .bubble { max-width: 70%; padding: 10px 15px; border-radius: 10px; font-size: 14px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 8px; line-height: 1.4; }
        .user-row { align-self: flex-start; background: white; border-top-left-radius: 0; color: #333; }
        .bot-row { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; color: #333; }
        
        /* TABLES */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 15px; background: #f8f9fa; color: #7f8c8d; font-weight: 600; border-bottom: 2px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #eee; color: #555; }
        .badge-active { background: #e8f8f5; color: #27ae60; padding: 5px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; }

        /* TERMINAL */
        .terminal { background: #1e1e1e; color: #0f0; padding: 15px; border-radius: 6px; font-family: monospace; height: 150px; overflow-y: auto; font-size: 12px; }
    </style>
</head>
<body>

    <div id="toast" style="position: fixed; top: 20px; right: 20px; background: var(--dark-bg); color: white; padding: 15px 25px; border-radius: 8px; border-left: 5px solid var(--naranja); transform: translateX(200%); transition: 0.5s; z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.2);">
        <i class="fas fa-check-circle"></i> <span id="toast-msg">Acci贸n realizada</span>
    </div>

    <div class="sidebar">
        <div class="logo-box">
            <h2 style="margin:0; color:var(--naranja);">ICC <span style="color:#333;">ADMIN</span></h2>
        </div>

        <div class="nav-label">Gesti贸n Comercial</div>
        <div class="nav-item active" onclick="navTo('dashboard', this)">
            <i class="fas fa-chart-pie"></i> Resumen
        </div>
        <div class="nav-item" onclick="navTo('whatsapp', this)">
            <i class="fab fa-whatsapp"></i> Chat Center
        </div>
        <div class="nav-item" onclick="navTo('leads', this)">
            <i class="fas fa-users"></i> Base de Leads
        </div>

        <div class="nav-label">Configuraci贸n</div>
        <div class="nav-item" onclick="navTo('integraciones', this)">
            <i class="fas fa-plug"></i> Integraciones
        </div>
        <div class="nav-item" onclick="navTo('cerebro', this)">
            <i class="fas fa-brain"></i> Entrenamiento
        </div>
        <div class="nav-item" onclick="navTo('tester', this)">
            <i class="fas fa-robot"></i> Laboratorio
        </div>

        <div style="margin-top: auto; padding-bottom: 20px;">
            <a href="/logout" class="nav-item" style="color: #e74c3c;">
                <i class="fas fa-sign-out-alt"></i> Cerrar Sesi贸n
            </a>
        </div>
    </div>

    <div class="main-content">

        <div id="dashboard" class="view active">
            <h2><i class="fas fa-tachometer-alt" style="color:var(--naranja)"></i> Panel Ejecutivo</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div class="card" style="border-top-color: var(--success);">
                    <h3><i class="fas fa-user-check"></i> Leads Capturados</h3>
                    <h1 id="kpi-leads" style="font-size: 40px; margin: 10px 0;">0</h1>
                    <small>Clientes potenciales totales</small>
                </div>
                <div class="card" style="border-top-color: var(--naranja);">
                    <h3><i class="fas fa-boxes"></i> Stock Sincronizado</h3>
                    <h1 id="kpi-stock" style="font-size: 40px; margin: 10px 0;">0</h1>
                    <small>Referencias aprendidas por Lorena</small>
                </div>
                <div class="card" style="border-top-color: #3498db;">
                    <h3><i class="fas fa-server"></i> Estado del Sistema</h3>
                    <h1 style="font-size: 20px; margin: 20px 0; color: #27ae60;"> ONLINE</h1>
                    <small>Motor Gemini 2.0: Activo</small>
                </div>
            </div>
        </div>

        <div id="whatsapp" class="view">
            <h2><i class="fab fa-whatsapp" style="color:var(--whatsapp)"></i> Chat Center en Vivo</h2>
            <div class="chat-container">
                <div class="chat-list" id="chat-list-sidebar">
                    <div style="padding:20px; text-align:center; color:#999;">Cargando chats...</div>
                </div>
                <div class="chat-main">
                    <div id="active-chat-box" style="flex:1; padding:25px; overflow-y:auto; display:flex; flex-direction:column;">
                        <div style="text-align:center; margin-top:50px; color:#666;">
                            <i class="fas fa-comments fa-3x"></i><br><br>
                            Seleccione un chat para ver la conversaci贸n en tiempo real.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="leads" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2><i class="fas fa-database"></i> Base de Datos de Clientes</h2>
                <button class="btn" style="background: #217346;" onclick="exportarExcel()">
                    <i class="fas fa-file-excel"></i> Descargar Excel
                </button>
            </div>
            
            <div class="card" style="padding:0; overflow:hidden; margin-top:20px;">
                <table id="knowledge-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Nombre</th>
                            <th>Tel茅fono</th>
                            <th>Inter茅s</th>
                        </tr>
                    </thead>
                    <tbody id="leads-body"></tbody>
                </table>
            </div>
        </div>

        <div id="cerebro" class="view">
            <h2><i class="fas fa-brain"></i> Configuraci贸n de Lorena IA</h2>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">
                <div>
                    <div class="card">
                        <h3><i class="fas fa-book"></i> Reglas de Negocio / Prompt</h3>
                        <p style="font-size:12px; margin-bottom:10px; color:#666;">Define c贸mo se comporta Lorena y la informaci贸n de la empresa.</p>
                        <textarea id="context-area" rows="10" placeholder="Escribe aqu铆 las reglas, qui茅nes somos, horarios..."></textarea>
                        <button class="btn" style="margin-top:15px; width:100%; background:var(--dark-bg);" onclick="guardarContexto()">
                            <i class="fas fa-save"></i> Guardar Reglas
                        </button>
                    </div>
                </div>

                <div>
                    <div class="card">
                        <h3><i class="fas fa-upload"></i> Importar Inventario (CSV)</h3>
                        <div style="padding:30px; border: 2px dashed #ccc; border-radius:10px; text-align:center; margin:20px 0;">
                            <i class="fas fa-file-csv fa-3x" style="color:#ccc;"></i>
                            <p style="margin-top:10px; font-size:13px;">Sube tu archivo .csv aqu铆</p>
                            <input type="file" id="csv-upload" accept=".csv" style="margin-top:10px;">
                        </div>
                        <button class="btn" style="width:100%;" onclick="subirCSV()">
                            <i class="fas fa-cloud-upload-alt"></i> Procesar Inventario
                        </button>
                    </div>

                    <div class="card">
                        <h3><i class="fas fa-code"></i> Logs del Sistema</h3>
                        <div class="terminal" id="sys-logs">
                            > Sistema iniciado...<br>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="integraciones" class="view">
             <h2><i class="fas fa-plug"></i> Integraciones</h2>
             <div class="card">
                 <p>Las credenciales de Meta se configuran actualmente desde el servidor (Variables de entorno).</p>
             </div>
        </div>

        <div id="tester" class="view">
            <h2><i class="fas fa-vial"></i> Laboratorio de Pruebas</h2>
            <div class="chat-container" style="grid-template-columns: 1fr;">
                <div class="chat-main" style="background:#f4f7f6;">
                    <div id="test-msgs" style="flex:1; padding:30px; overflow-y:auto; display:flex; flex-direction:column; gap:15px;">
                        <div class="bubble bot-row">Hola, soy Lorena. 驴En qu茅 puedo ayudarte hoy?</div>
                    </div>
                    <div style="padding:20px; background:white; display:flex; gap:15px; border-top:1px solid #ddd;">
                        <input type="text" id="test-input" placeholder="Escribe un mensaje de prueba..." onkeypress="if(event.key==='Enter') testBot()">
                        <button class="btn" style="border-radius:50%; width:50px; height:50px; padding:0;" onclick="testBot()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // VARIABLES GLOBALES
        let activeChatPhone = null;
        let refreshInterval = null;

        // ========================
        // 1. NAVEGACIN
        // ========================
        function navTo(viewId, element) {
            // Cambiar vista
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            
            // Cambiar men煤 activo
            if(element) {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                element.classList.add('active');
            }

            // DETENER INTERVALOS ANTERIORES
            if(refreshInterval) clearInterval(refreshInterval);

            // LOGICA SEGN VISTA
            if(viewId === 'dashboard') loadStats();
            if(viewId === 'leads') loadLeads();
            if(viewId === 'cerebro') loadConfig();
            
            // MODO TIEMPO REAL PARA WHATSAPP
            if(viewId === 'whatsapp') {
                loadWhatsApp(); // Carga inmediata
                refreshInterval = setInterval(loadWhatsApp, 3000); // Recarga cada 3 seg
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.style.transform = "translateX(0)";
            setTimeout(() => t.style.transform = "translateX(200%)", 3000);
        }

        function logTerm(msg) {
            const t = document.getElementById('sys-logs');
            const time = new Date().toLocaleTimeString();
            t.innerHTML += `> [${time}] ${msg}<br>`;
            t.scrollTop = t.scrollHeight;
        }

        // ========================
        // 2. DASHBOARD & STATS
        // ========================
        async function loadStats() {
            try {
                const leads = await fetch('/api/data/leads').then(r => r.json());
                const knowledge = await fetch('/api/data/knowledge').then(r => r.json());
                document.getElementById('kpi-leads').innerText = leads.length || 0;
                document.getElementById('kpi-stock').innerText = knowledge.length || 0;
            } catch(e) { console.error("Error cargando stats", e); }
        }

        // ========================
        // 3. WHATSAPP LOGIC (AUTO-REFRESCO)
        // ========================
        async function loadWhatsApp() {
            try {
                const res = await fetch('/api/data/history');
                const history = await res.json();
                const list = document.getElementById('chat-list-sidebar');
                const numbers = Object.keys(history);

                // Si no hay chats
                if(numbers.length === 0) {
                    list.innerHTML = '<div style="padding:20px; text-align:center;">No hay chats</div>';
                    return;
                }

                // Renderizar lista de contactos
                let html = '';
                numbers.forEach(num => {
                    const lastMsg = history[num][history[num].length - 1];
                    const txt = lastMsg ? lastMsg.text.substring(0, 25) + '...' : 'Nuevo chat';
                    const activeClass = (activeChatPhone === num) ? 'background:#f0f2f5;' : '';
                    
                    html += `
                    <div class="chat-user" style="${activeClass}" onclick="setActiveChat('${num}')">
                        <div style="width:40px; height:40px; background:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white;">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div style="font-weight:600;">${num}</div>
                            <div style="font-size:12px; color:#888;">${txt}</div>
                        </div>
                    </div>`;
                });
                list.innerHTML = html;

                // Si hay un chat abierto, refrescar sus mensajes
                if(activeChatPhone && history[activeChatPhone]) {
                    renderChatMessages(history[activeChatPhone]);
                }

            } catch(e) { console.error("Error sync WhatsApp", e); }
        }

        function setActiveChat(phone) {
            activeChatPhone = phone;
            loadWhatsApp(); // Forzar recarga inmediata para ver cambios
        }

        function renderChatMessages(msgs) {
            const box = document.getElementById('active-chat-box');
            // Solo reconstruir si hay cambios para no perder scroll (l贸gica simple)
            let html = '';
            msgs.forEach(m => {
                const typeClass = m.role === 'bot' ? 'bot-row' : 'user-row';
                html += `<div class="bubble ${typeClass}">${m.text}</div>`;
            });
            
            // Simple check para evitar parpadeo si no hay mensajes nuevos
            if(box.innerHTML !== html) {
                box.innerHTML = html;
                box.scrollTop = box.scrollHeight;
            }
        }

        // ========================
        // 4. LEADS & EXCEL
        // ========================
        async function loadLeads() {
            const tbody = document.getElementById('leads-body');
            try {
                const data = await fetch('/api/data/leads').then(r => r.json());
                tbody.innerHTML = data.map(l => `
                    <tr>
                        <td>${l.fecha}</td>
                        <td style="font-weight:600;">${l.nombre || 'N/A'}</td>
                        <td>${l.telefono}</td>
                        <td><span class="badge-active">${l.interes || 'General'}</span></td>
                    </tr>
                `).join('');
            } catch(e) {}
        }

        function exportarExcel() {
            const wb = XLSX.utils.table_to_book(document.getElementById("knowledge-table"), {sheet:"Leads"});
            XLSX.writeFile(wb, "Leads_ICC.xlsx");
            showToast("Descargando Excel...");
        }

        // ========================
        // 5. CONFIGURACIN (Contexto)
        // ========================
        async function loadConfig() {
            try {
                const config = await fetch('/api/data/config').then(r => r.json());
                if(document.getElementById('context-area')) {
                    document.getElementById('context-area').value = config.tech_rules || '';
                }
            } catch(e) {}
        }

        async function guardarContexto() {
            const val = document.getElementById('context-area').value;
            await fetch('/save-context', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({context: val})
            });
            showToast("Reglas guardadas");
            logTerm("Reglas actualizadas en el servidor");
        }

        async function subirCSV() {
            const file = document.getElementById('csv-upload').files[0];
            if(!file) return alert("Selecciona archivo");
            const fd = new FormData(); fd.append('file', file);
            
            showToast("Subiendo inventario...");
            try {
                const res = await fetch('/api/knowledge/csv', { method:'POST', body: fd });
                const d = await res.json();
                if(d.success) {
                    showToast("Inventario actualizado");
                    logTerm(`Cargados ${d.count} productos`);
                }
            } catch(e) { alert("Error al subir"); }
        }

        // ========================
        // 6. TESTER
        // ========================
        async function testBot() {
            const inp = document.getElementById('test-input');
            const box = document.getElementById('test-msgs');
            const txt = inp.value.trim();
            if(!txt) return;

            box.innerHTML += `<div class="bubble user-row">${txt}</div>`;
            inp.value = '';
            box.scrollTop = box.scrollHeight;

            try {
                const res = await fetch('/webhook', {
                    method:'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ message: txt })
                });
                const d = await res.json();
                box.innerHTML += `<div class="bubble bot-row">${d.reply}</div>`;
                box.scrollTop = box.scrollHeight;
            } catch(e) {
                box.innerHTML += `<div style="color:red; font-size:12px;">Error conexi贸n</div>`;
            }
        }

        // INICIALIZACIN
        window.onload = () => { loadStats(); };
    </script>
</body>
</html>
