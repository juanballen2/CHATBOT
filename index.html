<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ICBOT V29.0 </title>
    <link rel="icon" href="https://raw.githubusercontent.com/juanballen2/CHATBOT/main/images/iconboticc_Mesa%20de%20trabajo%201.svg" type="image/svg+xml">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="/socket.io/socket.io.js"></script>
    
    <style>
        :root {
            /* TEMA CLARO POR DEFECTO (Blanco, Naranja, Gris) */
            --primary: #E9521E;      
            --outgoing: #E9521E;     
            --incoming: #515050;     
            
            --bg-main: #FFFFFF;      
            --panel: #F5F6F6;        
            --border: #D1D7DB;       
            
            --text: #333333;         
            --text-muted: #777777;   
            --accent: #E9521E;       
            --danger: #ef4444;
            --hover-item: #EBEBEB;   
            --active-item: #FFEBE5;  
            
            --chat-bg-color: #E5E5E5;
            --avatar-bg: #E0E0E0;
            --avatar-color: #888888;
            --icon-color: #515050; /* Color base para iconos */
        }

        /* TEMA OSCURO */
        [data-theme="dark"] {
            --bg-main: #111b21;      
            --panel: #202c33;        
            --border: #37404a;       
            
            --text: #e9edef;         
            --text-muted: #8696a0;   
            --incoming: #202c33;     
            --outgoing: #E9521E;     
            --hover-item: #2a3942;   
            --active-item: #3d2a23;  
            
            --chat-bg-color: #0b141a;
            --avatar-bg: #37404a;
            --avatar-color: #8696a0;
            --icon-color: #8696a0; /* Contraste seguro en modo oscuro */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; transition: background-color 0.3s, color 0.3s, border-color 0.3s; }
        
        /* FIX RESPONSIVO: Uso de dvh para pantallas como el A14 */
        body { background-color: var(--bg-main); color: var(--text); height: 100vh; height: 100dvh; display: flex; overflow: hidden; }

        /* --- MODALES GENERALES --- */
        .modal-overlay { display: none; position: fixed; z-index: 5000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); align-items: center; justify-content: center; backdrop-filter: blur(3px); transition: all 0.3s; }
        .modal-overlay.show { display: flex; animation: fadeIn 0.2s; }
        .modal-content { background-color: var(--bg-main); padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.4); display: flex; flex-direction: column; gap: 15px; max-height: 90dvh; overflow-y: auto; }
        .modal-title { font-size: 1.2rem; color: var(--text); font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .modal-form label { display: block; margin-bottom: 5px; font-size: 0.85rem; color: var(--primary); font-weight: 600; }
        .modal-form input, .modal-form textarea, .modal-form select { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text); outline: none; font-size: 0.95rem; transition: border 0.3s, box-shadow 0.3s; }
        .modal-form input:focus, .modal-form textarea:focus, .modal-form select:focus { border-color: var(--primary); box-shadow: 0 0 5px rgba(233, 82, 30, 0.3); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

        /* --- ANIMACIONES Y BOTONES INTERACTIVOS --- */
        button { cursor: pointer; transition: all 0.2s ease-in-out; }
        button:active { transform: scale(0.95); }
        button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .chat-item { transition: all 0.1s ease-in-out; }
        .chat-item:active { transform: scale(0.98); }
        
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #b0b0b0; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--incoming); }

        /* --- LAYOUT PRINCIPAL --- */
        .sidebar { width: 60px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 100; flex-shrink: 0; }
        .nav-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: var(--icon-color); font-size: 1.2rem; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; }
        .nav-btn:hover { background: var(--hover-item); color: var(--primary); }
        .nav-btn.active { background: var(--bg-main); color: var(--primary); box-shadow: 0 0 10px rgba(233, 82, 30, 0.3); border: 1px solid var(--border); }
        .nav-bottom { margin-top: auto; padding-bottom: 20px; display: flex; flex-direction: column; gap: 10px;}

        .main-area { flex: 1; display: flex; position: relative; overflow: hidden; background: var(--bg-main); }
        .view-panel { display: none; width: 100%; height: 100%; }
        #tab-chat.active { display: flex; flex-direction: row; }
        #tab-leads.active, #tab-config.active { display: flex; flex-direction: column; overflow-y: auto; }

        /* --- LISTA DE CHATS --- */
        .chat-list { width: 380px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg-main); flex-shrink: 0; position: relative; }
        .chat-header { padding: 10px 15px; border-bottom: 1px solid var(--border); background: var(--panel); }
        .search-container { display: flex; gap: 8px; margin-bottom: 10px; }
        .search-bar { flex: 1; padding: 8px 12px; background: var(--bg-main); border: 1px solid var(--border); color: var(--text); border-radius: 8px; outline: none; font-size: 0.9rem; transition: border 0.3s; }
        .search-bar:focus { border-color: var(--primary); }
        .action-btn { width: 36px; height: 36px; border-radius: 8px; border: none; background: var(--bg-main); color: var(--icon-color); cursor: pointer; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; }
        .action-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .new-chat-btn { background: var(--primary); color: #fff; border: none; }
        
        .view-filters { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; align-items: center; }
        .filter-chip { font-size: 0.8rem; padding: 5px 12px; background: var(--bg-main); border: 1px solid var(--border); border-radius: 20px; cursor: pointer; white-space: nowrap; color: var(--text-muted); transition: 0.2s; }
        .filter-chip:hover { background: var(--hover-item); color: var(--primary); border-color: var(--primary); }
        .filter-chip.active { background: var(--primary); color: #FFF; border-color: var(--primary); font-weight: 600; }
        .tag-filter-select { background: var(--bg-main); color: var(--text); border: 1px solid var(--border); border-radius: 4px; padding: 4px; font-size: 0.8rem; max-width: 120px; outline:none; }

        .chat-items { flex: 1; overflow-y: auto; background: var(--bg-main); }
        .chat-item { padding: 12px 15px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; gap: 12px; align-items: center; position: relative; }
        .chat-item:hover { background: var(--hover-item); }
        .chat-item.active { background: var(--active-item); border-left: 4px solid var(--primary); padding-left: 11px; } 
        .chat-item.archived { opacity: 0.6; }
        
        .bulk-checkbox { display: none; width: 18px; height: 18px; accent-color: var(--primary); cursor: pointer; }
        .chat-list.bulk-mode .bulk-checkbox { display: block; }
        
        /* AVATAR MEJORADO */
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--avatar-bg); color: var(--avatar-color); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; font-size: 1.3rem; }
        
        .chat-info { flex: 1; min-width: 0; }
        .chat-name { font-weight: 600; font-size: 1rem; color: var(--text); display: flex; justify-content: space-between; }
        .chat-preview { display: flex; justify-content: space-between; align-items: center; margin-top: 3px; }
        .chat-last-msg { font-size: 0.85rem; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .badge { background: var(--primary); color: #fff; font-size: 0.7rem; padding: 2px 6px; border-radius: 10px; font-weight: bold; min-width: 18px; text-align: center; }
        .mini-tags { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
        .mini-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; color: #000; font-weight: 600; }

        /* Barra de Acciones Masivas */
        #bulk-toolbar { display: none; position: absolute; bottom: 0; left: 0; width: 100%; background: var(--bg-main); border-top: 2px solid var(--primary); padding: 15px; z-index: 50; flex-direction: column; gap: 10px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); }
        #bulk-toolbar.show { display: flex; animation: slideUp 0.3s; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .bulk-actions-row { display: flex; justify-content: space-between; align-items: center; }

        /* --- CHAT AREA --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; background-color: var(--chat-bg-color); background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: multiply; opacity: 0.95; position: relative; }
        .chat-top { padding: 10px 16px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .messages { flex: 1; overflow-y: auto; padding: 20px 40px; display: flex; flex-direction: column; gap: 4px; }
        
        .msg { max-width: 65%; padding: 8px 12px; border-radius: 8px; font-size: 0.95rem; line-height: 1.4; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .msg.user { background: var(--incoming); align-self: flex-start; border-top-left-radius: 0; color: #FFF; }
        .msg.bot, .msg.manual { background: var(--outgoing); align-self: flex-end; border-top-right-radius: 0; color: #FFF; }
        
        .msg.alert { background: rgba(239, 68, 68, 0.15); border: 1px solid #ef4444; color: #D32F2F; align-self: center; border-radius: 8px; width: 85%; max-width: 85%; text-align: center; font-weight: 500; font-size: 0.85rem; }
        
        .msg-time { font-size: 0.65rem; opacity: 0.7; align-self: flex-end; margin-top: 4px; }
        
        /* Bot칩n de Reenv칤o con Delay */
        .msg-forward-btn { 
            position: absolute; top: 5px; right: -35px; background: var(--bg-main); color: var(--primary); border: 1px solid var(--border);
            border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; 
            cursor: pointer; font-size: 0.85rem; opacity: 0; visibility: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: opacity 0.3s ease 1.5s, visibility 0.3s ease 1.5s, transform 0.2s, background 0.2s;
        }
        .msg:hover .msg-forward-btn { opacity: 1; visibility: visible; transition-delay: 0s; }
        .msg.bot:hover .msg-forward-btn { left: -35px; right: auto; }
        .msg-forward-btn:hover { background: var(--primary); color: #FFF; transform: scale(1.1); }

        /* Audio Player Mejorado (Nivel WhatsApp) */
        .audio-wrapper { display: flex; align-items: center; gap: 12px; padding: 6px; background: rgba(255,255,255,0.15); border-radius: 12px; min-width: 250px; }
        [data-theme="dark"] .audio-wrapper { background: rgba(0,0,0,0.2); }
        .play-btn { width: 38px; height: 38px; background: var(--primary); color: white; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .play-btn:hover { transform: scale(1.1); }
        .audio-progress { flex: 1; display: flex; flex-direction: column; justify-content: center; gap: 4px; margin-top: 2px; }
        input[type=range].wa-slider { -webkit-appearance: none; width: 100%; background: transparent; height: 6px; cursor: pointer; }
        input[type=range].wa-slider::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.3); border-radius: 2px; }
        input[type=range].wa-slider::-webkit-slider-thumb { -webkit-appearance: none; height: 12px; width: 12px; border-radius: 50%; background: var(--primary); margin-top: -4px; box-shadow: 0 1px 3px rgba(0,0,0,0.3); transition: transform 0.1s; }
        input[type=range].wa-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }
        .audio-time { font-size: 0.7rem; color: #FFF; font-family: monospace; display: flex; justify-content: space-between; opacity: 0.9; padding-top: 2px; }

        .btn-download-audio { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #FFF; text-decoration: none; background: rgba(255,255,255,0.1); transition: background 0.2s; }
        .btn-download-audio:hover { background: rgba(255,255,255,0.3); }

        .input-area { padding: 12px 16px; background: var(--panel); display: flex; gap: 10px; align-items: center; border-top: 1px solid var(--border); }
        .input-box { flex: 1; padding: 12px 15px; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text); outline: none; resize: none; height: 45px; font-size: 0.95rem; transition: border 0.3s; }
        .input-box:focus { border-color: var(--primary); }
        .send-btn { width: 45px; height: 45px; border-radius: 50%; border: none; background: var(--primary); color: #FFF; cursor: pointer; font-size: 1.2rem; display: flex; justify-content: center; align-items: center; }
        .send-btn:hover { filter: brightness(1.1); transform: scale(1.05); }
        .attach-btn { background: transparent; border: none; color: var(--icon-color); font-size: 1.4rem; cursor: pointer; padding: 0 5px; }
        .attach-btn:hover { color: var(--primary); transform: scale(1.1); }

        /* --- CRM & CONFIG --- */
        .crm-panel { width: 320px; border-left: 1px solid var(--border); background: var(--panel); padding: 20px; overflow-y: auto; display: none; flex-shrink: 0; }
        .crm-panel.open { display: block; position: absolute; right: 0; height: 100%; z-index: 30; border-left: 1px solid var(--border); background: var(--bg-main); box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
        .crm-section { margin-bottom: 30px; background: var(--bg-main); padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .crm-title { font-size: 0.75rem; text-transform: uppercase; color: var(--primary); margin-bottom: 12px; font-weight: 700; letter-spacing: 0.5px; }
        .crm-input { width: 100%; padding: 10px; margin-bottom: 10px; background: var(--bg-main); border: 1px solid var(--border); color: var(--text); border-radius: 6px; font-size: 0.9rem; transition: border 0.3s; }
        .crm-input:focus { border-color: var(--primary); outline: none; }
        
        select.crm-input { appearance: none; cursor: pointer; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23515050%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 10px top 50%; background-size: 10px auto; }
        select.crm-input option { background: var(--bg-main); color: var(--text); }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { padding: 4px 10px; border-radius: 99px; font-size: 0.8rem; cursor: pointer; border: 1px solid var(--border); color: var(--text-muted); background: var(--bg-main); transition: 0.2s; font-weight: 500; }
        .tag:hover { transform: scale(1.05); }
        .tag.selected { border-color: var(--primary); background: var(--primary); color: #fff; }
        
        /* Switch */
        .switch-container { display: flex; align-items: center; justify-content: space-between; font-weight: 500; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border); transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        .leads-container, .config-container { padding: 30px; width: 100%; box-sizing: border-box; background: var(--bg-main); }
        .table-responsive { width: 100%; overflow-x: auto; margin-top: 20px; background: var(--bg-main); border-radius: 8px; border: 1px solid var(--border); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; min-width: 1000px; }
        .data-table th, .data-table td { padding: 14px 15px; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
        .data-table th { color: var(--text-muted); font-weight: 600; background: var(--panel); }
        .data-table tr:hover { background: var(--hover-item); }
        .lead-source-tag { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .lead-source-web { background: rgba(30, 64, 175, 0.1); color: #3b82f6; border: 1px solid #1e40af; }
        .lead-source-store { background: rgba(134, 25, 143, 0.1); color: #d946ef; border: 1px solid #a21caf; }

        /* --- NUEVOS ESTILOS PARA LA CONFIGURACI칍N (TABS Y UI LIMPIA) --- */
        .config-tabs-nav { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid var(--border); padding-bottom: 15px; overflow-x: auto; }
        .btn-tab { background: transparent; border: none; font-size: 0.95rem; font-weight: 600; color: var(--text-muted); padding: 10px 18px; cursor: pointer; transition: all 0.2s; border-radius: 8px; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .btn-tab:hover { background: var(--hover-item); color: var(--primary); }
        .btn-tab.active { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(233, 82, 30, 0.2); }
        
        .config-sub-panel { display: none; animation: fadeIn 0.3s; }
        .config-sub-panel.active { display: block; }

        .config-header-main { font-size: 1.3rem; font-weight: 600; padding-bottom: 10px; margin-bottom: 15px; color: var(--text); display: flex; align-items: center; gap: 10px; }
        .config-row { display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px; }
        .config-card { background: var(--bg-main); padding: 25px; border-radius: 12px; border: 1px solid var(--border); flex: 1; min-width: 300px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .config-header { font-size: 1.05rem; font-weight: 600; margin-bottom: 5px; color: var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .config-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 15px; display: block; }
        
        /* Redise침o del editor de prompt para que sea amigable */
        .prompt-textarea { width: 100%; height: 180px; background: var(--bg-main); color: var(--text); padding: 15px; border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 0.95rem; border: 1px solid var(--border); resize: vertical; line-height: 1.5; outline: none; transition: border-color 0.3s, box-shadow 0.3s; }
        .prompt-textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(233, 82, 30, 0.1); }

        .config-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; background: var(--bg-main); border-bottom: 1px solid var(--border); font-size: 0.9rem; transition: background 0.2s; border-radius: 6px;}
        .config-item:hover { background: var(--panel); }
        .config-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .cfg-input { flex:1; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-main); color: var(--text); outline: none; font-size: 0.9rem;}
        .cfg-input:focus { border-color: var(--primary); }
        
        .btn-small { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-green { background: var(--primary); color: #fff; }
        .btn-green:hover { filter: brightness(1.1); box-shadow: 0 3px 6px rgba(233, 82, 30, 0.2); }
        .btn-red { background: transparent; color: #ef4444; border: 1px solid #ef4444; }
        .btn-red:hover { background: #ef4444; color: #FFF; }
        .btn-blue { background: transparent; color: var(--text-muted); border: 1px solid var(--border); }
        .btn-blue:hover { background: var(--panel); color: var(--primary); border-color: var(--primary); }

        #context-menu { position: absolute; display: none; background: var(--bg-main); border: 1px solid var(--border); box-shadow: 0 10px 25px rgba(0,0,0,0.2); border-radius: 8px; width: 180px; z-index: 1000; overflow: hidden; }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 10px; color: var(--text); transition: background 0.2s; font-weight: 500; }
        .ctx-item:hover { background: var(--panel); color: var(--primary); }
        .ctx-divider { height: 1px; background: var(--border); margin: 0; }
        
        #toast { visibility: hidden; min-width: 250px; margin-left: -125px; background-color: var(--primary); color: #fff; text-align: center; border-radius: 8px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; font-size: 15px; font-weight: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }

        /* Estilos Lightbox Nativo */
        .lightbox-content-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .lightbox-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; transition: 0.2s; z-index: 5001;}
        .lightbox-close:hover { color: var(--primary); transform: scale(1.1); }
        
        /* RESPONSIVE ARREGLADO EXTREMO PARA A14 */
        @media (max-width: 768px) {
            .sidebar { display: none; } 
            .chat-list { width: 100%; height: 100dvh; position: absolute; top: 0; left: 0; z-index: 10; }
            .chat-area { position: absolute; width: 100%; height: 100dvh; top: 0; left: 0; z-index: 20; transform: translateX(100%); transition: transform 0.3s ease; background-color: var(--chat-bg-color); }
            body.mobile-chat-open .chat-area { transform: translateX(0); }
            #back-btn { display: flex !important; margin-right: 15px; font-size: 1.2rem; cursor: pointer; color: var(--icon-color); align-items: center; justify-content: center; width: 30px; height: 30px;}
        }
        #back-btn { display: none; }
    </style>
</head>
<body data-theme="light">

    <div class="sidebar">
        <div style="width: 40px; height: 40px; background: url('https://raw.githubusercontent.com/juanballen2/CHATBOT/main/images/iconboticc_Mesa%20de%20trabajo%201.svg') no-repeat center/contain; border-radius: 50%; margin-bottom: 30px;" id="logo-preview"></div>
        <button class="nav-btn active" onclick="switchTab('chat')" title="Chats"><i class="fas fa-comments"></i></button>
        <button class="nav-btn" onclick="switchTab('leads')" title="Base de Leads"><i class="fas fa-database"></i></button>
        <button class="nav-btn" onclick="switchTab('config')" title="Configuraci칩n"><i class="fas fa-sliders-h"></i></button>
        <div class="nav-bottom">
            <button class="nav-btn" onclick="toggleTheme()" title="Cambiar Tema"><i class="fas fa-moon" id="theme-icon"></i></button>
            <button class="nav-btn" onclick="location.href='/logout'" title="Salir"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <div class="main-area">
        
        <div id="tab-chat" class="view-panel active">
            <div class="chat-list" id="chat-list-panel">
                <div class="chat-header">
                    <div class="search-container">
                        <input type="text" class="search-bar" id="main-search" placeholder="游댌 Buscar chat o n칰mero..." onkeyup="debounceSearch(this.value)">
                        <button class="action-btn" id="bulk-toggle-btn" onclick="toggleBulkMode()" title="Selecci칩n M칰ltiple"><i class="fas fa-check-double"></i></button>
                        <button class="action-btn new-chat-btn" onclick="startNewChat()" title="Nuevo Chat"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="view-filters">
                        <span class="filter-chip active" onclick="setChatFilter('active', this)">Activos</span>
                        <span class="filter-chip" onclick="setChatFilter('unread', this)">No le칤dos</span>
                        <span class="filter-chip" onclick="setChatFilter('archived', this)">Archivados</span>
                        <select id="tag-filter" class="tag-filter-select" onchange="syncChats()">
                            <option value="">Todas las etiquetas</option>
                        </select>
                    </div>
                </div>
                <div class="chat-items" id="chat-list-container"></div>
                
                <div id="bulk-toolbar">
                    <div style="color:var(--text); font-size:0.9rem; font-weight:bold;">
                        <span id="bulk-count">0</span> seleccionados
                    </div>
                    <div class="bulk-actions-row">
                        <select id="bulk-tag-select" class="tag-filter-select" style="flex:1; margin-right: 10px;">
                            <option value="">Etiquetar como...</option>
                        </select>
                        <button class="btn-small btn-green" onclick="executeBulkAction('set_label')">Aplicar</button>
                        <button class="btn-small btn-blue" onclick="executeBulkAction('toggle_archive')" title="Archivar/Desarchivar"><i class="fas fa-archive"></i></button>
                    </div>
                </div>
            </div>

            <div class="chat-area" id="conversation-view" style="display:none;">
                <div class="chat-top">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div id="back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></div>
                        <div id="chat-header-avatar" class="avatar"><i class="fas fa-user"></i></div>
                        <div>
                            <div id="chat-header-name" style="font-weight:700; font-size:1.05rem; color:var(--text);">Selecciona un chat</div>
                            <div id="chat-header-phone" style="font-size:0.8rem; color:var(--text-muted); margin-top: 2px;"></div>
                        </div>
                    </div>
                    <button class="nav-btn" onclick="toggleCRM()"><i class="fas fa-columns"></i></button>
                </div>
                
                <div class="messages" id="messages-container"></div>
                
                <div class="input-area">
                    <button class="attach-btn" onclick="document.getElementById('file-upload').click()"><i class="fas fa-paperclip"></i></button>
                    <input type="file" id="file-upload" hidden onchange="uploadFile()" accept="image/*,video/*,audio/*,application/pdf">
                    <textarea class="input-box" id="msg-input" placeholder="Escribe un mensaje aqu칤..." onkeypress="checkEnter(event)"></textarea>
                    <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
            
            <div class="crm-panel" id="crm-panel">
                <div style="text-align:right;"><button class="btn-small btn-red" onclick="toggleCRM()"><i class="fas fa-times"></i></button></div>
                <div class="crm-section">
                    <div class="crm-title"><i class="fas fa-robot"></i> Control IA</div>
                    <div class="switch-container">
                        <span class="switch-label">ICBOT Responde</span>
                        <label class="switch">
                            <input type="checkbox" id="bot-switch" onchange="toggleBotActive()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="crm-section">
                    <div class="crm-title"><i class="fas fa-user-edit"></i> Datos del Contacto</div>
                    <input id="crm-name" class="crm-input" placeholder="Nombre Completo">
                    <input id="crm-email" class="crm-input" type="email" placeholder="Correo Electr칩nico">
                    <input id="crm-city" class="crm-input" placeholder="Ciudad">
                    <input id="crm-dept" class="crm-input" placeholder="Departamento" readonly title="Autom치tico" style="background:var(--panel); cursor:not-allowed;">
                    
                    <div class="crm-title" style="margin-top:20px;"><i class="fas fa-bullseye"></i> Perfilamiento</div>
                    <select id="crm-interest" class="crm-input">
                        <option value="">Selecciona Inter칠s...</option>
                        <option value="Maquinaria nueva">Maquinaria nueva</option>
                        <option value="Maquinaria usada">Maquinaria usada</option>
                        <option value="Volquetas">Volquetas</option>
                        <option value="Martillos Hidr치ulicos">Martillos Hidr치ulicos</option>
                        <option value="Brazos largos">Brazos largos</option>
                        <option value="Accesorios">Accesorios</option>
                        <option value="Repuestos">Repuestos</option>
                        <option value="Servicio">Servicio</option>
                        <option value="Otro">Otro</option>
                        <option value="Consultando">Consultando</option>
                    </select>

                    <div class="crm-title" style="margin-top:20px;"><i class="fas fa-user-tie"></i> Ejecutivo Asignado</div>
                    <select id="crm-executive" class="crm-input">
                        <option value="Pendiente">Pendiente (Sin Asignar)</option>
                        <option value="005Dn000007mWFhIAM">Luz</option>
                        <option value="005UO000000PdB3YAK">Felipe</option>
                        <option value="005Dn000005u1yTIAQ">Mario</option>
                        <option value="005Dn000005u27NIAQ">Marcos</option>
                        <option value="005Dn000005u22vIAA">Fabio</option>
                        <option value="005Dn000005u2BkIAI">Diana</option>
                        <option value="005Dn000007H1EUIA0">Marketing</option>
                        <option value="005Dn000003Z5vbIAC">Oscar</option>
                    </select>

                    <button class="btn-small btn-green" style="width:100%; margin-top:15px;" onclick="saveLeadManual()"><i class="fas fa-save"></i> Guardar Cambios</button>
                </div>

                <div class="crm-section"><div class="crm-title"><i class="fas fa-tags"></i> Etiqueta Comercial</div><div class="tag-container" id="tag-list"></div></div>
                <div class="crm-section"><div class="crm-title"><i class="fas fa-bolt"></i> Respuestas R치pidas</div><div class="tag-container" id="shortcuts-list"></div></div>
            </div>
        </div>

        <div id="tab-leads" class="view-panel">
            <div class="leads-container">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2><i class="fas fa-users" style="color:var(--primary);"></i> Base de Leads</h2>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-small btn-green" onclick="downloadExcel()"><i class="fas fa-file-excel"></i> Descargar CSV</button>
                        <button class="btn-small btn-blue" onclick="refreshLeads()"><i class="fas fa-sync"></i> Actualizar</button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead><tr><th>Fecha</th><th>Fuente</th><th>Nombre</th><th>Tel칠fono</th><th>Ciudad</th><th>Departamento</th><th>Correo</th><th>Inter칠s</th><th>Ejecutivo</th><th>Etiqueta Comercial</th><th>Acciones</th></tr></thead>
                        <tbody id="leads-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-config" class="view-panel">
            <div class="config-container">
                
                <div class="config-tabs-nav">
                    <button class="btn-tab active" onclick="switchConfigTab('sub-identidad', this)"><i class="fas fa-brain"></i> Identidad y Reglas</button>
                    <button class="btn-tab" onclick="switchConfigTab('sub-memoria', this)"><i class="fas fa-database"></i> Memoria y Cat치logo</button>
                    <button class="btn-tab" onclick="switchConfigTab('sub-herramientas', this)"><i class="fas fa-tools"></i> Herramientas Comerciales</button>
                </div>

                <div id="sub-identidad" class="config-sub-panel active">
                    <div class="config-header-main"><i class="fas fa-id-badge" style="color:var(--primary);"></i> Identidad del Bot</div>
                    <div class="config-row">
                        <div class="config-card" style="flex: 2;">
                            <div class="config-header">
                                <span>Personalidad (Prompt)</span>
                                <button class="btn-small btn-green" onclick="savePrompt()"><i class="fas fa-save"></i> Guardar Cambios</button>
                            </div>
                            <span class="config-subtitle">Define qui칠n es el bot, su tono de voz y su objetivo principal de ventas o atenci칩n.</span>
                            <textarea id="prompt-editor" class="prompt-textarea" placeholder="Ejemplo: Eres un asistente de ventas muy amable llamado ICBOT. Tu objetivo principal es perfilar al cliente y pedir su correo electr칩nico antes de dar precios exactos..."></textarea>
                        </div>
                        
                        <div class="config-card" style="flex: 1;">
                            <div class="config-header">Reglas Estrictas</div>
                            <span class="config-subtitle">Instrucciones que el bot nunca debe romper.</span>
                            <div class="config-input-group">
                                <input type="text" id="rule-input" class="cfg-input" placeholder="Ej: Nunca dar descuentos iniciales...">
                                <button class="btn-small btn-green" onclick="addRule()"><i class="fas fa-plus"></i></button>
                            </div>
                            <ul class="item-list" id="rules-list" style="margin-top: 15px; max-height: 250px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                </div>

                <div id="sub-memoria" class="config-sub-panel">
                    <div class="config-header-main"><i class="fas fa-book-open" style="color:var(--primary);"></i> Memoria y Datos</div>
                    <div class="config-row">
                        <div class="config-card" style="flex: 2;">
                            <div class="config-header">
                                <span>Inventario y Cat치logo (Excel/CSV)</span>
                                <span id="inventory-count" style="font-size:0.85rem; color:var(--text); background:var(--panel); padding:4px 10px; border-radius:12px; border: 1px solid var(--border);">0 items</span>
                            </div>
                            <span class="config-subtitle">Sube tu base de datos de productos para que la IA sepa precios y disponibilidad en tiempo real.</span>
                            
                            <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center; background: var(--panel); padding: 10px; border-radius: 8px;">
                                <input type="file" id="csv-upload" accept=".csv, .xlsx, .xls" style="flex:1; font-size:0.85rem;">
                                <button class="btn-small btn-green" onclick="uploadCSV()"><i class="fas fa-upload"></i> Cargar Archivo</button>
                                <button class="btn-small btn-blue" onclick="loadInventoryPreview()" title="Refrescar vista"><i class="fas fa-sync"></i></button>
                                <button class="btn-small btn-red" onclick="clearInventory()" title="Borrar todo el inventario"><i class="fas fa-trash-alt"></i></button>
                            </div>
                            <ul class="item-list" id="inventory-list" style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 10px; background: var(--bg-main);">
                                <li style="text-align:center; color:var(--text-muted); font-size:0.9rem;">Cargando inventario...</li>
                            </ul>
                        </div>
                        
                        <div class="config-card" style="flex: 1;">
                            <div class="config-header">Lectura de P치ginas Web</div>
                            <span class="config-subtitle">Pega un enlace para que el bot aprenda de esa p치gina.</span>
                            <div class="config-input-group">
                                <input type="text" id="web-url-input" class="cfg-input" placeholder="https://tuempresa.com/volquetas">
                                <button class="btn-small btn-green" onclick="scanWeb()"><i class="fas fa-plus"></i> A침adir</button>
                            </div>
                            <ul class="item-list" id="web-knowledge-list" style="margin-top: 15px; max-height: 250px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                </div>

                <div id="sub-herramientas" class="config-sub-panel">
                    <div class="config-header-main"><i class="fas fa-briefcase" style="color:var(--primary);"></i> Herramientas Operativas</div>
                    
                    <div class="config-row">
                        <div class="config-card" style="flex: 1;">
                            <div class="config-header">Perfil de Empresa</div>
                            <span class="config-subtitle">Informaci칩n b치sica del negocio.</span>
                            <div style="display:flex; gap:10px; flex-direction: column;">
                                <input id="biz-name" class="cfg-input" placeholder="Nombre Oficial de la Empresa">
                                <input id="biz-hours" class="cfg-input" placeholder="Horario de atenci칩n (Ej: Lun-Vie 8am a 6pm)">
                                <button class="btn-small btn-green" onclick="saveBizConfig()"><i class="fas fa-save"></i> Guardar Perfil</button>
                            </div>
                            <div style="margin-top:20px; font-size:0.9rem; font-weight:600; padding-top: 15px; border-top: 1px solid var(--border);">
                                Actualizar Logo del Sistema: 
                                <input type="file" onchange="uploadLogo(this)" style="margin-top: 10px; display: block; font-weight:normal;">
                            </div>
                        </div>

                        <div class="config-card" style="flex: 1;">
                            <div class="config-header">Etiquetas Visuales</div>
                            <span class="config-subtitle">Crea etiquetas de colores para organizar a los leads en el CRM.</span>
                            <div class="config-input-group">
                                <input type="text" id="tag-name" class="cfg-input" placeholder="Nombre (Ej: VIP, Seguimiento)">
                                <input type="color" id="tag-color" value="#E9521E" style="width:45px; height:40px; padding:2px; border:1px solid var(--border); border-radius:6px; cursor:pointer;">
                                <button class="btn-small btn-green" onclick="addTag()"><i class="fas fa-plus"></i></button>
                            </div>
                            <ul class="item-list" id="config-tags-list" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></ul>
                        </div>
                        
                        <div class="config-card" style="flex: 1;">
                            <div class="config-header">Respuestas R치pidas (Atajos)</div>
                            <span class="config-subtitle">Textos largos que puedes enviar usando un comando corto.</span>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <div class="config-input-group">
                                    <input type="text" id="short-key" class="cfg-input" placeholder="/hola" style="width:30%;">
                                    <input type="text" id="short-text" class="cfg-input" placeholder="Texto extenso de saludo...">
                                </div>
                                <button class="btn-small btn-green" onclick="addShortcut()"><i class="fas fa-plus"></i> Crear Atajo</button>
                            </div>
                            <ul class="item-list" id="config-shortcuts-list" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></ul>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        </div>

    <div id="web-audit-modal" class="modal-overlay" onclick="closeModal('web-audit-modal')">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title"><i class="fas fa-globe" style="color:var(--primary);"></i> Informaci칩n Aprendida</div>
            <p style="font-size:0.85rem; color:var(--text-muted); margin-top:-5px; margin-bottom:10px;">Esto es lo que el bot extrajo y memoriz칩 de la URL:</p>
            <div id="web-audit-text" style="background: var(--panel); padding: 15px; border-radius: 8px; font-size: 0.95rem; max-height: 350px; overflow-y: auto; color: var(--text); line-height: 1.6; border: 1px solid var(--border);">
                </div>
            <div class="modal-actions">
                <button class="btn-small btn-green" onclick="closeModal('web-audit-modal')">Cerrar Visor</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-box-open" style="color:var(--primary);"></i> Editar Producto</div>
            <div class="modal-form">
                <input type="hidden" id="edit-id">
                <label>Nombre del Producto</label>
                <input type="text" id="edit-nombre">
                <label>Precio</label>
                <input type="text" id="edit-precio">
                <label>Stock</label>
                <input type="text" id="edit-stock">
                <label>Descripci칩n</label>
                <textarea id="edit-desc" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button class="btn-small btn-red" onclick="closeModal('edit-modal')">Cancelar</button>
                <button class="btn-small btn-green" onclick="saveEditInventory()"><i class="fas fa-check"></i> Guardar</button>
            </div>
        </div>
    </div>

    <div id="tag-edit-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:350px;">
            <div class="modal-title"><i class="fas fa-tag" style="color:var(--primary);"></i> Editar Etiqueta</div>
            <div class="modal-form">
                <input type="hidden" id="edit-tag-id">
                <label>Nombre</label>
                <input type="text" id="edit-tag-name">
                <label>Color</label>
                <input type="color" id="edit-tag-color" style="height:45px; cursor:pointer;">
            </div>
            <div class="modal-actions">
                <button class="btn-small btn-red" onclick="closeModal('tag-edit-modal')">Cancelar</button>
                <button class="btn-small btn-green" onclick="saveTagEdit()"><i class="fas fa-check"></i> Actualizar</button>
            </div>
        </div>
    </div>

    <div id="forward-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title"><i class="fas fa-share" style="color:var(--primary);"></i> Reenviar Mensaje</div>
            <div class="modal-form">
                <p id="forward-preview" style="font-size:0.9rem; color:var(--text); font-style:italic; margin-bottom:15px; border-left:3px solid var(--primary); padding-left:10px; background:var(--panel); padding: 10px; border-radius: 4px;"></p>
                <label>Buscar Chat Destino</label>
                <input type="text" id="forward-search" placeholder="Escribe el nombre del cliente..." onkeyup="filterForwardList()">
                <div id="forward-list" style="max-height:220px; overflow-y:auto; border:1px solid var(--border); border-radius:6px; background:var(--bg-main);"></div>
            </div>
            <div class="modal-actions">
                <button class="btn-small btn-red" onclick="closeModal('forward-modal')">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="lead-details-modal" class="modal-overlay" onclick="closeModal('lead-details-modal')">
        <div class="modal-content" onclick="event.stopPropagation()" style="max-width: 600px;">
            <div class="modal-title"><i class="fas fa-address-card" style="color:var(--primary);"></i> Detalles Completos del Lead</div>
            <div id="lead-details-content" style="font-size: 0.95rem; max-height: 450px; overflow-y: auto; background: var(--bg-main); border: 1px solid var(--border); border-radius: 6px; padding: 10px;"></div>
            <div class="modal-actions">
                <button class="btn-small btn-green" onclick="closeModal('lead-details-modal')">Cerrar</button>
            </div>
        </div>
    </div>

    <div id="lightbox-modal" class="modal-overlay" onclick="closeLightbox(event)">
        <span class="lightbox-close" onclick="closeLightbox(event)">&times;</span>
        <div class="lightbox-content-container">
            <img id="lightbox-img" style="display:none; max-width:90%; max-height:90%; border-radius:8px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);">
            <video id="lightbox-video" controls style="display:none; max-width:90%; max-height:90%; border-radius:8px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); outline:none; background: #000;"></video>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" id="ctx-pin" onclick="togglePinContext()"><i class="fas fa-thumbtack"></i> <span>Fijar Chat</span></div>
        <div class="ctx-item" onclick="quickLabel()"><i class="fas fa-tag"></i> Etiquetar</div>
        <div class="ctx-item" id="ctx-archive" onclick="contextAction('toggle_archive')"><i class="fas fa-archive"></i> <span>Archivar</span></div>
        <div class="ctx-divider"></div>
        <div class="ctx-item" onclick="contextAction('delete')" style="color:#ef4444;"><i class="fas fa-trash"></i> Eliminar Chat</div>
    </div>

    <div id="toast">Notificaci칩n</div>

    <script>
        const socket = io(); // 丘 INICIAMOS EL T칔NEL WEBSOCKET

        let currentChat = null, currentFilter = 'active', chatsData = [], contextPhone = null, searchTimeout = null;
        let currentlyPlaying = null;
        let currentInventory = []; 
        
        let bulkMode = false;
        let selectedChats = new Set();
        let msgToForward = null;

        const executivesMap = {
            "005Dn000007mWFhIAM": "Luz",
            "005UO000000PdB3YAK": "Felipe",
            "005Dn000005u1yTIAQ": "Mario",
            "005Dn000005u27NIAQ": "Marcos",
            "005Dn000005u22vIAA": "Fabio",
            "005Dn000005u2BkIAI": "Diana",
            "005Dn000007H1EUIA0": "Marketing",
            "005Dn000003Z5vbIAC": "Oscar",
            "Pendiente": "Pendiente (Sin Asignar)"
        };

        window.onload = function() { 
            startSyncLoop(); 
            refreshLeads(); 
            loadAllConfig(); 
            loadTagFilterOptions(); 
            
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);

            document.addEventListener('click', (e) => { 
                if(!e.target.closest('.chat-item')) document.getElementById('context-menu').style.display = 'none'; 
            }); 
        };

        // --- 游니 ESCUCHADORES DEL WEBSOCKET EN TIEMPO REAL ---
        socket.on('update_chats_list', () => {
            syncChats(); // Solo recarga la barra lateral si Meta avisa que hay novedades
        });

        socket.on('new_message', (msg) => {
            // Si nos llega un mensaje y justo estamos viendo ese chat...
            if (currentChat === msg.phone) {
                const container = document.getElementById('messages-container');
                const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 50;
                
                // "Pegamos" el mensaje nuevo AL FINAL sin destruir la pantalla (춰adi칩s efecto fantasma y audios cortados!)
                container.insertAdjacentHTML('beforeend', buildMessageHTML(msg));
                
                if(isScrolledToBottom || msg.role === 'bot' || msg.role === 'manual') {
                    setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
                }
            }
        });
        // ----------------------------------------------------

        /* L칍GICA DE SUB-PESTA칌AS DE CONFIGURACI칍N */
        function switchConfigTab(tabId, btnElement) {
            // Ocultar todos los paneles de configuraci칩n
            document.querySelectorAll('.config-sub-panel').forEach(panel => panel.classList.remove('active'));
            // Mostrar el panel seleccionado
            document.getElementById(tabId).classList.add('active');
            
            // Actualizar el estilo de los botones
            document.querySelectorAll('.btn-tab').forEach(btn => btn.classList.remove('active'));
            btnElement.classList.add('active');
        }

        /* L칍GICA MODO OSCURO */
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }
        function updateThemeIcon(theme) {
            const icon = document.getElementById('theme-icon');
            if(theme === 'dark') { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
            else { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); }
        }

        function showToast(msg) { const x = document.getElementById("toast"); x.innerText = msg; x.className = "show"; setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000); }
        function closeModal(id) { document.getElementById(id).classList.remove('show'); }
        
        /* L칩gica del Lightbox (Visor de Medios) */
        function openLightbox(url, type) {
            const modal = document.getElementById('lightbox-modal');
            const img = document.getElementById('lightbox-img');
            const vid = document.getElementById('lightbox-video');
            modal.classList.add('show');
            if (type === 'IMAGE') {
                img.src = url; img.style.display = 'block'; vid.style.display = 'none'; vid.pause();
            } else if (type === 'VIDEO') {
                vid.src = url; vid.style.display = 'block'; img.style.display = 'none'; vid.play();
            }
        }
        function closeLightbox(e) {
            if(e.target.id === 'lightbox-modal' || e.target.classList.contains('lightbox-close')) {
                document.getElementById('lightbox-modal').classList.remove('show');
                document.getElementById('lightbox-video').pause();
            }
        }

        /* L칩gica visualizador completo Leads */
        function viewLeadDetails(phone) {
            fetch('/api/data/leads').then(r=>r.json()).then(leads => {
                const lead = leads.find(l => l.phone === phone);
                if(lead) {
                    let html = '<table class="data-table" style="width:100%;">';
                    for(let key in lead) {
                        html += `<tr><td style="font-weight:600; text-transform:capitalize; width: 35%; border-right: 1px solid var(--border);">${key}</td><td style="white-space:normal; padding-left:15px;">${lead[key] || '-'}</td></tr>`;
                    }
                    html += '</table>';
                    document.getElementById('lead-details-content').innerHTML = html;
                    document.getElementById('lead-details-modal').classList.add('show');
                }
            }).catch(e => showToast("Error cargando informaci칩n del lead."));
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(tab === 'leads') refreshLeads();
            if(tab === 'config') loadInventoryPreview();
        }
        function toggleCRM() { document.getElementById('crm-panel').classList.toggle('open'); }
        function closeChat() { 
            document.body.classList.remove('mobile-chat-open'); 
            currentChat = null; 
            if(currentlyPlaying) { currentlyPlaying.pause(); currentlyPlaying = null; }
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
        }
        function debounceSearch(val) { clearTimeout(searchTimeout); searchTimeout = setTimeout(() => syncChats(), 300); }
        function startNewChat() { const phone = prompt("Ingresa el n칰mero (con indicativo):"); if (!phone) return; const name = prompt("Nombre:") || phone; openChat(phone.replace(/\D/g, ''), name, ''); }
        
        // --- 游 ADI칍S POLLING, HOLA EFICIENCIA ---
        function startSyncLoop() { 
            syncChats(); 
            // Los viejos setInterval que sobrecargaban todo y destru칤an tu audio ya no existen aqu칤.
        }
        
        async function loadTagFilterOptions() { try { const tags = await (await fetch('/api/data/tags')).json(); 
            const html = '<option value="">Todas las etiquetas</option>' + tags.map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            document.getElementById('tag-filter').innerHTML = html;
            document.getElementById('bulk-tag-select').innerHTML = '<option value="">Etiquetar como...</option>' + tags.map(t => `<option value='${JSON.stringify({text:t.name, color:t.color})}'>${t.name}</option>`).join('');
        } catch(e) {} }
        
        async function syncChats() { 
            try { 
                const search = document.getElementById('main-search').value; 
                const res = await fetch(`/api/chats-full?view=${currentFilter}&search=${search}`); 
                chatsData = await res.json(); 
                const tagFilter = document.getElementById('tag-filter').value; 
                if(tagFilter) chatsData = chatsData.filter(c => c.labels && c.labels.some(l => (l.text || l) === tagFilter)); 
                chatsData.sort((a, b) => new Date(b.lastMessage.time) - new Date(a.lastMessage.time)); 
                chatsData.sort((a, b) => (b.pinned ? 1 : 0) - (a.pinned ? 1 : 0)); 
                renderChatList(); 
            } catch(e) {} 
        }

        function setChatFilter(filter, el) { currentFilter = filter; document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active')); el.classList.add('active'); syncChats(); }
        function normalizeTag(tag) { return typeof tag === 'string' ? { text: tag, color: '#555' } : tag; }
        
        function toggleBulkMode() {
            bulkMode = !bulkMode;
            const btn = document.getElementById('bulk-toggle-btn');
            const toolbar = document.getElementById('bulk-toolbar');
            const panel = document.getElementById('chat-list-panel');
            
            if (bulkMode) {
                btn.classList.add('active');
                panel.classList.add('bulk-mode');
                toolbar.classList.add('show');
            } else {
                btn.classList.remove('active');
                panel.classList.remove('bulk-mode');
                toolbar.classList.remove('show');
                selectedChats.clear();
                renderChatList();
            }
        }

        function toggleChatSelection(phone, event) {
            if (!bulkMode) return;
            event.stopPropagation();
            if (selectedChats.has(phone)) selectedChats.delete(phone);
            else selectedChats.add(phone);
            document.getElementById('bulk-count').innerText = selectedChats.size;
            renderChatList();
        }

        async function executeBulkAction(action) {
            if (selectedChats.size === 0) return alert("Selecciona al menos un chat");
            
            let value = null;
            if (action === 'set_label') {
                const valStr = document.getElementById('bulk-tag-select').value;
                if (!valStr) return alert("Selecciona una etiqueta");
                value = JSON.parse(valStr);
                action = 'add_label';
            }

            if (!confirm(`쮸plicar acci칩n a ${selectedChats.size} chats?`)) return;

            await fetch('/api/contacts/bulk-update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    phones: Array.from(selectedChats),
                    action: action,
                    value: value
                })
            });

            showToast("Acci칩n masiva completada");
            toggleBulkMode();
            syncChats();
        }
        
        function renderChatList() {
            const container = document.getElementById('chat-list-container'); 
            const scroll = container.children.length > 0 ? container.scrollTop : 0;
            
            container.innerHTML = chatsData.map(c => {
                let labelsHtml = ''; if(c.labels && Array.isArray(c.labels)) labelsHtml = c.labels.map(l => { const tag = normalizeTag(l); return `<span class="mini-tag" style="background:${tag.color}20; color:${tag.color}; border:1px solid ${tag.color}50">${tag.text}</span>` }).join('');
                
                let sourceBadge = '';
                if(c.source && c.source.includes('Ads')) sourceBadge = `<span class="badge" style="background:#ff0000; color:#fff;">ADS</span>`;
                else if(c.source === 'Web') sourceBadge = `<span class="badge" style="background:#1e3a8a; color:#fff;">WEB</span>`;
                else if(c.source === 'Tienda Virtual') sourceBadge = `<span class="badge" style="background:#a21caf; color:#fff;">TIENDA</span>`;

                const isSelected = selectedChats.has(c.id);

                return `<div id="chat-${c.id}" class="chat-item ${currentChat === c.id ? 'active' : ''} ${c.archived ? 'archived' : ''}" onclick="openChat('${c.id}', '${c.name}', '${c.photoUrl || ''}')" oncontextmenu="showContextMenu(event, '${c.id}', ${c.pinned}, ${c.archived})">
                    <input type="checkbox" class="bulk-checkbox" ${isSelected ? 'checked' : ''} onclick="toggleChatSelection('${c.id}', event)">
                    <div class="avatar">${c.photoUrl ? `<img src="${c.photoUrl}" style="width:100%;height:100%;object-fit:cover;">` : '<i class="fas fa-user"></i>'}</div>
                    <div class="chat-info">
                        <div class="chat-name">
                            <span>${c.name} ${c.pinned ? '<i class="fas fa-thumbtack pin-icon" style="color:var(--primary); font-size:0.8rem;"></i>' : ''}</span>
                            <span class="chat-date" style="font-weight:400; font-size:0.75rem;">${new Date(c.lastMessage.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                        </div>
                        <div class="chat-preview">
                            <span class="chat-last-msg">${c.lastMessage.text || 'Multimedia'}</span>
                            <div style="display:flex; gap:3px;">${c.unreadCount > 0 ? `<span class="badge">${c.unreadCount}</span>` : ''}${sourceBadge}</div>
                        </div>
                        <div class="mini-tags">${labelsHtml}</div>
                    </div>
                </div>`;
            }).join(''); 
            
            if(scroll > 0) container.scrollTop = scroll;
        }

        function showContextMenu(e, phone, isPinned, isArchived) { e.preventDefault(); contextPhone = phone; const menu = document.getElementById('context-menu'); const pinBtn = document.getElementById('ctx-pin'); pinBtn.innerHTML = isPinned ? '<i class="fas fa-thumbtack" style="opacity:0.5"></i> <span>Desfijar Chat</span>' : '<i class="fas fa-thumbtack"></i> <span>Fijar Chat</span>'; pinBtn.onclick = () => contextAction('toggle_pin'); const archBtn = document.getElementById('ctx-archive'); archBtn.innerHTML = isArchived ? '<i class="fas fa-box-open"></i> <span>Desarchivar</span>' : '<i class="fas fa-archive"></i> <span>Archivar</span>'; archBtn.onclick = () => contextAction('toggle_archive'); menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px'; }
        async function contextAction(action, valueOverride = true) { if(!contextPhone) return; if(action === 'delete' && !confirm("쮼LIMINAR CHAT EST츼 SEGURO?")) return; await fetch('/api/chat/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: contextPhone, action: action, value: valueOverride }) }); syncChats(); document.getElementById('context-menu').style.display = 'none'; }
        function quickLabel() { if(!contextPhone) return; const chat = chatsData.find(c => c.id === contextPhone); if(chat) openChat(chat.id, chat.name, chat.photoUrl); document.getElementById('crm-panel').classList.add('open'); document.getElementById('context-menu').style.display = 'none'; }
        
        async function openChat(phone, name, photo) { 
            if(bulkMode) return toggleChatSelection(phone, event); 

            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            const clickedItem = document.getElementById(`chat-${phone}`);
            if(clickedItem) clickedItem.classList.add('active');

            currentChat = phone; 
            document.body.classList.add('mobile-chat-open'); 
            document.getElementById('conversation-view').style.display = 'flex'; 
            document.getElementById('chat-header-name').innerText = name; 
            document.getElementById('chat-header-phone').innerText = '+' + phone; 
            
            const headerAvatar = document.getElementById('chat-header-avatar');
            if(photo) {
                headerAvatar.innerHTML = `<img src="${photo}" style="width:100%;height:100%;object-fit:cover;">`;
            } else {
                headerAvatar.innerHTML = `<i class="fas fa-user"></i>`;
            }

            document.getElementById('messages-container').innerHTML = `<div style="display:flex; justify-content:center; align-items:center; height:100%; color:var(--text-muted); flex-direction:column; gap:10px;"><i class="fas fa-circle-notch fa-spin fa-2x" style="color:var(--primary);"></i><span style="font-size:0.9rem;">Cargando historial...</span></div>`; 
            
            const chatInfo = chatsData.find(c => c.id === phone); 
            document.getElementById('bot-switch').checked = chatInfo ? chatInfo.botActive : true; 
            loadLeadDataToCRM(phone); 
            loadTags(phone); 
            await loadMessages(phone, true); 
        }
        
        function formatSmartTime(iso) {
            if(!iso) return '';
            const d = new Date(iso);
            const now = new Date();
            const isToday = d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            const timeStr = d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            if (isToday) return timeStr;
            const dateStr = d.toLocaleDateString([], {day: '2-digit', month: '2-digit', year:'2-digit'});
            return `${dateStr} ${timeStr}`;
        }

        // --- CREADOR DE GLOBITOS DE CHAT REUTILIZABLE ---
        function buildMessageHTML(m) {
            let text = m.text;
            let isMedia = false;
            let mediaId = null;

            if(text.includes('[MEDIA:')) { 
                isMedia = true;
                const parts = text.split(':'); 
                const type = parts[1]; 
                const id = parts[2].split(']')[0].replace(/\D/g, ''); 
                const extraCaption = text.split(']').slice(1).join(']').trim(); 
                mediaId = id;
                const mediaUrl = `/api/media-proxy/${id}?v=final`; 
                
                let captionHtml = extraCaption ? `<div style="margin-top:8px; font-size:0.9rem;">${extraCaption}</div>` : '';

                if(type === 'IMAGE') { 
                    text = `<div style="display:flex; flex-direction:column; gap:5px;"><img src="${mediaUrl}" style="max-width:250px; border-radius:8px; cursor:pointer; min-height:100px; background:var(--border); transition:transform 0.2s;" onclick="openLightbox('${mediaUrl}', 'IMAGE')" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'" onerror="this.style.display='none';this.nextElementSibling.style.display='block';"><div style="display:none; color:#ef4444; font-size:0.8rem; padding:10px; border:1px dashed #ef4444; border-radius:8px;">丘멆잺 Error de imagen.</div>${captionHtml}</div>`; 
                }
                else if(type === 'VIDEO') {
                    text = `<div style="display:flex; flex-direction:column; gap:5px;"><div style="position:relative; width:250px; cursor:pointer; overflow:hidden; border-radius:8px; background:#000; transition:transform 0.2s;" onclick="openLightbox('${mediaUrl}', 'VIDEO')" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'"><video src="${mediaUrl}" style="width:100%; opacity:0.8;" preload="metadata"></video><div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:rgba(233,82,30,0.8); border-radius:50%; width:45px; height:45px; display:flex; align-items:center; justify-content:center; color:white;"><i class="fas fa-play" style="margin-left:3px;"></i></div></div>${captionHtml}</div>`;
                }
                else if(type === 'AUDIO') {
                    text = `<div class="audio-wrapper">
                        <button class="play-btn" id="btn-${id}" onclick="togglePlay('${id}', '${mediaUrl}')">
                            <i class="fas fa-play" style="margin-left:3px;"></i>
                        </button>
                        <div class="audio-progress">
                            <input type="range" class="wa-slider" id="seek-${id}" min="0" max="100" value="0" onchange="seekAudio('${id}', this.value)" oninput="pauseForSeek('${id}')">
                            <div class="audio-time">
                                <span id="time-${id}">0:00</span>
                                <span id="dur-${id}"></span>
                            </div>
                        </div>
                        <audio id="audio-${id}" ontimeupdate="updateProgress('${id}')" onloadedmetadata="setAudioDuration('${id}')" onended="resetPlayer('${id}')" onplaying="onAudioStart('${id}')" style="display:none;"></audio>
                        <a href="${mediaUrl}" download="nota_voz.ogg" class="btn-download-audio" title="Descargar Audio">
                            <i class="fas fa-download"></i>
                        </a>
                    </div>`;
                } else { 
                    text = `<a href="${mediaUrl}" target="_blank" style="color:white; text-decoration:none; display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.2); padding:10px; border-radius:6px; transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'"><i class="fas fa-file-download" style="font-size:1.5rem;"></i><div style="display:flex; flex-direction:column;"><span>Archivo Adjunto (${type})</span><span style="font-size:0.75rem; font-weight:600; color:#FFF;">Clic para descargar</span></div></a>${captionHtml}`; 
                }
            } 
            
            const safeText = m.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const isAlert = text.includes('[ALERTA:');
            
            return `<div class="msg ${isAlert ? 'alert' : m.role}">
                ${text}
                <div class="msg-time">${formatSmartTime(m.time)}</div>
                ${!isAlert ? `<div class="msg-forward-btn" onclick="openForwardModal('${safeText}', ${isMedia}, '${mediaId}')" title="Reenviar Mensaje">
                    <i class="fas fa-share"></i>
                </div>` : ''}
            </div>`;
        }

        async function loadMessages(phone, scrollDown) {
            try { 
                const res = await fetch(`/api/chat-history/${phone}`); 
                const msgs = await res.json(); 
                if(currentChat !== phone) return; 
                const container = document.getElementById('messages-container');
                // Ahora usamos el constructor para armar todo el historial la primera vez
                container.innerHTML = msgs.map(m => buildMessageHTML(m)).join(''); 
                if(scrollDown) setTimeout(() => { container.scrollTop = container.scrollHeight; }, 50);
            } catch(e) {}
        }

        function openForwardModal(content, isMedia, mediaId) {
            msgToForward = { content, isMedia, mediaId };
            let preview = "";
            if (isMedia) preview = "Multimedia (Imagen/Audio/Video/Doc)";
            else preview = content.substring(0, 50) + "...";
            
            document.getElementById('forward-preview').innerText = "Reenviando: " + preview;
            document.getElementById('forward-modal').classList.add('show');
            renderForwardList(chatsData);
        }

        function filterForwardList() {
            const term = document.getElementById('forward-search').value.toLowerCase();
            const filtered = chatsData.filter(c => c.name.toLowerCase().includes(term) || c.id.includes(term));
            renderForwardList(filtered);
        }

        function renderForwardList(list) {
            const container = document.getElementById('forward-list');
            container.innerHTML = list.map(c => `
                <div style="padding:12px 15px; border-bottom:1px solid var(--border); cursor:pointer; display:flex; align-items:center; gap:12px; transition:background 0.2s;" onmouseover="this.style.background='var(--hover-item)'" onmouseout="this.style.background='transparent'" onclick="executeForward('${c.id}')">
                    <div class="avatar" style="width:35px; height:35px;">${c.photoUrl ? `<img src="${c.photoUrl}" style="width:100%;height:100%;">` : '<i class="fas fa-user"></i>'}</div>
                    <div style="font-size:0.95rem; font-weight:500; color:var(--text);">${c.name}</div>
                </div>
            `).join('');
        }

        async function executeForward(targetPhone) {
            if(!msgToForward) return;
            closeModal('forward-modal');
            
            await fetch('/api/chat/send', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ phone: targetPhone, message: msgToForward.content })
            });
            
            showToast("Mensaje reenviado exitosamente");
        }

        // --- FUNCIONES DEL REPRODUCTOR DE AUDIO WHATSAPP ---
        async function togglePlay(id, url) { 
            const audio = document.getElementById(`audio-${id}`); 
            const btn = document.getElementById(`btn-${id}`); 
            
            if (audio.paused) { 
                if (currentlyPlaying && currentlyPlaying !== audio) { 
                    currentlyPlaying.pause(); 
                    resetPlayer(currentlyPlaying.id.replace('audio-', '')); 
                } 
                
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
                
                if (!audio.src || audio.src === window.location.href) {
                    audio.src = url;
                    audio.load();
                }
                
                audio.play().then(() => { 
                    currentlyPlaying = audio; 
                }).catch((error) => { 
                    console.error("Error reproduciendo:", error);
                    btn.innerHTML = '<i class="fas fa-play" style="margin-left:3px;"></i>'; 
                });
            } else { 
                audio.pause(); 
                btn.innerHTML = '<i class="fas fa-play" style="margin-left:3px;"></i>'; 
            } 
        }

        function onAudioStart(id) { 
            document.getElementById(`btn-${id}`).innerHTML = '<i class="fas fa-pause"></i>'; 
        }

        function updateProgress(id) { 
            const audio = document.getElementById(`audio-${id}`); 
            const slider = document.getElementById(`seek-${id}`); 
            const time = document.getElementById(`time-${id}`); 
            
            if (audio && audio.duration && !audio.paused) { 
                const percent = (audio.currentTime / audio.duration) * 100; 
                slider.value = percent; 
                
                const mins = Math.floor(audio.currentTime / 60); 
                const secs = Math.floor(audio.currentTime % 60); 
                time.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`; 
            } 
        }

        function setAudioDuration(id) {
            const audio = document.getElementById(`audio-${id}`);
            const durText = document.getElementById(`dur-${id}`);
            if (audio.duration && isFinite(audio.duration)) {
                const mins = Math.floor(audio.duration / 60);
                const secs = Math.floor(audio.duration % 60);
                durText.innerText = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        }

        function pauseForSeek(id) {
            const audio = document.getElementById(`audio-${id}`);
            if(!audio.paused) audio.pause();
        }

        function seekAudio(id, value) {
            const audio = document.getElementById(`audio-${id}`);
            if(audio.duration) {
                audio.currentTime = (value / 100) * audio.duration;
                audio.play();
                document.getElementById(`btn-${id}`).innerHTML = '<i class="fas fa-pause"></i>'; 
                currentlyPlaying = audio;
            }
        }

        function resetPlayer(id) { 
            document.getElementById(`btn-${id}`).innerHTML = '<i class="fas fa-play" style="margin-left:3px;"></i>'; 
            document.getElementById(`seek-${id}`).value = 0; 
            const time = document.getElementById(`time-${id}`);
            if(time) time.innerText = "0:00";
        }
        // --------------------------------------------------------

        async function uploadFile() {
            const input = document.getElementById('file-upload');
            if(!input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            formData.append('phone', currentChat);
            const type = input.files[0].type.startsWith('image/') ? 'image' : 
                         (input.files[0].type.startsWith('audio/') ? 'audio' : 
                         (input.files[0].type.startsWith('video/') ? 'video' : 'document'));
            formData.append('type', type);
            
            showToast("Enviando archivo... 낍");
            // Delegamos el dibujo al WebSocket, evitamos duplicados
            await fetch('/api/chat/upload-send', { method: 'POST', body: formData });
            input.value = ''; 
        }

        async function sendMessage() { 
            const txt = document.getElementById('msg-input').value; 
            if(!txt) return; 
            document.getElementById('msg-input').value = ''; 
            
            // Enviamos el mensaje en silencio. El WebSocket nos devolver치 la orden de renderizarlo al instante.
            await fetch('/api/chat/send', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: currentChat, message: txt }) }); 
        }

        function checkEnter(e) { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
        async function toggleBotActive() { const active = document.getElementById('bot-switch').checked; await fetch('/api/chat/toggle-bot', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: currentChat, active }) }); showToast(active ? "游뱄 ICBOT Activado" : "낒勇 ICBOT Pausado"); }
        
        async function loadLeadDataToCRM(phone) { 
            document.getElementById('crm-name').value=""; 
            document.getElementById('crm-city').value=""; 
            document.getElementById('crm-dept').value=""; 
            document.getElementById('crm-email').value=""; 
            document.getElementById('crm-interest').value=""; 
            document.getElementById('crm-executive').value="Pendiente"; 

            const res = await fetch('/api/data/leads'); 
            const leads = await res.json(); 
            const lead = leads.find(l => l.phone === phone); 
            
            if(lead) { 
                document.getElementById('crm-name').value = lead.nombre||""; 
                document.getElementById('crm-city').value = lead.ciudad||""; 
                document.getElementById('crm-dept').value = lead.departamento||""; 
                document.getElementById('crm-email').value = lead.correo||""; 
                
                let interestSelect = document.getElementById('crm-interest');
                let foundInterest = false;
                if(lead.interes) {
                    for(let opt of interestSelect.options) {
                        if(opt.value.toUpperCase() === lead.interes.toUpperCase()) {
                            interestSelect.value = opt.value;
                            foundInterest = true; break;
                        }
                    }
                    if(!foundInterest) interestSelect.value = "Consultando";
                }

                let execSelect = document.getElementById('crm-executive');
                if (lead.etiqueta && executivesMap[lead.etiqueta]) {
                    execSelect.value = lead.etiqueta;
                } else {
                    execSelect.value = "Pendiente";
                }
            } 
        }

        async function saveLeadManual() { 
            if(!currentChat) return; 
            const res = await fetch('/api/data/leads'); 
            const leads = await res.json(); 
            const lead = leads.find(l => l.phone === currentChat); 
            const id = lead ? lead.id : null; 
            
            if(id) { 
                const updates = [
                    {field:'nombre', value:document.getElementById('crm-name').value},
                    {field:'ciudad', value:document.getElementById('crm-city').value},
                    {field:'correo', value:document.getElementById('crm-email').value},
                    {field:'interes', value:document.getElementById('crm-interest').value},
                    {field:'etiqueta', value:document.getElementById('crm-executive').value}
                ]; 
                for(let u of updates) {
                    await fetch('/api/leads/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, field: u.field, value: u.value }) }); 
                }
                showToast("九 Base de Datos Actualizada"); 
                refreshLeads(); 
            } else { 
                showToast("丘멆잺 Espera un primer mensaje del cliente."); 
            } 
        }
        
        function downloadExcel() { 
            const rows = [['Fecha', 'Fuente', 'Nombre', 'Telefono', 'Ciudad', 'Departamento', 'Correo', 'Interes', 'Ejecutivo ID', 'Etiqueta Comercial']]; 
            const table = document.getElementById('leads-body'); 
            
            for (let tr of table.rows) { 
                const cells = Array.from(tr.cells);
                const rowData = [
                    cells[0].innerText,
                    cells[1].innerText,
                    cells[2].innerText,
                    cells[3].innerText,
                    cells[4].innerText,
                    cells[5].innerText,
                    cells[6].innerText,
                    cells[7].innerText,
                    tr.getAttribute('data-exec-id'),
                    cells[9].innerText
                ];
                rows.push(rowData); 
            } 
            
            let csvContent = "\uFEFF";
            csvContent += rows.map(e => e.map(v => `"${v ? String(v).replace(/"/g, '""') : ''}"`).join(",")).join("\n"); 
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); 
            link.href = URL.createObjectURL(blob);
            link.download = "leads_icbot.csv"; 
            document.body.appendChild(link); 
            link.click(); 
        }

        function loadTags(phone) { fetch('/api/data/tags').then(r=>r.json()).then(t => renderCRMTags(t)); }
        function renderCRMTags(tags) { const chat = chatsData.find(c => c.id === currentChat); const activeTags = chat ? chat.labels : []; document.getElementById('tag-list').innerHTML = tags.map(t => { const isActive = activeTags && activeTags.some(at => normalizeTag(at).text === t.name); return `<span class="tag ${isActive ? 'selected' : ''}" style="border-color:${t.color}; color:${isActive?'#fff':t.color}; background:${isActive?t.color:'transparent'}" onclick="toggleChatTag('${t.name}', '${t.color}')">${t.name}</span>`; }).join(''); }
        async function toggleChatTag(name, color) { if(!currentChat) return; const chat = chatsData.find(c => c.id === currentChat); let labels = chat.labels || []; const exists = labels.some(l => normalizeTag(l).text === name); if(exists) labels = labels.filter(l => normalizeTag(l).text !== name); else labels.push({text: name, color}); await fetch('/api/chat/action', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ phone: currentChat, action: 'set_labels', value: labels }) }); const res = await fetch('/api/data/leads'); const leads = await res.json(); const lead = leads.find(l => l.phone === currentChat); if(lead) { const newStatus = exists ? (labels.length > 0 ? labels[0].text : "Sin Etiqueta") : name; await fetch('/api/leads/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id: lead.id, field: 'status_tag', value: newStatus }) }); } syncChats(); setTimeout(() => { loadTags(currentChat); refreshLeads(); }, 300); }
        async function loadAllConfig() { 
            const res = await fetch('/api/data/config'); 
            const cfg = await res.json(); 
            document.getElementById('prompt-editor').value = cfg.prompt || ''; 
            document.getElementById('biz-name').value = cfg.biz_profile?.name || ''; 
            document.getElementById('biz-hours').value = cfg.biz_profile?.hours || ''; 
            renderWebList(); 
            renderRulesList(cfg.tech_rules); 
            fetch('/api/data/tags').then(r=>r.json()).then(t => renderConfigTags(t)); 
            fetch('/api/data/shortcuts').then(r=>r.json()).then(s => renderConfigShortcuts(s)); 
            
            // L칈NEA COMENTADA PARA EVITAR QUE EL LOGO DE ICC REEMPLACE A VALENTINA
            // if(cfg.logo_url) document.getElementById('logo-preview').style.backgroundImage = `url('${cfg.logo_url}')`; 
            
            loadInventoryPreview();
        }
        async function saveBizConfig() { await fetch('/api/config/biz/save', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name: document.getElementById('biz-name').value, hours: document.getElementById('biz-hours').value }) }); showToast("Perfil Comercial Actualizado"); }
        async function savePrompt() { await fetch('/api/config/prompt', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ prompt: document.getElementById('prompt-editor').value }) }); showToast("Comportamiento IA Guardado"); }
        async function uploadLogo(input) { const fd = new FormData(); fd.append('file', input.files[0]); await fetch('/api/config/logo', { method: 'POST', body: fd }); showToast("Logo Actualizado Exitosamente"); loadAllConfig(); }
        async function uploadCSV() { 
            const input = document.getElementById('csv-upload'); 
            if(!input.files[0]) return alert("Por favor, selecciona un archivo CSV o Excel"); 
            const fd = new FormData(); 
            fd.append('file', input.files[0]); 
            await fetch('/api/knowledge/csv', { method: 'POST', body: fd }); 
            showToast("Inventario Cargado con 칄xito"); 
            loadInventoryPreview();
        }
        async function clearInventory() { if(!confirm("쮼st치s 100% seguro de borrar TODO el inventario?")) return; await fetch('/api/knowledge/clear', { method: 'POST' }); showToast("Inventario Eliminado"); loadInventoryPreview(); }
        
        async function renderWebList() { const res = await fetch('/api/data/web-knowledge'); const list = await res.json(); document.getElementById('web-knowledge-list').innerHTML = list.map(i => `<li class="config-item"><span style="max-width:200px; overflow:hidden; text-overflow:ellipsis;">${i.url}</span><div style="display:flex; gap:5px;"><button class="btn-small btn-blue" onclick="showWebInfo('${encodeURIComponent(i.summary)}')"><i class="fas fa-eye"></i></button><button class="btn-small btn-red" onclick="deleteWeb('${i.id}')"><i class="fas fa-trash"></i></button></div></li>`).join(''); }
        
        // --- FUNCI칍N MODIFICADA PARA USAR EL MODAL EN LUGAR DE ALERT() ---
        function showWebInfo(summary) { 
            document.getElementById('web-audit-text').innerText = decodeURIComponent(summary);
            document.getElementById('web-audit-modal').classList.add('show');
        }
        
        async function scanWeb() { const url = document.getElementById('web-url-input').value; const summary = prompt("Ingresa un resumen corto para esta p치gina:"); if(summary) { await fetch('/api/data/web-knowledge', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ url, summary }) }); document.getElementById('web-url-input').value = ""; renderWebList(); } }
        async function deleteWeb(id) { await fetch('/api/data/web-knowledge/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) }); renderWebList(); }
        function renderRulesList(rules) { document.getElementById('rules-list').innerHTML = (rules || []).map((r, i) => `<li class="config-item"><span>${r}</span><button class="btn-small btn-red" onclick="deleteRule(${i})"><i class="fas fa-trash"></i></button></li>`).join(''); }
        async function addRule() { const r = document.getElementById('rule-input').value; if(!r) return; const res = await fetch('/api/config/rules/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ rule: r }) }); const data = await res.json(); renderRulesList(data.rules); document.getElementById('rule-input').value = ""; }
        async function deleteRule(i) { const res = await fetch('/api/config/rules/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ index: i }) }); const data = await res.json(); renderRulesList(data.rules); }
        
        // --- TAG CRUD ---
        function renderConfigTags(tags) { 
            document.getElementById('config-tags-list').innerHTML = tags.map(t => `<li class="config-item">
                <span style="color:${t.color};font-weight:600;"><i class="fas fa-circle" style="font-size:0.6rem; vertical-align:middle; margin-right:5px;"></i> ${t.name}</span>
                <div style="display:flex; gap:5px;">
                    <button class="btn-small btn-blue" onclick="editTag(${t.id}, '${t.name}', '${t.color}')"><i class="fas fa-pencil-alt"></i></button>
                    <button class="btn-small btn-red" onclick="deleteTag(${t.id})"><i class="fas fa-trash"></i></button>
                </div>
            </li>`).join(''); 
            renderCRMTags(tags); 
        }
        async function addTag() { const name = document.getElementById('tag-name').value; const color = document.getElementById('tag-color').value; if(!name) return; await fetch('/api/tags/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ name, color }) }); loadAllConfig(); document.getElementById('tag-name').value = ""; }
        async function deleteTag(id) { await fetch('/api/tags/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) }); loadAllConfig(); }
        
        function editTag(id, name, color) {
            document.getElementById('edit-tag-id').value = id;
            document.getElementById('edit-tag-name').value = name;
            document.getElementById('edit-tag-color').value = color;
            document.getElementById('tag-edit-modal').classList.add('show');
        }
        async function saveTagEdit() {
            const id = document.getElementById('edit-tag-id').value;
            const name = document.getElementById('edit-tag-name').value;
            const color = document.getElementById('edit-tag-color').value;
            await fetch('/api/tags/update', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id, name, color }) });
            closeModal('tag-edit-modal');
            loadAllConfig();
            showToast("Etiqueta actualizada correctamente");
        }

        function renderConfigShortcuts(shortcuts) { const list = shortcuts.map(s => `<li class="config-item"><span style="color:var(--primary);"><b>${s.keyword}</b></span><button class="btn-small btn-red" onclick="deleteShortcut(${s.id})"><i class="fas fa-trash"></i></button></li>`).join(''); document.getElementById('config-shortcuts-list').innerHTML = list; document.getElementById('shortcuts-list').innerHTML = shortcuts.map(s => `<span class="tag" style="background:var(--panel); border-color:var(--primary); color:var(--primary);" onclick="insertShortcut('${s.text}')">${s.keyword}</span>`).join(''); }
        async function addShortcut() { const k = document.getElementById('short-key').value; const t = document.getElementById('short-text').value; if(!k || !t) return; await fetch('/api/shortcuts/add', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ keyword: k, text: t }) }); loadAllConfig(); document.getElementById('short-key').value = ""; document.getElementById('short-text').value = ""; }
        async function deleteShortcut(id) { await fetch('/api/shortcuts/delete', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ id }) }); loadAllConfig(); }
        function insertShortcut(text) { document.getElementById('msg-input').value += text; }
        
        async function refreshLeads() { 
            const res = await fetch('/api/data/leads'); 
            const leads = await res.json(); 
            
            document.getElementById('leads-body').innerHTML = leads.map(l => {
                const execName = executivesMap[l.etiqueta] || l.etiqueta || 'Pendiente';
                return `<tr data-exec-id="${l.etiqueta || 'Pendiente'}">
                    <td>${new Date(l.fecha).toLocaleDateString()}</td>
                    <td><span class="lead-source-tag ${l.source==='Web'?'lead-source-web':(l.source==='Tienda Virtual'?'lead-source-store':'')}">${l.source||'Org치nico'}</span></td>
                    <td style="font-weight:600; color:var(--text);">${l.nombre||'-'}</td>
                    <td>${l.phone}</td>
                    <td>${l.ciudad||'-'}</td>
                    <td>${l.departamento||'-'}</td>
                    <td>${l.correo||'-'}</td>
                    <td><strong>${l.interes||'-'}</strong></td>
                    <td style="color:var(--primary);">${execName}</td>
                    <td><span class="tag" style="background:var(--panel); color:var(--text); border-color:var(--border);">${l.status_tag||'-'}</span></td>
                    <td>
                        <button class="nav-btn" style="height:30px; margin-right:5px; border:1px solid var(--border);" onclick="viewLeadDetails('${l.phone}')" title="Ver toda la info del Lead"><i class="fas fa-eye"></i></button>
                        <button class="nav-btn" style="height:30px; border:1px solid var(--border);" onclick="openChat('${l.phone}', '${l.nombre}', '')" title="Ir al Chat"><i class="fas fa-comment"></i></button>
                    </td>
                </tr>`;
            }).join(''); 
        }

        async function loadInventoryPreview() {
            const list = document.getElementById('inventory-list');
            const countLabel = document.getElementById('inventory-count');
            try {
                const res = await fetch('/api/data/knowledge');
                currentInventory = await res.json();
                countLabel.innerText = `${currentInventory.length} items registrados`;
                if(currentInventory.length === 0) {
                    list.innerHTML = '<li style="text-align:center; color:var(--text-muted); padding:15px; font-size:0.9rem;"><i class="fas fa-box-open fa-2x" style="margin-bottom:10px; color:var(--border);"></i><br>No hay inventario cargado.</li>';
                    return;
                }
                list.innerHTML = currentInventory.map(item => {
                    let display = "Producto desconocido";
                    try {
                        const obj = JSON.parse(item.raw_data);
                        const nombre = obj.nombre || obj.name || obj.producto || "Sin Nombre";
                        const precio = obj.precio || obj.price || "";
                        display = `<b style="color:var(--text);">${nombre}</b> <span style="color:var(--primary); font-weight:600;">${precio ? `($${precio})` : ''}</span>`;
                    } catch(e) { display = item.searchable.substring(0, 30) + "..."; }
                    
                    return `<li class="config-item" style="font-size:0.9rem;">
                        <span style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:65%;">${display}</span>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-small btn-blue" onclick="openEditModal(${item.id})"><i class="fas fa-pencil-alt"></i></button>
                            <button class="btn-small btn-red" onclick="deleteInventoryItem(${item.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </li>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        function openEditModal(id) {
            const item = currentInventory.find(i => i.id === id);
            if(!item) return;
            try {
                const data = JSON.parse(item.raw_data);
                document.getElementById('edit-id').value = id;
                document.getElementById('edit-nombre').value = data.nombre || data.name || data.producto || "";
                document.getElementById('edit-precio').value = data.precio || data.price || "";
                document.getElementById('edit-stock').value = data.stock || data.cantidad || "";
                document.getElementById('edit-desc').value = data.descripcion || data.desc || "";
                document.getElementById('edit-modal').classList.add('show');
            } catch(e) { alert("Error al leer datos del producto."); }
        }

        async function saveEditInventory() {
            const id = document.getElementById('edit-id').value;
            const newData = {
                nombre: document.getElementById('edit-nombre').value,
                precio: document.getElementById('edit-precio').value,
                stock: document.getElementById('edit-stock').value,
                descripcion: document.getElementById('edit-desc').value
            };
            await fetch('/api/knowledge/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, data: newData })
            });
            closeModal('edit-modal');
            showToast("Producto actualizado exitosamente");
            loadInventoryPreview();
        }

        async function deleteInventoryItem(id) {
            if(!confirm("쮹orrar este producto definitivamente?")) return;
            await fetch('/api/knowledge/delete', { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify({ id }) 
            });
            loadInventoryPreview();
        }
    </script>
</body>
</html>
