<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ICC | Valentina Suite v22.15 (WhatsApp Edition)</title>
    
    <link rel="icon" href="https://github.com/juanballen2/CHATBOT/blob/main/images/favicon.jpg?raw=true">
    
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* =========================================
           1. ESTILO VISUAL (WHATSAPP WEB)
           ========================================= */
        :root {
            /* Paleta de Colores Oficial */
            --wa-teal: #00a884;
            --wa-bg-app: #d1d7db;
            --wa-header: #f0f2f5;
            --wa-list-bg: #ffffff;
            --wa-chat-bg: #efeae2; /* El cl√°sico beige */
            --wa-bubble-out: #d9fdd3; /* Verde enviado */
            --wa-bubble-in: #ffffff;  /* Blanco recibido */
            --wa-text-p: #111b21;
            --wa-text-s: #667781;
            --wa-border: #e9edef;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; font-family: 'Segoe UI', Helvetica, Arial, sans-serif; }
        
        body {
            background-color: var(--wa-bg-app);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            font-size: 14.5px;
            color: var(--wa-text-p);
        }

        /* Contenedor Principal (Ventana Flotante) */
        .app-container {
            width: 100%;
            height: 100%;
            max-width: 1600px; /* Ancho m√°ximo para pantallas ultra-wide */
            background: white;
            display: flex;
            box-shadow: 0 17px 50px 0 rgba(11,20,26,.19);
            position: relative;
            overflow: hidden;
        }

        /* =========================================
           2. BARRA LATERAL (ICONOS)
           ========================================= */
        .nav-sidebar {
            width: 64px;
            background: #f0f2f5;
            border-right: 1px solid #d1d7db;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
            z-index: 100;
            flex-shrink: 0;
        }

        .logo-area {
            width: 48px; height: 48px; margin-bottom: 30px; cursor: pointer;
            background: white; border-radius: 10px; padding: 3px;
        }

        .nav-icon {
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: #54656f; cursor: pointer; margin-bottom: 15px; transition: 0.2s;
        }
        .nav-icon:hover { background: #d9dee0; }
        .nav-icon.active { color: var(--wa-teal); background: #e7fce3; font-weight: bold; }
        .nav-icon i { font-size: 20px; }

        /* =========================================
           3. VISTAS Y PANELES
           ========================================= */
        .main-view {
            flex: 1;
            display: none; /* Oculto por defecto */
            height: 100%;
            background: #fff;
            flex-direction: column;
        }
        .main-view.active { display: flex; } /* Clase para mostrar */

        /* Layout de Chat (3 Columnas: Lista | Chat | Info) */
        .wa-layout { display: flex; width: 100%; height: 100%; }

        /* COLUMNA 1: LISTA DE CHATS */
        .wa-list-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--wa-border);
            background: white;
            flex-shrink: 0;
        }
        .wa-header-bar {
            height: 60px;
            background: var(--wa-header);
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 16px; border-bottom: 1px solid #d1d7db; flex-shrink: 0;
        }
        .wa-search-box { padding: 8px 12px; border-bottom: 1px solid var(--wa-border); background: white; }
        .wa-search-input {
            background: #f0f2f5; border: none; border-radius: 8px; width: 100%;
            padding: 7px 12px 7px 32px; font-size: 14px;
        }
        .wa-chat-list { flex: 1; overflow-y: auto; background: white; }

        /* Item de la Lista */
        .wa-contact {
            display: flex; padding: 12px 15px; cursor: pointer;
            border-bottom: 1px solid #f5f6f6; align-items: center; transition: 0.2s;
        }
        .wa-contact:hover { background: #f5f6f6; }
        .wa-contact.active { background: #f0f2f5; }

        .wa-avatar {
            width: 49px; height: 49px; border-radius: 50%; background: #dfe5e7;
            margin-right: 15px; background-size: cover; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px;
        }
        .wa-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; }
        .wa-row-top { display: flex; justify-content: space-between; margin-bottom: 3px; }
        .wa-name { font-weight: 500; font-size: 16px; color: var(--wa-text-p); }
        .wa-time { font-size: 12px; color: var(--wa-text-s); }
        .wa-preview { font-size: 13px; color: var(--wa-text-s); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .wa-badge { background: #25d366; color: white; font-size: 11px; font-weight: bold; border-radius: 50%; min-width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; margin-left: 6px; }

        /* COLUMNA 2: √ÅREA DE CONVERSACI√ìN */
        .wa-chat-area {
            flex: 1; display: flex; flex-direction: column;
            background-color: var(--wa-chat-bg); position: relative; min-width: 400px;
        }
        .wa-doodle {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            opacity: 0.4; pointer-events: none; z-index: 0;
        }
        
        .wa-messages-container {
            flex: 1; padding: 20px 60px; overflow-y: auto;
            display: flex; flex-direction: column; gap: 2px; z-index: 10;
        }

        /* Burbujas de Mensaje */
        .msg-row { display: flex; flex-direction: column; margin-bottom: 8px; width: 100%; }
        .msg-bubble {
            max-width: 65%; padding: 6px 7px 8px 9px; border-radius: 7.5px;
            position: relative; font-size: 14.2px; line-height: 19px;
            box-shadow: 0 1px 0.5px rgba(11,20,26,.13);
        }
        .msg-in { align-self: flex-start; background: var(--wa-bubble-in); border-top-left-radius: 0; }
        .msg-out { align-self: flex-end; background: var(--wa-bubble-out); border-top-right-radius: 0; }
        
        .msg-meta {
            float: right; margin-left: 7px; margin-top: 4px; font-size: 11px;
            color: rgba(17,27,33,0.5); display: flex; align-items: center; gap: 3px;
        }

        /* Animaci√≥n suave solo para mensajes nuevos */
        @keyframes fadeInMsg { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-anim { animation: fadeInMsg 0.3s ease-out; }

        /* Barra de Input */
        .wa-footer {
            min-height: 62px; background: #f0f2f5; padding: 10px 16px;
            display: flex; align-items: center; gap: 15px; z-index: 10; border-left: 1px solid #d1d7db;
        }
        .wa-input-wrapper { flex: 1; background: white; border-radius: 8px; padding: 9px 12px; }
        .wa-input { width: 100%; border: none; outline: none; font-size: 15px; }

        /* COLUMNA 3: PANEL CRM */
        .wa-info-panel {
            width: 320px; background: white; border-left: 1px solid var(--wa-border);
            display: flex; flex-direction: column; transition: margin-right 0.3s ease;
        }
        .wa-info-panel.hidden { display: none; } /* Ocultar/Mostrar */
        
        .info-header {
            height: 60px; border-bottom: 1px solid #d1d7db; display: flex; align-items: center;
            padding-left: 20px; background: #f0f2f5; color: #54656f; font-weight: 500;
        }
        .info-body { padding: 20px; overflow-y: auto; background: #f0f2f5; height: 100%; }
        .info-card { background: white; padding: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); margin-bottom: 10px; border-radius: 6px; }

        /* =========================================
           4. UTILIDADES Y OTROS PANELES
           ========================================= */
        .dashboard-container { padding: 30px; width: 100%; height: 100%; overflow-y: auto; background: #f0f2f5; }
        
        /* Tablas */
        .wa-table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        .wa-table th { text-align: left; padding: 15px; background: #f0f2f5; border-bottom: 1px solid #d1d7db; color: #54656f; }
        .wa-table td { padding: 15px; border-bottom: 1px solid #e9edef; color: #111b21; }
        
        /* Botones */
        .btn-wa { background: var(--wa-teal); color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-red { background: var(--danger); color: white; padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
        
        /* Scrollable Config */
        .config-scroll { max-height: 250px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; padding: 10px; background: #fafafa; }
        .tag-pill { display: inline-flex; align-items: center; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; color: white; margin-right: 5px; }

        /* Sandbox */
        .sandbox-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; height: 75vh; }
        .terminal { background: #0F172A; color: #0f0; font-family: monospace; padding: 15px; height: 100%; overflow-y: auto; font-size: 12px; border-radius: 6px; }

        /* Modales */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 200; display: none; align-items: center; justify-content: center; }
        .modal { background: white; width: 450px; padding: 30px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        #context-menu { position: absolute; display: none; background: white; border: 1px solid #ddd; box-shadow: 0 5px 15px rgba(0,0,0,0.1); width: 150px; z-index: 300; border-radius: 5px; }
        .cm-item { padding: 10px 15px; cursor: pointer; font-size: 13px; color: #444; } .cm-item:hover { background: #f0f2f5; }
        
        /* Responsivo */
        @media (max-width: 1024px) {
            .wa-info-panel { display: none; position: absolute; right: 0; height: 100%; z-index: 50; box-shadow: -5px 0 15px rgba(0,0,0,0.1); }
            .wa-info-panel.hidden { display: none; } /* Sobrescribe el display flex */
            .wa-info-panel:not(.hidden) { display: flex; }
        }
    </style>
</head>
<body onclick="hideContextMenu()">

    <div id="context-menu">
        <div class="cm-item" onclick="cmAction('pin')"><i class="fas fa-thumbtack"></i> Fijar/Desfijar</div>
        <div class="cm-item" onclick="cmAction('archive')"><i class="fas fa-archive"></i> Archivar</div>
        <div class="cm-item" onclick="cmAction('labels')"><i class="fas fa-tags"></i> Etiquetas</div>
        <div style="height:1px; background:#eee; margin:5px 0;"></div>
        <div class="cm-item" style="color:red;" onclick="cmAction('delete')"><i class="fas fa-trash"></i> Eliminar</div>
    </div>

    <div class="nav-sidebar">
        <div class="logo-area" onclick="nav('config')">
            <img id="sidebar-logo-img" src="https://github.com/juanballen2/CHATBOT/blob/main/images/ICC.png?raw=true" style="width:100%; height:100%; object-fit:contain;">
        </div>
        <div class="nav-icon active" onclick="nav('chat')" title="Chats"><i class="fas fa-comment-alt"></i></div>
        <div class="nav-icon" onclick="nav('leads')" title="Leads"><i class="fas fa-users"></i></div>
        <div class="nav-icon" onclick="nav('dashboard')" title="Dashboard"><i class="fas fa-chart-pie"></i></div>
        <div class="nav-icon" onclick="nav('inventory')" title="Inventario"><i class="fas fa-box-open"></i></div>
        <div class="nav-icon" onclick="nav('config')" title="Configuraci√≥n"><i class="fas fa-cog"></i></div>
        <div class="nav-icon" onclick="nav('sandbox')" title="Pruebas"><i class="fas fa-flask"></i></div>
        <div style="flex:1"></div>
        <div class="nav-icon" onclick="location.href='/logout'" style="color:var(--danger);"><i class="fas fa-sign-out-alt"></i></div>
    </div>

    <div class="main-content">

        <div id="view-chat" class="main-view wa-layout active">
            <div class="wa-list-panel">
                <div class="wa-header-bar">
                    <div style="font-weight:bold; font-size:20px; color:#54656f;">Chats</div>
                    <div style="display:flex; gap:15px; color:#54656f;">
                        <i class="fas fa-comment-medical" title="Nuevo" style="cursor:pointer;" onclick="addContactPrompt()"></i>
                        <i class="fas fa-ellipsis-v"></i>
                    </div>
                </div>
                <div class="wa-search-box">
                    <input id="search" class="wa-search-input" placeholder="Buscar o empezar nuevo chat" oninput="renderChatList()">
                </div>
                <div id="chat-list-box" class="wa-chat-list"></div>
            </div>

            <div class="wa-chat-area">
                <div class="wa-doodle"></div>
                <div class="wa-header-bar" style="border-left:1px solid #d1d7db; position:relative; z-index:20;">
                    <div id="chat-header-content" style="display:none; align-items:center; width:100%;">
                        <div id="header-avatar" class="wa-avatar" style="width:40px; height:40px; margin-right:15px; cursor:pointer;" onclick="toggleCrmPanel()"></div>
                        <div style="flex:1; cursor:pointer;" onclick="toggleCrmPanel()">
                            <div id="active-name" style="font-weight:600; color:#111b21;">Nombre</div>
                            <div id="active-phone" style="font-size:12px; color:#667781;">...</div>
                        </div>
                        <i class="fas fa-search" style="color:#54656f; margin-right:20px;"></i>
                        <i class="fas fa-ellipsis-v" style="color:#54656f; cursor:pointer;" onclick="toggleCrmPanel()"></i>
                    </div>
                </div>

                <div id="msgs-box" class="wa-messages-container">
                    <div class="no-chat-selected" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; text-align:center;">
                        <img src="https://static.whatsapp.net/rsrc.php/v3/y6/r/wa669ae.svg" width="150" style="opacity:0.5; margin-bottom:20px;">
                        <h2 style="font-weight:300; color:#41525d;">WhatsApp Web (ICC)</h2>
                        <p style="color:#667781;">Selecciona un chat para comenzar a gestionar ventas.</p>
                    </div>
                </div>

                <div id="input-bar" class="wa-footer" style="display:none;">
                    <i class="far fa-smile" style="font-size:24px; color:#54656f; margin-right:15px; cursor:pointer;"></i>
                    <i class="fas fa-paperclip" style="font-size:22px; color:#54656f; margin-right:15px; cursor:pointer;" onclick="document.getElementById('file-input').click()"></i>
                    <input type="file" id="file-input" hidden onchange="handleFileUpload(this)">
                    <div class="wa-input-wrapper">
                        <input id="msg-input" class="wa-input" placeholder="Escribe un mensaje" onkeyup="checkQuickReply(this)" onkeypress="if(event.key==='Enter') sendMsg()">
                    </div>
                    <i id="btn-mic" class="fas fa-microphone" style="font-size:22px; color:#54656f; margin-left:15px; cursor:pointer;" onclick="toggleRecord()"></i>
                    <i class="fas fa-paper-plane" style="font-size:22px; color:#54656f; margin-left:15px; cursor:pointer;" onclick="sendMsg()"></i>
                </div>
                <div id="quick-replies" style="position:absolute; bottom:70px; left:20px; background:white; width:300px; box-shadow:0 -5px 20px rgba(0,0,0,0.1); display:none; z-index:50;"></div>
            </div>

            <div id="crm-panel" class="wa-info-panel hidden">
                <div class="info-header"><i class="fas fa-times" style="margin-right:20px; cursor:pointer;" onclick="toggleCrmPanel()"></i> Info. contacto</div>
                <div class="info-body">
                    <div class="info-card" style="text-align:center;">
                        <div id="prof-avatar" class="wa-avatar" style="width:120px; height:120px; margin:0 auto 10px; font-size:40px;"></div>
                        <h2 id="prof-name">Nombre</h2>
                        <p id="prof-phone" style="color:#667781;">...</p>
                        <button id="prof-bot-btn" class="btn-wa" style="width:100%; margin-top:10px; background:#e7fce3; color:#008069;" onclick="toggleBot()">BOT ACTIVO</button>
                    </div>
                    <div class="info-card">
                        <div style="color:#008069; font-weight:bold; margin-bottom:10px;">CRM</div>
                        <p><b>Ciudad:</b> <span id="prof-city">-</span></p>
                        <p><b>Inter√©s:</b> <span id="prof-interest">-</span></p>
                    </div>
                    <div class="info-card">
                        <div style="color:#008069; font-weight:bold; margin-bottom:10px;">ETIQUETAS</div>
                        <div id="prof-tags" style="display:flex; flex-wrap:wrap; gap:5px; margin-bottom:10px;"></div>
                        <button class="btn-wa" style="width:100%; font-size:12px;" onclick="openTagSelector()">+ Etiqueta</button>
                    </div>
                    <div class="info-card" style="color:red; cursor:pointer;" onclick="cmAction('delete')"><i class="fas fa-trash"></i> Eliminar Chat</div>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="main-view page-container">
            <h1>Panel de Control</h1>
            <div class="kpi-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; margin-bottom:30px;">
                <div class="info-card" style="display:flex; align-items:center; gap:15px;">
                    <div class="wa-avatar" style="background:#e7fce3; color:#008069;"><i class="fas fa-users"></i></div>
                    <div><h2 id="kpi-leads" style="margin:0;">0</h2><p>Leads</p></div>
                </div>
                <div class="info-card" style="display:flex; align-items:center; gap:15px;">
                    <div class="wa-avatar" style="background:#e7fce3; color:#008069;"><i class="fas fa-comments"></i></div>
                    <div><h2 id="kpi-chats" style="margin:0;">0</h2><p>Chats</p></div>
                </div>
                <div class="info-card" style="display:flex; align-items:center; gap:15px;">
                    <div class="wa-avatar" style="background:#e7fce3; color:#008069;"><i class="fas fa-cube"></i></div>
                    <div><h2 id="kpi-stock" style="margin:0;">0</h2><p>Stock</p></div>
                </div>
            </div>
            <div class="info-card">
                <h3>√öltimos Leads</h3>
                <table class="wa-table"><thead><tr><th>Nombre</th><th>Ciudad</th><th>Inter√©s</th><th>Fecha</th></tr></thead><tbody id="dash-leads-body"></tbody></table>
            </div>
        </div>

        <div id="view-inventory" class="main-view page-container">
            <h1>Inventario</h1>
            <div style="display:flex; gap:20px; margin-bottom:20px;">
                <input type="file" id="csv-file" style="border:1px solid #ddd; padding:5px;">
                <button class="btn-wa" onclick="uploadCSV()">Cargar CSV</button>
                <button class="btn-red" onclick="limpiarInventario()">Borrar Todo</button>
            </div>
            <div class="info-card" style="flex:1; overflow-y:auto; border:1px solid #eee;">
                <table class="wa-table"><tbody id="inv-body"></tbody></table>
            </div>
        </div>

        <div id="view-config" class="main-view page-container">
            <h1>Configuraci√≥n</h1>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="info-card">
                    <h3>Personalidad</h3>
                    <textarea id="bot-prompt" style="width:100%; height:200px; border:1px solid #ddd; padding:10px;"></textarea>
                    <button class="btn-wa" style="margin-top:10px;" onclick="savePrompt()">Guardar</button>
                </div>
                <div class="info-card">
                    <h3>Automatizaci√≥n</h3>
                    <div style="margin-bottom:10px;">
                        <b>Etiqueta:</b> <input id="new-tag-name" placeholder="Nombre"> <input type="color" id="new-tag-color"> <button class="btn-wa" onclick="addGlobalTag()">+</button>
                    </div>
                    <div id="tags-viewer-list" class="config-scroll" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
                    <div style="margin-top:20px;">
                        <b>Atajo:</b> <input id="new-sc-key" placeholder="/clave"> <input id="new-sc-text" placeholder="Texto"> <button class="btn-wa" onclick="addShortcut()">+</button>
                    </div>
                    <div id="shortcuts-list" class="config-scroll"></div>
                    <div style="margin-top:20px;">
                        <b>Regla:</b> <input id="rule-input" placeholder="Ej: PC200 es Komatsu"> <button class="btn-wa" onclick="addRule()">+</button>
                    </div>
                    <div id="rules-list" class="config-scroll"></div>
                </div>
            </div>
        </div>

        <div id="view-sandbox" class="main-view page-container">
            <h1>Laboratorio</h1>
            <div class="sandbox-grid">
                <div class="info-card" style="display:flex; flex-direction:column;">
                    <h3>Chat</h3>
                    <div id="sand-chat" style="flex:1; background:#efeae2; border:1px solid #ddd; padding:10px; overflow-y:auto; margin-bottom:10px;"></div>
                    <div style="display:flex; gap:10px;"><input id="sand-in" class="wa-input" placeholder="Escribe..." onkeypress="if(event.key==='Enter') runTest()" style="border:1px solid #ddd; padding:10px;"><button class="btn-wa" onclick="runTest()">Enviar</button></div>
                </div>
                <div class="info-card" style="background:#111b21; color:#0f0; display:flex; flex-direction:column;">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:10px;"><h3>Terminal</h3><span onclick="document.getElementById('sand-log').innerHTML=''" style="cursor:pointer; color:#aaa;">Limpiar</span></div>
                    <div id="sand-log" class="terminal"></div>
                </div>
            </div>
        </div>

        <div id="view-leads" class="main-view page-container">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;"><h1>Leads</h1><button class="btn-wa" onclick="downloadLeadsExcel()">Exportar</button></div>
            <div class="info-card" style="padding:0; overflow:hidden;"><div style="overflow-x:auto;"><table class="wa-table"><thead><tr><th>Fecha</th><th>Nombre</th><th>Ciudad</th><th>Inter√©s</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="leads-body"></tbody></table></div></div>
        </div>

    </div>

    <div id="modal-tag-selector" class="modal-overlay" onclick="closeModal('modal-tag-selector')">
        <div class="modal" onclick="event.stopPropagation()"><h3>Etiquetas</h3><div id="tag-selector-list" class="config-scroll"></div></div>
    </div>
    <div id="modal-edit-lead" class="modal-overlay"><div class="modal"><h3>Editar Lead</h3><input id="edit-lead-id" type="hidden"><label>Nombre</label><input id="edit-lead-name" class="wa-input" style="border:1px solid #ddd; margin-bottom:10px;"><label>Ciudad</label><input id="edit-lead-city" class="wa-input" style="border:1px solid #ddd; margin-bottom:10px;"><label>Inter√©s</label><input id="edit-lead-interest" class="wa-input" style="border:1px solid #ddd; margin-bottom:10px;"><label>Correo</label><input id="edit-lead-email" class="wa-input" style="border:1px solid #ddd; margin-bottom:10px;"><label>Estado</label><select id="edit-lead-tag" class="wa-input" style="border:1px solid #ddd; margin-bottom:10px;"><option value="Pendiente">Pendiente</option><option value="Lead">Lead</option><option value="Cotizaci√≥n">Cotizaci√≥n</option><option value="Vendido">Vendido</option></select><div style="text-align:right;"><button class="btn-wa" onclick="saveLeadChanges()">Guardar</button></div></div></div>

    <script>
        let chats=[], selectedId=null, globalTags=[], shortcuts=[], allLeads=[];
        let mediaRecorder, audioChunks=[], isRecording=false;
        let contextMenuChatId = null;

        async function init() {
            await loadGlobalData();
            nav('chat'); // Inicia en el Chat
            setInterval(() => syncLoop(), 2000); 
        }

        function nav(v) {
            document.querySelectorAll('.main-view').forEach(x => x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-icon').forEach(x => x.classList.remove('active'));
            const icons = document.querySelectorAll('.nav-icon');
            const map = {'chat':0, 'leads':1, 'dashboard':2, 'inventory':3, 'config':4, 'sandbox':5};
            if(icons[map[v]]) icons[map[v]].classList.add('active');

            if(v==='chat') syncLoop(true);
            if(v==='leads') loadLeads();
            if(v==='inventory') loadInventory();
            if(v==='dashboard') loadDash();
            if(v==='config') loadGlobalData();
        }

        /* --- CARGA DATOS --- */
        async function loadGlobalData() {
            try {
                const conf = await fetch('/api/data/config').then(r=>r.json());
                if(conf.logo_url) {
                    document.getElementById('sidebar-logo-img').src = conf.logo_url;
                }
                if(conf.biz_profile) {
                    document.getElementById('biz-name').value = conf.biz_profile.name||'';
                    document.getElementById('biz-hours').value = conf.biz_profile.hours||'';
                }
                if(conf.website_data) document.getElementById('biz-web').value = conf.website_data;
                if(conf.tech_rules) renderRules(conf.tech_rules);

                globalTags = await fetch('/api/data/tags').then(r=>r.json()) || [];
                renderGlobalTags();
                shortcuts = await fetch('/api/data/shortcuts').then(r=>r.json()) || [];
                renderShortcuts();
                
                const p = await fetch('/api/config/prompt').then(r=>r.json());
                document.getElementById('bot-prompt').value = p.prompt || "";
            } catch(e){}
        }

        /* --- CHAT ENGINE (ESTABLE) --- */
        async function syncLoop(force=false) {
            try {
                const res = await fetch(`/api/chats-full`);
                const data = await res.json();
                
                data.sort((a,b) => (b.pinned - a.pinned) || (new Date(b.timestamp) - new Date(a.timestamp)));

                if(force || JSON.stringify(data) !== JSON.stringify(chats)) {
                    chats = data;
                    renderChatList();
                }

                if(selectedId) {
                    const current = chats.find(c => c.id === selectedId);
                    if(current) {
                        if(current.unreadCount>0) await fetch(`/api/chat-history/${selectedId}`);
                        renderBotStatus(current.botActive);
                    }
                    const msgs = await fetch(`/api/chat-history/${selectedId}`).then(r=>r.json());
                    renderMsgs(msgs);
                }
            } catch(e){}
        }

        function renderChatList() {
            const list = document.getElementById('chat-list-box');
            const term = document.getElementById('search').value.toLowerCase();
            
            list.innerHTML = chats.filter(c => (c.name||c.id).toLowerCase().includes(term)).map(c => `
                <div class="wa-contact ${c.id===selectedId?'active':''}" onclick="selChat('${c.id}')" oncontextmenu="showContextMenu(event,'${c.id}')">
                    <div class="wa-avatar" style="${c.photoUrl?`background-image:url('${c.photoUrl}')`:''}">${!c.photoUrl?'<i class="fas fa-user"></i>':''}</div>
                    <div class="wa-info">
                        <div class="wa-row-top">
                            <div class="wa-name">${c.name}</div>
                            <div class="wa-time">${new Date(c.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                        </div>
                        <div class="wa-preview">
                            ${c.botActive?'<i class="fas fa-robot" style="color:#00a884; margin-right:5px;"></i>':''}
                            ${c.lastMessage.text}
                            ${c.unreadCount>0?`<div class="wa-badge">${c.unreadCount}</div>`:''}
                            ${c.pinned?'<i class="fas fa-thumbtack" style="font-size:12px; margin-left:5px;"></i>':''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function selChat(id) {
            if(selectedId === id) return;
            selectedId = id;
            
            const c = chats.find(x=>x.id===id);
            if(!c) return;

            document.getElementById('chat-header-content').style.display='flex';
            document.getElementById('msgs-box').innerHTML = ''; // Limpiar solo al cambiar
            document.getElementById('input-bar').style.display='flex';
            
            document.getElementById('active-name').innerText = c.name;
            document.getElementById('active-phone').innerText = id;
            document.getElementById('header-avatar').style.backgroundImage = c.photoUrl?`url('${c.photoUrl}')`:'';
            
            document.getElementById('prof-avatar').style.backgroundImage = c.photoUrl?`url('${c.photoUrl}')`:'';
            document.getElementById('prof-name').innerText = c.name;
            document.getElementById('prof-phone').innerText = id;
            
            fetchLeadInfo(id);
            renderBotStatus(c.botActive);
            renderChatTags(c.labels||[]);

            syncLoop(true);
        }

        // RENDERIZADO INTELIGENTE (SIN PARPADEO)
        function renderMsgs(msgs) {
            const box = document.getElementById('msgs-box');
            if(!msgs || msgs.length === 0) { return; }

            msgs.forEach(m => {
                const divId = `msg-${m.id}`;
                if(document.getElementById(divId)) return; // Si existe, no hacer nada

                const div = document.createElement('div');
                div.id = divId;
                div.className = 'msg-row msg-anim';
                
                const isMe = (m.role==='manual' || m.role==='assistant' || m.role==='bot');
                const cls = isMe ? 'msg-out' : 'msg-in';
                
                div.innerHTML = `
                    <div class="msg-bubble ${cls}">
                        ${formatMedia(m.text)}
                        <div class="msg-meta">
                            ${new Date(m.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}
                            ${isMe ? '<i class="fas fa-check-double" style="color:#53bdeb;"></i>' : ''}
                        </div>
                    </div>
                `;
                box.appendChild(div);
                box.scrollTop = box.scrollHeight;
            });
        }

        function formatMedia(txt) {
            if(txt.includes('MEDIA:IMAGE')) {
                const id = txt.match(/IMAGE:(.*?)\]/)[1];
                return `<img src="/api/media-proxy/${id}" style="max-width:300px; border-radius:8px; cursor:pointer;" onclick="window.open(this.src)">`;
            }
            if(txt.includes('MEDIA:AUDIO')) {
                const id = txt.match(/AUDIO:(.*?)\]/)[1];
                return `<div style="display:flex; align-items:center; gap:10px;"><audio src="/api/media-proxy/${id}" controls></audio></div>`;
            }
            return txt.replace(/\n/g, '<br>');
        }

        /* --- ACTIONS --- */
        async function sendMsg() {
            const m = document.getElementById('msg-input').value;
            if(!m) return;
            document.getElementById('msg-input').value = '';
            // Inyecci√≥n r√°pida
            const box = document.getElementById('msgs-box');
            box.innerHTML += `<div class="msg-row msg-anim"><div class="msg-bubble msg-out">${m}<div class="msg-meta">...</div></div></div>`;
            box.scrollTop = box.scrollHeight;
            await fetch('/api/chat/send', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:selectedId, message:m})});
            syncLoop(true);
        }

        async function handleFileUpload(inp) {
            if(!inp.files[0] || !selectedId) return;
            const f = inp.files[0];
            const type = f.type.includes('image')?'image':(f.type.includes('audio')?'audio':'document');
            const fd = new FormData(); fd.append('file',f); fd.append('phone',selectedId); fd.append('type',type);
            await fetch('/api/chat/upload-send', {method:'POST', body:fd});
            inp.value = ''; syncLoop(true);
        }

        async function toggleRecord() { if(!isRecording){ try{ const s=await navigator.mediaDevices.getUserMedia({audio:true}); mediaRecorder=new MediaRecorder(s); audioChunks=[]; mediaRecorder.ondataavailable=e=>audioChunks.push(e.data); mediaRecorder.onstop=async()=>{ const b=new Blob(audioChunks,{type:'audio/webm'}); const fd=new FormData(); fd.append('file',b,'audio.ogg'); fd.append('phone',selectedId); fd.append('type','audio'); await fetch('/api/chat/upload-send',{method:'POST',body:fd}); document.getElementById('btn-mic').style.color='#54656f'; syncLoop(true); }; mediaRecorder.start(); isRecording=true; document.getElementById('btn-mic').style.color='red'; }catch(e){alert("Mic Error");} }else{ mediaRecorder.stop(); isRecording=false; } }

        /* --- UTILS --- */
        function toggleCrmPanel() { document.getElementById('crm-panel').classList.toggle('hidden'); }
        async function fetchLeadInfo(phone) { try { const leads = await fetch('/api/data/leads').then(r=>r.json()); const l = leads.find(x => x.phone === phone); document.getElementById('prof-city').innerText = l ? l.ciudad : '-'; document.getElementById('prof-interest').innerText = l ? l.interes : '-'; } catch(e){} }
        async function toggleBot() { const c = chats.find(x=>x.id===selectedId); await fetch('/api/chat/toggle-bot', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:selectedId, active:!c.botActive})}); syncLoop(true); }
        function renderBotStatus(active) { const btn = document.getElementById('prof-bot-btn'); btn.innerText = active ? "ü§ñ BOT ACTIVO" : "‚õî BOT PAUSADO"; btn.style.background = active ? "#e7fce3" : "#fee2e2"; btn.style.color = active ? "#008069" : "#ef4444"; }
        function copyToClip(t) { navigator.clipboard.writeText(t); alert("Copiado"); }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function showContextMenu(e, id) { e.preventDefault(); contextMenuChatId=id; const m=document.getElementById('context-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; }
        function hideContextMenu() { document.getElementById('context-menu').style.display='none'; }
        async function cmAction(a) { await fetch('/api/chat/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:contextMenuChatId, action:a, value:true})}); syncLoop(true); }
        function addContactPrompt() { const p=prompt("N√∫mero:"); if(p) fetch('/api/contacts/add',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:p,name:p})}).then(()=>syncLoop(true)); }
        function callUser() { if(selectedId) window.open(`tel:${selectedId}`); }

        /* --- INVENTARIO & CONFIG --- */
        async function loadInventory() { try { const d = await fetch('/api/data/knowledge').then(r=>r.json()); document.getElementById('inv-body').innerHTML = d.map((p,i)=>`<tr><td>${p.searchable}</td><td style="color:red; cursor:pointer;" onclick="deleteProduct(${i})"><i class="fas fa-trash"></i></td></tr>`).join(''); } catch(e){} }
        async function deleteProduct(i) { if(confirm("¬øEliminar?")) await fetch('/api/knowledge/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({index:i})}); loadInventory(); }
        async function limpiarInventario() { if(confirm("¬øBORRAR TODO?")) { await fetch('/api/knowledge/clear', {method:'POST'}); loadInventory(); } }
        async function uploadCSV() { const f = document.getElementById('csv-file').files[0]; if(!f) return; const fd = new FormData(); fd.append('file',f); await fetch('/api/knowledge/csv', {method:'POST', body:fd}); loadInventory(); alert("Cargado"); }
        async function savePrompt() { const p=document.getElementById('bot-prompt').value; await fetch('/api/config/prompt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:p})}); alert("Guardado"); }
        async function saveBizConfig() { const n=document.getElementById('biz-name').value; const h=document.getElementById('biz-hours').value; const w=document.getElementById('biz-web').value; await fetch('/api/config/biz/save',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n,hours:h,website_data:w})}); alert("Guardado"); }
        async function uploadLogo() { const f=document.getElementById('logo-upload').files[0]; if(!f) return; const fd=new FormData(); fd.append('file',f); await fetch('/api/config/logo',{method:'POST',body:fd}); loadGlobalData(); }

        /* --- TAGS & SHORTCUTS & RULES --- */
        function renderGlobalTags() { document.getElementById('tags-viewer-list').innerHTML = globalTags.map(t=>`<span class="tag-pill" style="background:${t.color}; cursor:pointer;" onclick="deleteTag(${t.id})">${t.name}</span>`).join(''); }
        async function addGlobalTag() { const n=document.getElementById('new-tag-name').value; const c=document.getElementById('new-tag-color').value; await fetch('/api/tags/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name:n, color:c})}); loadGlobalData(); }
        async function deleteTag(id) { if(confirm("¬øBorrar?")) { await fetch('/api/tags/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); loadGlobalData(); } }
        function openTagSelector() { const list = document.getElementById('tag-selector-list'); list.innerHTML = globalTags.map(t => `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="toggleChatTag('${t.name}')"><span class="tag-pill" style="background:${t.color}">${t.name}</span></div>`).join(''); document.getElementById('modal-tag-selector').style.display='flex'; }
        async function toggleChatTag(n) { const c=chats.find(x=>x.id===selectedId); let tags=c.labels||[]; if(tags.includes(n)) tags=tags.filter(x=>x!==n); else tags.push(n); await fetch('/api/chat/action', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:selectedId, action:'set_labels', value:tags})}); document.getElementById('modal-tag-selector').style.display='none'; renderChatTags(tags); syncLoop(true); }
        function renderChatTags(tags) { document.getElementById('prof-tags').innerHTML = tags.map(t => `<span class="tag-pill" style="background:${getTagColor(t)}">${t}</span>`).join(''); }
        function getTagColor(n) { const t=globalTags.find(x=>x.name===n); return t?t.color:'#ccc'; }
        function renderShortcuts() { document.getElementById('shortcuts-list').innerHTML = shortcuts.map(s => `<div style="padding:10px; border-bottom:1px solid #eee;"><b>/${s.keyword}</b> <i class="fas fa-trash" style="color:red; cursor:pointer; float:right;" onclick="deleteShortcut(${s.id})"></i></div>`).join(''); }
        async function addShortcut() { const k=document.getElementById('new-sc-key').value; const t=document.getElementById('new-sc-text').value; await fetch('/api/shortcuts/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({keyword:k, text:t})}); loadGlobalData(); }
        async function deleteShortcut(id) { if(confirm("¬øBorrar?")) { await fetch('/api/shortcuts/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); loadGlobalData(); } }
        function renderRules(rules) { document.getElementById('rules-list').innerHTML = rules.map((r, i) => `<div style="padding:10px; border-bottom:1px solid #eee;"><span>${r}</span><i class="fas fa-trash" style="color:red; cursor:pointer; float:right;" onclick="deleteRule(${i})"></i></div>`).join(''); }
        async function addRule() { const r=document.getElementById('rule-input').value; await fetch('/api/config/rules/add', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({rule:r})}); loadGlobalData(); }
        async function deleteRule(i) { if(confirm("¬øBorrar?")) { await fetch('/api/config/rules/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({index:i})}); loadGlobalData(); } }

        function checkQuickReply(input) { const v = input.value; const p = document.getElementById('quick-replies'); if(v.startsWith('/')) { const k = v.substring(1).toLowerCase(); const m = shortcuts.filter(s=>s.keyword.toLowerCase().includes(k)); if(m.length) { p.innerHTML = m.map(s=>`<div style="padding:10px; cursor:pointer; border-bottom:1px solid #eee;" onclick="useQR('${s.text}')"><b>/${s.keyword}</b>: ${s.text}</div>`).join(''); p.style.display='block'; } else p.style.display='none'; } else p.style.display='none'; }
        function useQR(t) { document.getElementById('msg-input').value=t; document.getElementById('quick-replies').style.display='none'; }

        /* --- DASHBOARD --- */
        async function loadDash() { const [l,c,s] = await Promise.all([ fetch('/api/data/leads').then(r=>r.json()), fetch('/api/chats-full').then(r=>r.json()), fetch('/api/data/knowledge').then(r=>r.json()) ]); document.getElementById('kpi-leads').innerText = l.length; document.getElementById('kpi-chats').innerText = c.length; document.getElementById('kpi-stock').innerText = s.length; document.getElementById('dash-leads-body').innerHTML = l.slice(0,5).map(x=>`<tr><td>${x.nombre}</td><td>${x.ciudad}</td><td>${x.interes}</td><td>${x.fecha.split(',')[0]}</td></tr>`).join(''); }
        async function loadLeads() { try { allLeads = await fetch('/api/data/leads').then(r=>r.json()); document.getElementById('leads-body').innerHTML = allLeads.map(l=>`<tr><td>${l.fecha.split(',')[0]}</td><td>${l.nombre}</td><td>${l.ciudad}</td><td>${l.interes}</td><td><span class="tag-pill" style="background:${getLeadColor(l.etiqueta)}">${l.etiqueta}</span></td><td><button class="btn-red" onclick="openEditLead(${l.id})"><i class="fas fa-edit"></i></button><button class="btn-red" onclick="deleteLead(${l.id})"><i class="fas fa-trash"></i></button></td></tr>`).join(''); } catch(e){} }
        function getLeadColor(s) { return s==='Vendido'?'#10B981':(s==='Lead'?'#3B82F6':(s==='Cotizaci√≥n'?'#F59E0B':'#667781')); }
        function openEditLead(id) { const l = allLeads.find(x=>x.id===id); if(!l)return; document.getElementById('edit-lead-id').value=id; document.getElementById('edit-lead-name').value=l.nombre; document.getElementById('edit-lead-city').value=l.ciudad; document.getElementById('edit-lead-interest').value=l.interes; document.getElementById('edit-lead-email').value=l.correo; document.getElementById('edit-lead-tag').value=l.etiqueta; document.getElementById('modal-edit-lead').style.display='flex'; }
        async function saveLeadChanges() { const id = document.getElementById('edit-lead-id').value; const fields = ['nombre','ciudad','interes','correo','etiqueta']; for(const f of fields) { const val = document.getElementById('edit-lead-'+(f==='etiqueta'?'tag':f)).value; await fetch('/api/leads/update', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, field:f, value:val})}); } closeModal('modal-edit-lead'); loadLeads(); }
        async function deleteLead(id) { if(confirm("¬øBorrar?")) { await fetch('/api/leads/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})}); loadLeads(); } }
        async function downloadLeadsExcel() { try { const r=await fetch('/api/data/leads').then(x=>x.json()); const ws=XLSX.utils.json_to_sheet(r); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Leads"); XLSX.writeFile(wb,"Leads.xlsx"); }catch(e){alert("Error");} }

        /* --- SANDBOX --- */
        async function runTest() { const i = document.getElementById('sand-in'); const b = document.getElementById('sand-chat'); const l = document.getElementById('sand-log'); const m = i.value; if(!m) return; b.innerHTML += `<div style="text-align:right; margin-bottom:10px;"><span style="background:#d9fdd3; padding:8px 12px; border-radius:8px;">${m}</span></div>`; i.value=''; l.innerHTML += `<div>> ${m}</div>`; const r = await fetch('/api/test-ai', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({message:m})}).then(x=>x.json()); b.innerHTML += `<div style="text-align:left; margin-bottom:10px;"><span style="background:white; padding:8px 12px; border-radius:8px;">${r.response}</span></div>`; l.innerHTML += `<div style="color:#0f0;">${JSON.stringify(r)}</div>`; }

        window.onload = init;
    </script>
</body>
</html>
