<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICC | Panel de Control v4.5</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --naranja: #FF8C00;
            --dark-side: #202c33;
            --bg-gray: #f0f2f5;
            --chat-bg: #efe7dd;
            --green-wa: #25d366;
            --white: #ffffff;
            --border: #e0e0e0;
        }

        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg-gray); display: flex; height: 100vh; overflow: hidden; }
        
        /* --- NAVEGACI√ìN LATERAL --- */
        .nav-bar { width: 60px; background: var(--dark-side); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 200; box-shadow: 2px 0 5px rgba(0,0,0,0.2); }
        .nav-btn { color: #aebac1; font-size: 20px; margin-bottom: 30px; cursor: pointer; transition: 0.2s; position: relative; width: 100%; text-align: center; padding: 10px 0; }
        .nav-btn:hover, .nav-btn.active { color: var(--naranja); background: rgba(255,255,255,0.05); border-left: 3px solid var(--naranja); }
        .nav-tooltip { display: none; position: absolute; left: 60px; top: 15px; background: #000; color: #fff; padding: 4px 8px; font-size: 10px; border-radius: 4px; white-space: nowrap; z-index: 300; }
        .nav-btn:hover .nav-tooltip { display: block; }

        /* --- CONTENEDOR VISTAS --- */
        .app-container { flex: 1; display: flex; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; height: 100%; animation: fadeIn 0.3s; flex-direction: column; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- ESTILOS GENERALES P√ÅGINAS --- */
        .page-content { padding: 30px; overflow-y: auto; height: 100%; box-sizing: border-box; }
        h1 { margin-top: 0; color: #333; font-size: 22px; border-bottom: 2px solid var(--naranja); display: inline-block; padding-bottom: 5px; margin-bottom: 20px; }
        
        .card { background: var(--white); padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid var(--border); }
        .card h3 { margin-top: 0; font-size: 14px; color: #555; text-transform: uppercase; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--naranja); color: white; }
        .btn-primary:hover { background: #e67e00; }
        .btn-secondary { background: #54656f; color: white; }
        .btn-danger { background: #ef5350; color: white; }

        /* --- VISTA CHAT WHATSAPP --- */
        .chat-layout { display: flex; height: 100%; }
        .chat-sidebar { width: 350px; background: var(--white); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .chat-header-side { height: 60px; background: #f0f2f5; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #d1d7db; }
        .chat-list-box { flex: 1; overflow-y: auto; }
        
        .chat-item { display: flex; padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f0f0f0; transition: 0.2s; position: relative; }
        .chat-item:hover { background: #f5f5f5; }
        .chat-item.active { background: #e9edef; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #dfe5e7; display: flex; align-items: center; justify-content: center; color: #fff; font-size: 20px; margin-right: 10px; }
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-weight: 600; font-size: 14px; color: #111b21; display: flex; justify-content: space-between; }
        .chat-msg { font-size: 12px; color: #667781; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 3px; }
        
        .chat-main { flex: 1; display: flex; flex-direction: column; background: var(--chat-bg); position: relative; }
        .chat-bg-pattern { position: absolute; inset: 0; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); opacity: 0.4; pointer-events: none; }
        
        .chat-header-main { height: 60px; background: #f0f2f5; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; z-index: 10; border-bottom: 1px solid #d1d7db; }
        .messages-container { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; z-index: 5; }
        
        .bubble { max-width: 70%; padding: 8px 12px; border-radius: 7px; font-size: 14px; line-height: 19px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .bubble-in { align-self: flex-start; background: var(--white); border-top-left-radius: 0; }
        .bubble-out { align-self: flex-end; background: #d9fdd3; border-top-right-radius: 0; }
        .bubble-manual { align-self: flex-end; background: #e3f2fd; border: 1px dashed #2196f3; border-top-right-radius: 0; }
        
        .chat-input-bar { min-height: 60px; background: #f0f2f5; padding: 10px 15px; display: flex; align-items: center; gap: 10px; z-index: 10; }
        .chat-input { flex: 1; padding: 12px; border-radius: 8px; border: none; outline: none; font-size: 14px; }

        /* --- MEN√ö CONTEXTUAL --- */
        #context-menu { display: none; position: absolute; z-index: 1000; background: var(--white); width: 180px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 5px; padding: 5px 0; }
        .ctx-option { padding: 10px 15px; font-size: 13px; color: #333; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .ctx-option:hover { background: #f5f5f5; }
        .ctx-red { color: #d32f2f; }

        /* --- TABLAS E INVENTARIO --- */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; background: #f8f9fa; color: #555; font-weight: 600; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #fafafa; }

        /* --- LOGICA IA (SANDBOX) --- */
        .log-box { background: #2d3436; color: #00cec9; font-family: 'Courier New', monospace; padding: 15px; border-radius: 5px; font-size: 12px; height: 150px; overflow-y: auto; margin-top: 10px; white-space: pre-wrap; border: 1px solid #333; }
    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="nav-btn active" onclick="nav('chat', this)"><i class="fas fa-comments"></i><span class="nav-tooltip">Chat WhatsApp</span></div>
        <div class="nav-btn" onclick="nav('dashboard', this)"><i class="fas fa-chart-pie"></i><span class="nav-tooltip">Dashboard</span></div>
        <div class="nav-btn" onclick="nav('leads', this)"><i class="fas fa-address-book"></i><span class="nav-tooltip">Base Leads</span></div>
        <div class="nav-btn" onclick="nav('config', this)"><i class="fas fa-cogs"></i><span class="nav-tooltip">Configurar IA</span></div>
        <div class="nav-btn" onclick="nav('sandbox', this)"><i class="fas fa-vial"></i><span class="nav-tooltip">Pruebas / Sandbox</span></div>
        <div class="nav-btn" onclick="nav('inventory', this)"><i class="fas fa-boxes"></i><span class="nav-tooltip">Inventario</span></div>
        <div style="flex:1"></div>
        <div class="nav-btn" onclick="location.href='/logout'" style="color: #ef5350;"><i class="fas fa-power-off"></i></div>
    </div>

    <div class="app-container">

        <div id="view-chat" class="view active">
            <div class="chat-layout">
                <div class="chat-sidebar">
                    <div class="chat-header-side">
                        <span style="font-weight:bold; color:#54656f;">Chats Recientes</span>
                        <div style="font-size:12px; color:#aaa;" id="status-conn">‚óè Conectado</div>
                    </div>
                    <div style="padding:10px; background:#fff;">
                        <input type="text" id="search-chat" placeholder="üîç Buscar chat..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:5px;" oninput="renderChatList()">
                    </div>
                    <div class="chat-list-box" id="chat-list-container">
                        </div>
                </div>

                <div class="chat-main">
                    <div class="chat-bg-pattern"></div>
                    <div class="chat-header-main" id="chat-top-bar" style="visibility:hidden;">
                        <div style="display:flex; align-items:center;">
                            <div class="avatar" style="background:var(--naranja); margin-right:10px;"><i class="fas fa-user"></i></div>
                            <div>
                                <div style="font-weight:bold;" id="active-phone-display">Selecciona un chat</div>
                                <div style="font-size:11px; color:#666;">ICC Cliente</div>
                            </div>
                        </div>
                        <div style="display:flex; gap:15px;">
                            <button id="btn-bot-toggle" class="btn btn-secondary" onclick="toggleBot()" style="font-size:11px; padding:5px 10px;">IA: ...</button>
                        </div>
                    </div>

                    <div class="messages-container" id="msgs-box">
                        <div style="text-align:center; margin-top:150px; opacity:0.5;">
                            <i class="fab fa-whatsapp" style="font-size:60px; color:#ccc;"></i>
                            <h3>ICC Chat Center</h3>
                            <p>Selecciona una conversaci√≥n para comenzar.</p>
                        </div>
                    </div>

                    <div class="chat-input-bar" id="input-bar" style="display:none;">
                        <i class="far fa-smile" style="font-size:20px; color:#888; cursor:pointer;" onclick="alert('Emojis pronto...')"></i>
                        <i class="fas fa-paperclip" style="font-size:20px; color:#888; cursor:pointer; margin:0 10px;" onclick="sendMediaPrompt()"></i>
                        <input type="text" class="chat-input" id="msg-input" placeholder="Escribe un mensaje..." onkeypress="if(event.key==='Enter') sendManualMsg()">
                        <i class="fas fa-microphone" style="font-size:20px; color:#888; cursor:pointer; margin-left:10px;" onclick="alert('Audio pronto...')"></i>
                        <button class="btn btn-primary" onclick="sendManualMsg()" style="padding:10px 15px; margin-left:10px;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view page-content">
            <h1>Dashboard Comercial</h1>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px;">
                <div class="card">
                    <h3>Leads Capturados</h3>
                    <h1 style="color:var(--naranja); font-size:40px; margin:10px 0;" id="kpi-leads">0</h1>
                    <small>Clientes potenciales</small>
                </div>
                <div class="card">
                    <h3>Inventario</h3>
                    <h1 style="color:#2980b9; font-size:40px; margin:10px 0;" id="kpi-stock">0</h1>
                    <small>Referencias activas</small>
                </div>
                <div class="card">
                    <h3>Chats Activos</h3>
                    <h1 style="color:var(--green-wa); font-size:40px; margin:10px 0;" id="kpi-chats">0</h1>
                    <small>En historial</small>
                </div>
            </div>
        </div>

        <div id="view-leads" class="view page-content">
            <h1>Base de Leads</h1>
            <div class="card">
                <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                    <button class="btn btn-secondary" onclick="exportLeads()"><i class="fas fa-file-excel"></i> Exportar Excel</button>
                </div>
                <table id="leads-table">
                    <thead><tr><th>Fecha</th><th>Nombre</th><th>Tel√©fono</th><th>Inter√©s</th><th>Estado</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="view-config" class="view page-content">
            <h1>Configuraci√≥n del Cerebro (Lorena)</h1>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="card">
                    <h3>Personalidad (Prompt)</h3>
                    <p style="font-size:11px; color:#777;">Define qui√©n es Lorena, su tono de voz y objetivos.</p>
                    <textarea id="cfg-prompt" style="width:100%; height:200px; padding:10px; border:1px solid #ddd; resize:none;"></textarea>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="saveConfig()">Guardar Cambios</button>
                        <button class="btn btn-danger" onclick="document.getElementById('cfg-prompt').value=''">Limpiar</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Reglas de Negocio & Contexto</h3>
                    <p style="font-size:11px; color:#777;">Precios base, pol√≠ticas de env√≠o, horarios.</p>
                    <textarea id="cfg-rules" style="width:100%; height:200px; padding:10px; border:1px solid #ddd; resize:none;"></textarea>
                    <div style="margin-top:10px;">
                         <button class="btn btn-primary" onclick="saveConfig()">Actualizar Reglas</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-sandbox" class="view page-content">
            <h1>Laboratorio de Pruebas IA</h1>
            <div class="card">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="sandbox-input" placeholder="Escribe algo para probar a Lorena (ej: Hola, precio de filtro...)" style="flex:1; padding:12px; border:1px solid #ccc; border-radius:5px;">
                    <button class="btn btn-primary" onclick="runTest()">ENVIAR PRUEBA</button>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                    <div>
                        <h3>Respuesta de Lorena:</h3>
                        <div id="sandbox-response" style="background:#f9f9f9; padding:15px; border-radius:5px; min-height:100px; border:1px solid #eee;">Esperando prueba...</div>
                    </div>
                    <div>
                        <h3>L√≥gica Interna (Log):</h3>
                        <div id="sandbox-log" class="log-box">Aqu√≠ ver√°s el prompt oculto que se env√≠a a Gemini...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-inventory" class="view page-content">
            <h1>Gesti√≥n de Inventario</h1>
            <div class="card">
                <h3>Subir Productos Masivos (CSV)</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="file" id="csv-file">
                    <button class="btn btn-primary" onclick="uploadCSV()">Cargar Inventario</button>
                </div>
            </div>
            <div class="card">
                <h3>Productos en Base de Datos</h3>
                <div style="max-height:400px; overflow-y:auto;">
                    <table id="inventory-table">
                        <thead><tr><th>Descripci√≥n / B√∫squeda</th><th>Acci√≥n</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div> <div id="context-menu">
        <div class="ctx-option" onclick="ctxAction('pin')"><i class="fas fa-thumbtack"></i> Fijar / Desfijar</div>
        <div class="ctx-option" onclick="ctxAction('mute')"><i class="fas fa-volume-mute"></i> Silenciar</div>
        <div class="ctx-option" onclick="ctxAction('lead')"><i class="fas fa-fire" style="color:orange;"></i> Marcar Lead Hot</div>
        <div class="ctx-option" onclick="ctxAction('done')"><i class="fas fa-check-circle" style="color:green;"></i> Finalizar Pedido</div>
        <div style="height:1px; background:#eee; margin:5px 0;"></div>
        <div class="ctx-option ctx-red" onclick="ctxAction('delete')"><i class="fas fa-trash-alt"></i> Eliminar Chat</div>
    </div>

    <script>
        let currentChats = [];
        let selectedChatId = null;
        let contextTarget = null;
        let pollTimer = null;

        // --- NAVEGACI√ìN ---
        function nav(viewId, btn) {
            // Ocultar todas las vistas
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            // Mostrar la seleccionada
            document.getElementById('view-' + viewId).classList.add('active');
            
            // Actualizar botones men√∫
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            // L√≥gica espec√≠fica por vista
            if(pollTimer) clearInterval(pollTimer);
            
            if(viewId === 'chat') {
                syncChats();
                pollTimer = setInterval(syncChats, 3000);
            } else if(viewId === 'config') {
                loadConfigData(); // ¬°IMPORTANTE: CARGAR DATOS GUARDADOS!
            } else if(viewId === 'dashboard') {
                loadDashboardData();
            } else if(viewId === 'leads') {
                loadLeadsData();
            } else if(viewId === 'inventory') {
                loadInventoryData();
            }
        }

        // --- 1. L√ìGICA CHAT ---
        async function syncChats() {
            try {
                const res = await fetch('/api/chats-full');
                const data = await res.json();
                if(JSON.stringify(data) !== JSON.stringify(currentChats)) {
                    currentChats = data;
                    renderChatList();
                    // Si hay un chat abierto, refrescar mensajes
                    if(selectedChatId) renderMessages(selectedChatId);
                }
            } catch(e) { console.error("Sync error", e); }
        }

        function renderChatList() {
            const container = document.getElementById('chat-list-container');
            const search = document.getElementById('search-chat').value.toLowerCase();
            
            container.innerHTML = currentChats
                .filter(c => c.id.includes(search))
                .map(c => {
                    const activeClass = c.id === selectedChatId ? 'active' : '';
                    let badges = c.pinned ? '<i class="fas fa-thumbtack" style="font-size:10px; color:#888;"></i> ' : '';
                    let muted = c.muted ? '<i class="fas fa-volume-mute" style="font-size:10px; color:#888;"></i> ' : '';
                    let labels = (c.labels||[]).map(l => `<span style="font-size:9px; background:#dcf8c6; padding:2px 4px; border-radius:3px; margin-left:3px;">${l}</span>`).join('');
                    
                    return `
                    <div class="chat-item ${activeClass}" 
                         onclick="selectChat('${c.id}')"
                         oncontextmenu="openContextMenu(event, '${c.id}')">
                        <div class="avatar"><i class="fas fa-user"></i></div>
                        <div class="chat-info">
                            <div class="chat-name">
                                <span>${c.id}</span>
                                <span style="font-size:10px; color:#999;">${new Date(c.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>
                            </div>
                            <div class="chat-msg">
                                ${badges}${muted}${labels} ${(c.lastMessage.text||'').substring(0,30)}...
                            </div>
                        </div>
                    </div>`;
                }).join('');
        }

        function selectChat(id) {
            selectedChatId = id;
            document.getElementById('active-phone-display').innerText = id;
            document.getElementById('chat-top-bar').style.visibility = 'visible';
            document.getElementById('input-bar').style.display = 'flex';
            
            const chat = currentChats.find(c => c.id === id);
            updateBotButton(chat ? chat.botActive : true);
            
            renderMessages(id);
            renderChatList(); // Para marcar activo
        }

        async function renderMessages(id) {
            // Asumiendo que tenemos acceso al history completo via API auxiliar o en memoria
            // Para simplificar, usaremos el endpoint de data raw. 
            // *Nota: En prod, el endpoint /api/chats-full podr√≠a traer los mensajes dentro si no son muchos*
            const res = await fetch('/api/data/history'); 
            const history = await res.json();
            const msgs = history[id] || [];
            
            const box = document.getElementById('msgs-box');
            
            const html = msgs.map(m => {
                let cls = m.role === 'bot' ? 'bubble-out' : (m.role === 'manual' ? 'bubble-manual' : 'bubble-in');
                return `<div class="bubble ${cls}">
                            ${m.text}
                            <div style="text-align:right; font-size:10px; opacity:0.6; margin-top:3px;">${new Date(m.time).toLocaleTimeString()}</div>
                        </div>`;
            }).join('');
            
            if(box.innerHTML !== html) {
                box.innerHTML = html;
                box.scrollTop = box.scrollHeight;
            }
        }

        async function sendManualMsg() {
            const txt = document.getElementById('msg-input').value;
            if(!txt || !selectedChatId) return;
            
            await fetch('/api/chat/send', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ phone: selectedChatId, message: txt })
            });
            document.getElementById('msg-input').value = '';
            syncChats();
        }

        async function sendMediaPrompt() {
            if(!selectedChatId) return;
            const url = prompt("Pegue el link de la imagen/PDF:");
            if(url) {
                let type = url.includes('.pdf') ? 'document' : 'image';
                await fetch('/api/chat/send-media', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ phone: selectedChatId, url: url, type: type })
                });
                alert("Enviado");
            }
        }

        // --- 2. MEN√ö CONTEXTUAL (FIX) ---
        function openContextMenu(e, id) {
            e.preventDefault();
            contextTarget = id;
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            // Ajuste para que no se salga de pantalla
            menu.style.left = Math.min(e.pageX, window.innerWidth - 200) + 'px';
            menu.style.top = e.pageY + 'px';
        }

        document.addEventListener('click', (e) => {
            if(!e.target.closest('#context-menu')) document.getElementById('context-menu').style.display = 'none';
        });

        async function ctxAction(action) {
            if(!contextTarget) return;
            let val = null;
            
            if(action === 'pin') {
                const c = currentChats.find(x => x.id === contextTarget);
                val = !c.pinned;
            } else if(action === 'lead') {
                val = ['Lead Caliente'];
                action = 'label';
            } else if(action === 'done') {
                val = ['Finalizado'];
                action = 'label';
            }

            await fetch('/api/chat/action', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ phone: contextTarget, action: action, value: val })
            });
            
            syncChats(); // Update inmediato
        }

        // --- 3. CONFIGURACI√ìN & SANDBOX ---
        async function loadConfigData() {
            // Esta funci√≥n arregla que los campos aparezcan vac√≠os
            try {
                const res = await fetch('/api/config');
                const data = await res.json();
                document.getElementById('cfg-prompt').value = data.prompt || '';
                document.getElementById('cfg-rules').value = data.tech_rules || '';
            } catch(e) { alert("Error cargando config"); }
        }

        async function saveConfig() {
            await fetch('/api/save-config', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    prompt: document.getElementById('cfg-prompt').value,
                    tech_rules: document.getElementById('cfg-rules').value
                })
            });
            alert("¬°Cerebro actualizado!");
        }

        async function runTest() {
            const msg = document.getElementById('sandbox-input').value;
            const ctx = document.getElementById('cfg-rules').value; // Usar reglas actuales
            
            document.getElementById('sandbox-response').innerText = "Pensando...";
            
            const res = await fetch('/api/test-ai', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ message: msg, context: ctx })
            });
            const data = await res.json();
            
            document.getElementById('sandbox-response').innerText = data.response;
            document.getElementById('sandbox-log').innerText = data.logic_log || "No se recibi√≥ log del servidor (revisar server.js)";
        }

        async function toggleBot() {
            if(!selectedChatId) return;
            const current = currentChats.find(c => c.id === selectedChatId);
            const newState = !current.botActive;
            
            await fetch('/api/chat/toggle-bot', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ phone: selectedChatId, active: newState })
            });
            updateBotButton(newState);
            syncChats();
        }
        
        function updateBotButton(isActive) {
            const btn = document.getElementById('btn-bot-toggle');
            if(isActive) {
                btn.className = "btn btn-primary";
                btn.innerText = "IA: ACTIVA";
            } else {
                btn.className = "btn btn-danger";
                btn.innerText = "IA: PAUSADA";
            }
        }

        // --- 4. DASHBOARD & OTROS ---
        async function loadDashboardData() {
            const [leads, chats, stock] = await Promise.all([
                fetch('/api/data/leads').then(r=>r.json()),
                fetch('/api/chats-full').then(r=>r.json()),
                fetch('/api/data/knowledge').then(r=>r.json())
            ]);
            document.getElementById('kpi-leads').innerText = leads.length;
            document.getElementById('kpi-chats').innerText = chats.length;
            document.getElementById('kpi-stock').innerText = stock.length;
        }

        async function loadLeadsData() {
            const leads = await fetch('/api/data/leads').then(r=>r.json());
            const tbody = document.querySelector('#leads-table tbody');
            tbody.innerHTML = leads.reverse().map(l => `<tr>
                <td>${l.fecha}</td>
                <td>${l.nombre||'-'}</td>
                <td>${l.telefono}</td>
                <td>${l.interes||'-'}</td>
                <td><span style="background:#d4edda; color:#155724; padding:3px 8px; border-radius:10px; font-size:11px;">Capturado</span></td>
            </tr>`).join('');
        }
        
        function exportLeads() {
            const wb = XLSX.utils.table_to_book(document.getElementById('leads-table'), {sheet:"Leads"});
            XLSX.writeFile(wb, "Leads_ICC.xlsx");
        }

        // --- 5. INVENTARIO (FIX CSS) ---
        async function loadInventoryData() {
            const inv = await fetch('/api/data/knowledge').then(r=>r.json());
            const tbody = document.querySelector('#inventory-table tbody');
            tbody.innerHTML = inv.map((item, idx) => `<tr>
                <td>${item.searchable}</td>
                <td><button class="btn btn-danger" style="padding:5px 10px; font-size:11px;" onclick="deleteItem(${idx})">Eliminar</button></td>
            </tr>`).join('');
        }

        async function deleteItem(idx) {
            if(confirm("¬øBorrar?")) {
                await fetch('/api/knowledge/delete', {
                    method:'POST', headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ index: idx })
                });
                loadInventoryData();
            }
        }

        async function uploadCSV() {
            const f = document.getElementById('csv-file').files[0];
            if(!f) return alert("Elige archivo");
            const fd = new FormData(); fd.append('file', f);
            await fetch('/api/knowledge/csv', { method:'POST', body: fd });
            alert("Cargado"); loadInventoryData();
        }

        // Init
        window.onload = () => nav('dashboard'); // Arrancar en Dashboard
    </script>
</body>
</html>
