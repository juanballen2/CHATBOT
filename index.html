<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICC | Dashboard 6.0</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --naranja: #FF8C00; --dark: #202c33; --bg: #f0f2f5; --white: #fff; }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR */
        .nav-bar { width: 60px; background: var(--dark); display: flex; flex-direction: column; align-items: center; padding-top: 20px; z-index: 200; }
        .nav-btn { color: #aebac1; font-size: 20px; margin-bottom: 25px; cursor: pointer; width: 100%; text-align: center; padding: 10px 0; transition: 0.2s; position: relative; }
        .nav-btn:hover, .nav-btn.active { color: var(--naranja); background: rgba(255,255,255,0.05); }
        
        /* APP */
        .app-container { flex: 1; display: flex; }
        .view { display: none; width: 100%; height: 100%; flex-direction: column; animation: fadeIn 0.3s; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page-content { padding: 30px; overflow-y: auto; flex: 1; }

        /* CHAT */
        .chat-sidebar { width: 320px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .chat-header { height: 60px; background: #f0f2f5; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #ddd; }
        .search-row { padding: 10px; border-bottom: 1px solid #eee; display: flex; gap: 5px; }
        .search-input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 20px; outline: none; background: #f0f2f5; }
        
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; padding: 12px; cursor: pointer; border-bottom: 1px solid #f5f5f5; }
        .chat-item:hover { background: #f5f5f5; }
        .chat-item.active { background: #e9edef; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #dfe5e7; display: flex; align-items: center; justify-content: center; margin-right: 10px; color: #fff; font-size: 18px; }

        .chat-main { flex: 1; display: flex; flex-direction: column; background: #efe7dd; position: relative; }
        .chat-bg { position: absolute; inset: 0; opacity: 0.4; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); pointer-events: none; }
        
        .msgs-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; z-index: 5; }
        .bubble { max-width: 70%; padding: 8px 12px; border-radius: 8px; font-size: 14px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; }
        .bubble-in { align-self: flex-start; background: #fff; border-top-left-radius: 0; }
        .bubble-out { align-self: flex-end; background: #d9fdd3; border-top-right-radius: 0; }
        .bubble-manual { align-self: flex-end; background: #e3f2fd; border-top-right-radius: 0; border: 1px dashed #2196f3; }

        .input-bar { min-height: 60px; background: #f0f2f5; padding: 10px; display: flex; gap: 10px; z-index: 10; align-items: center; }
        .input-msg { flex: 1; padding: 12px; border-radius: 8px; border: none; outline: none; background: #fff; }

        /* UTIL */
        .card { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; background: var(--dark); display: inline-flex; align-items: center; gap: 5px; }
        .btn-orange { background: var(--naranja); }
        .recording { animation: pulse 1s infinite; background: red !important; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        #ctx-menu { display: none; position: absolute; background: #fff; width: 160px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1000; border-radius: 5px; }
        .ctx-item { padding: 12px; cursor: pointer; font-size: 13px; }
        .ctx-item:hover { background: #eee; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 10px; border-bottom: 2px solid #eee; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <div class="nav-bar">
        <div class="nav-btn active" onclick="nav('chat')"><i class="fas fa-comments"></i></div>
        <div class="nav-btn" onclick="nav('dashboard')"><i class="fas fa-chart-pie"></i></div>
        <div class="nav-btn" onclick="nav('leads')"><i class="fas fa-address-book"></i></div>
        <div class="nav-btn" onclick="nav('config')"><i class="fas fa-cogs"></i></div>
        <div class="nav-btn" onclick="location.href='/logout'" style="color:#ef5350;"><i class="fas fa-power-off"></i></div>
    </div>

    <div class="app-container">
        
        <div id="view-chat" class="view active">
            <div style="display:flex; height:100%;">
                <div class="chat-sidebar">
                    <div class="chat-header"><b>ICC Chat</b> <span style="font-size:10px; color:green;">‚óè Online</span></div>
                    <div class="search-row">
                        <input id="search" class="search-input" placeholder="Buscar..." oninput="renderChats()">
                        <button class="btn btn-orange" onclick="addContactPrompt()">+</button>
                    </div>
                    <div class="chat-list" id="chat-list-box"></div>
                </div>
                <div class="chat-main">
                    <div class="chat-bg"></div>
                    <div id="chat-top" style="height:60px; background:#f0f2f5; padding:0 20px; display:flex; align-items:center; justify-content:space-between; z-index:10; visibility:hidden; border-bottom:1px solid #ddd;">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="avatar" style="background:var(--naranja);"><i class="fas fa-user"></i></div>
                            <div><div id="active-name" style="font-weight:bold;">Name</div><div id="active-phone" style="font-size:11px; color:#666;">...</div></div>
                        </div>
                        <button id="btn-bot" class="btn" onclick="toggleBot()" style="font-size:11px;">IA</button>
                    </div>
                    <div class="msgs-box" id="msgs-box"></div>
                    
                    <div class="input-bar" id="input-bar" style="display:none;">
                        <input type="file" id="file-input" hidden onchange="handleFileUpload(this)">
                        
                        <button class="btn" style="background:transparent; color:#555;" onclick="document.getElementById('file-input').click()" title="Adjuntar Imagen/PDF">
                            <i class="fas fa-paperclip" style="font-size:20px;"></i>
                        </button>
                        
                        <input type="text" id="msg-input" class="input-msg" placeholder="Mensaje..." onkeypress="if(event.key==='Enter') sendMsg()">
                        
                        <button class="btn btn-orange" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
                        
                        <button id="btn-mic" class="btn" style="border-radius:50%; width:40px; height:40px; justify-content:center;" onclick="toggleRecord()">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-dashboard" class="view page-content">
            <h2>Dashboard</h2>
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px;">
                <div class="card"><h3>Leads</h3><h1 id="kpi-leads" style="color:var(--naranja)">0</h1></div>
                <div class="card"><h3>Chats</h3><h1 id="kpi-chats">0</h1></div>
                <div class="card"><h3>Stock</h3><h1 id="kpi-stock" style="color:#2980b9">0</h1></div>
            </div>
        </div>

        <div id="view-leads" class="view page-content">
            <h2>Leads</h2>
            <div class="card">
                <button class="btn btn-orange" style="float:right; margin-bottom:10px;" onclick="exportExcel()">Excel</button>
                <table id="leads-table">
                    <thead><tr><th>Fecha</th><th>Nombre</th><th>Tel√©fono</th><th>Inter√©s</th></tr></thead>
                    <tbody id="leads-body"></tbody>
                </table>
            </div>
        </div>

        <div id="view-config" class="view page-content">
            <h2>Configuraci√≥n IA</h2>
            <div class="card">
                <h3>Prompt</h3><textarea id="cfg-prompt" style="width:100%; height:100px;"></textarea>
                <br><br><h3>Reglas</h3><textarea id="cfg-rules" style="width:100%; height:100px;"></textarea>
                <br><br><button class="btn btn-orange" onclick="saveConfig()">Guardar</button>
            </div>
        </div>

    </div>

    <div id="ctx-menu">
        <div class="ctx-item" onclick="ctxAction('pin')">üìå Fijar</div>
        <div class="ctx-item" onclick="ctxAction('delete')" style="color:red;">üóëÔ∏è Eliminar</div>
    </div>

    <script>
        let chats=[], selectedId=null, ctxId=null, timer=null;
        let mediaRecorder, audioChunks = [];
        let isRecording = false;

        function nav(v) {
            document.querySelectorAll('.view').forEach(x => x.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            if(v==='chat') document.querySelectorAll('.nav-btn')[0].classList.add('active');
            
            if(timer) clearInterval(timer);
            if(v==='chat') { sync(); timer = setInterval(sync, 3000); }
            if(v==='dashboard') loadDash();
            if(v==='leads') loadLeads();
            if(v==='config') loadCfg();
        }

        async function sync() {
            try {
                const res = await fetch('/api/chats-full');
                const data = await res.json();
                if(JSON.stringify(data) !== JSON.stringify(chats)) {
                    chats = data;
                    renderChats();
                    if(selectedId) renderMsgs(selectedId);
                }
            } catch(e) {}
        }

        function renderChats() {
            const q = document.getElementById('search').value.toLowerCase();
            document.getElementById('chat-list-box').innerHTML = chats.filter(c => (c.name||c.id).toLowerCase().includes(q)).map(c => `
                <div class="chat-item ${c.id===selectedId?'active':''}" onclick="selChat('${c.id}')" oncontextmenu="openCtx(event, '${c.id}')">
                    <div class="avatar" style="background:${c.botActive?'var(--naranja)':'#ccc'}"><i class="fas fa-user"></i></div>
                    <div style="flex:1;">
                        <div style="font-weight:bold; display:flex; justify-content:space-between;">${c.name} <small>${c.pinned?'üìå':''}</small></div>
                        <div style="font-size:12px; color:#666; overflow:hidden; height:15px;">${(c.lastMessage.text||'').substring(0,30)}</div>
                    </div>
                </div>`).join('');
        }

        function selChat(id) {
            selectedId = id;
            const c = chats.find(x=>x.id===id);
            document.getElementById('chat-top').style.visibility='visible';
            document.getElementById('input-bar').style.display='flex';
            document.getElementById('active-name').innerText=c.name;
            document.getElementById('active-phone').innerText=id;
            updateBotBtn(c.botActive);
            renderMsgs(id);
            renderChats();
        }

        async function renderMsgs(id) {
            const h = await fetch('/api/data/history').then(r=>r.json());
            const msgs = h[id] || [];
            document.getElementById('msgs-box').innerHTML = msgs.map(m => `
                <div class="bubble ${m.role==='bot'?'bubble-out':(m.role==='manual'?'bubble-manual':'bubble-in')}">${m.text}</div>
            `).join('');
            document.getElementById('msgs-box').scrollTop = 100000;
        }

        async function sendMsg() {
            const txt = document.getElementById('msg-input').value;
            if(!txt || !selectedId) return;
            await fetch('/api/chat/send', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({phone:selectedId, message:txt})});
            document.getElementById('msg-input').value = '';
            sync();
        }

        // --- SUBIDA DE ARCHIVOS (IMAGEN / PDF) ---
        async function handleFileUpload(input) {
            if (input.files.length === 0 || !selectedId) return;
            const file = input.files[0];
            const formData = new FormData();
            formData.append('file', file);
            formData.append('phone', selectedId);
            formData.append('type', file.type.includes('image') ? 'image' : 'document');

            const btn = document.querySelector('.fa-paperclip').parentElement;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Loading

            try {
                await fetch('/api/chat/upload-send', { method: 'POST', body: formData });
                alert("Archivo enviado");
            } catch (e) { alert("Error enviando archivo"); }
            
            btn.innerHTML = '<i class="fas fa-paperclip" style="font-size:20px;"></i>';
            input.value = ''; // Reset
            sync();
        }

        // --- GRABADORA DE AUDIO ---
        async function toggleRecord() {
            if (!navigator.mediaDevices) return alert("Tu navegador no soporta audio");
            const btn = document.getElementById('btn-mic');

            if (!isRecording) {
                // INICIAR GRABACI√ìN
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
                        const formData = new FormData();
                        formData.append('file', audioBlob, 'audio_nota.ogg');
                        formData.append('phone', selectedId);
                        formData.append('type', 'audio');

                        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                        await fetch('/api/chat/upload-send', { method: 'POST', body: formData });
                        btn.innerHTML = '<i class="fas fa-microphone"></i>';
                        sync();
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                } catch(e) { alert("Permiso de micr√≥fono denegado"); }
            } else {
                // DETENER Y ENVIAR
                mediaRecorder.stop();
                isRecording = false;
                btn.classList.remove('recording');
            }
        }

        // Utilidades
        async function addContactPrompt() {
            const p = prompt("N√∫mero:"); if(!p) return;
            const n = prompt("Nombre:");
            await fetch('/api/contacts/add', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:p,name:n})});
            sync();
        }
        async function toggleBot() {
            const c = chats.find(x=>x.id===selectedId);
            await fetch('/api/chat/toggle-bot', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:selectedId,active:!c.botActive})});
            sync();
        }
        function updateBotBtn(a) { document.getElementById('btn-bot').innerText = a ? "IA: ON" : "IA: OFF"; document.getElementById('btn-bot').style.background = a ? "#202c33":"#d32f2f"; }
        
        async function loadDash() {
            const [l,c,s] = await Promise.all([fetch('/api/data/leads').then(r=>r.json()), fetch('/api/chats-full').then(r=>r.json()), fetch('/api/data/knowledge').then(r=>r.json())]);
            document.getElementById('kpi-leads').innerText=l.length; document.getElementById('kpi-chats').innerText=c.length; document.getElementById('kpi-stock').innerText=s.length;
        }
        async function loadLeads() {
            const l = await fetch('/api/data/leads').then(r=>r.json());
            document.getElementById('leads-body').innerHTML=l.reverse().map(x=>`<tr><td>${x.fecha}</td><td>${x.nombre}</td><td>${x.telefono}</td><td>${x.interes}</td></tr>`).join('');
        }
        function exportExcel() { XLSX.writeFile(XLSX.utils.table_to_book(document.getElementById('leads-table')), "Leads.xlsx"); }
        async function loadCfg() { const d=await fetch('/api/data/config').then(r=>r.json()); document.getElementById('cfg-prompt').value=d.prompt||''; document.getElementById('cfg-rules').value=d.tech_rules||''; }
        async function saveConfig() { await fetch('/api/save-config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({prompt:document.getElementById('cfg-prompt').value,tech_rules:document.getElementById('cfg-rules').value})}); alert("Guardado"); }
        
        function openCtx(e,id) { e.preventDefault(); ctxId=id; const m=document.getElementById('ctx-menu'); m.style.display='block'; m.style.left=e.pageX+'px'; m.style.top=e.pageY+'px'; }
        document.onclick = (e) => { if(!e.target.closest('#ctx-menu')) document.getElementById('ctx-menu').style.display='none'; }
        async function ctxAction(a) { const c=chats.find(x=>x.id===ctxId); await fetch('/api/chat/action', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({phone:ctxId,action:a,value:a==='pin'?!c.pinned:null})}); sync(); }

        window.onload = () => nav('dashboard');
    </script>
</body>
</html>
